"use strict";(self.webpackChunklaravel_workflow=self.webpackChunklaravel_workflow||[]).push([[7911],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>d});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},l=Object.keys(e);for(r=0;r<l.length;r++)a=l[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)a=l[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var s=r.createContext({}),p=function(e){var t=r.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,l=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),c=p(a),h=n,d=c["".concat(s,".").concat(h)]||c[h]||m[h]||l;return a?r.createElement(d,i(i({ref:t},u),{},{components:a})):r.createElement(d,i({ref:t},u))}));function d(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var l=a.length,i=new Array(l);i[0]=h;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[c]="string"==typeof e?e:n,i[1]=o;for(var p=2;p<l;p++)i[p]=a[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,a)}h.displayName="MDXCreateElement"},1576:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>c,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var r=a(7462),n=(a(7294),a(3905));const l={slug:"building-reliable-agentic-loops-with-laravel-workflow-and-prismphp",title:"Building Reliable Agentic Loops with Laravel Workflow and PrismPHP",authors:{name:"Richard",title:"Core Team",url:"https://github.com/rmcdaniel",image_url:"https://github.com/rmcdaniel.png"},tags:["ai","workflow","agents","agentic"]},i=void 0,o={permalink:"/blog/building-reliable-agentic-loops-with-laravel-workflow-and-prismphp",editUrl:"https://github.com/laravel-workflow/laravel-workflow.github.io/edit/main/blog/2025-07-10-building-reliable-agentic-loops-with-laravel-workflow-and-prismphp.md",source:"@site/blog/2025-07-10-building-reliable-agentic-loops-with-laravel-workflow-and-prismphp.md",title:"Building Reliable Agentic Loops with Laravel Workflow and PrismPHP",description:"captionless image",date:"2025-07-10T00:00:00.000Z",formattedDate:"July 10, 2025",tags:[{label:"ai",permalink:"/blog/tags/ai"},{label:"workflow",permalink:"/blog/tags/workflow"},{label:"agents",permalink:"/blog/tags/agents"},{label:"agentic",permalink:"/blog/tags/agentic"}],readingTime:3.32,hasTruncateMarker:!1,authors:[{name:"Richard",title:"Core Team",url:"https://github.com/rmcdaniel",image_url:"https://github.com/rmcdaniel.png",imageURL:"https://github.com/rmcdaniel.png"}],frontMatter:{slug:"building-reliable-agentic-loops-with-laravel-workflow-and-prismphp",title:"Building Reliable Agentic Loops with Laravel Workflow and PrismPHP",authors:{name:"Richard",title:"Core Team",url:"https://github.com/rmcdaniel",image_url:"https://github.com/rmcdaniel.png",imageURL:"https://github.com/rmcdaniel.png"},tags:["ai","workflow","agents","agentic"]},prevItem:{title:"Laravel Workflows as MCP Tools for AI Clients",permalink:"/blog/laravel-workflows-as-mcp-tools-for-ai-clients"},nextItem:{title:"Automating QA with Playwright and Laravel Workflow",permalink:"/blog/automating-qa-with-playwright-and-laravel-workflow"}},s={authorsImageUrls:[void 0]},p=[{value:"What We\u2019re Building",id:"what-were-building",level:3},{value:"Step-by-Step Example",id:"step-by-step-example",level:3},{value:"What Makes This Pattern Powerful",id:"what-makes-this-pattern-powerful",level:3},{value:"Try It Now in Your Browser",id:"try-it-now-in-your-browser",level:3},{value:"Where to Go From Here",id:"where-to-go-from-here",level:3}],u={toc:p};function c(e){let{components:t,...a}=e;return(0,n.kt)("wrapper",(0,r.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,(0,n.kt)("img",{parentName:"p",src:"https://cdn.statically.io/img/prismphp.com/assets/prism-logo.webp",alt:"captionless image"})),(0,n.kt)("p",null,"Laravel Workflow is a powerful tool for orchestrating long-running, stateful workflows in PHP. Paired with ",(0,n.kt)("a",{parentName:"p",href:"https://prismphp.com/"},"PrismPHP"),", it becomes a compelling foundation for building reliable AI agents that not only generate structured data but verify and retry until results meet strict real-world constraints."),(0,n.kt)("p",null,"In this post, we\u2019ll show how to use Laravel Workflow + Prism to create an agentic loop that:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Generates structured data using an LLM"),(0,n.kt)("li",{parentName:"ul"},"Validates the result against custom rules"),(0,n.kt)("li",{parentName:"ul"},"Retries automatically until the result passes")),(0,n.kt)("p",null,"You can try this exact workflow right now in your browser with no setup or coding required. Just click the button in the Laravel Workflow ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/laravel-workflow/sample-app"},"Sample App")," and launch a GitHub Codespace to run it."),(0,n.kt)("h3",{id:"what-were-building"},"What We\u2019re Building"),(0,n.kt)("p",null,"We\u2019ll create a workflow that asks an LLM to generate a user profile with hobbies. Then we\u2019ll validate that:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"The name is present"),(0,n.kt)("li",{parentName:"ul"},"At least one hobby is defined"),(0,n.kt)("li",{parentName:"ul"},"The name starts with a vowel")),(0,n.kt)("p",null,"If the result fails validation, we loop back to the LLM and regenerate. All of this is durable, asynchronous, and tracked through stateful events."),(0,n.kt)("h3",{id:"step-by-step-example"},"Step-by-Step Example"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Console Command to Trigger the Workflow")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-php"},"use App\\Workflows\\Prism\\PrismWorkflow;\nuse Illuminate\\Console\\Command;\nuse Workflow\\WorkflowStub;\n\nclass Prism extends Command\n{\n    protected $signature = 'app:prism';\n\n    protected $description = 'Runs a Prism AI workflow';\n\n    public function handle()\n    {\n        $workflow = WorkflowStub::make(PrismWorkflow::class);\n        $workflow->start();\n        while ($workflow->running());\n        $user = $workflow->output();\n\n        $this->info('Generated User:');\n        $this->info(json_encode($user, JSON_PRETTY_PRINT));\n    }\n}\n")),(0,n.kt)("ol",{start:2},(0,n.kt)("li",{parentName:"ol"},"Define the Workflow Logic")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-php"},"use Workflow\\ActivityStub;\nuse Workflow\\Workflow;\n\nclass PrismWorkflow extends Workflow\n{\n    public function execute()\n    {\n        do {\n            $user = yield ActivityStub::make(GenerateUserActivity::class);\n            $valid = yield ActivityStub::make(ValidateUserActivity::class, $user);\n        } while (!$valid);\n\n        return $user;\n    }\n}\n")),(0,n.kt)("p",null,"This is a classic agent loop. If validation fails, we prompt again automatically."),(0,n.kt)("ol",{start:3},(0,n.kt)("li",{parentName:"ol"},"Generate Structured User Data with PrismPHP")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-php"},"use Prism\\Prism\\Prism;\nuse Prism\\Prism\\Enums\\Provider;\nuse Prism\\Prism\\Schema\\ArraySchema;\nuse Prism\\Prism\\Schema\\ObjectSchema;\nuse Prism\\Prism\\Schema\\StringSchema;\nuse Workflow\\Activity;\n\nclass GenerateUserActivity extends Activity\n{\n    public function execute()\n    {\n        $schema = new ObjectSchema(\n            name: 'user',\n            description: 'A user profile with their hobbies',\n            properties: [\n                new StringSchema('name', 'The user\\'s full name'),\n                new ArraySchema(\n                    name: 'hobbies',\n                    description: 'The user\\'s list of hobbies',\n                    items: new ObjectSchema(\n                        name: 'hobby',\n                        description: 'A detailed hobby entry',\n                        properties: [\n                            new StringSchema('name', 'The name of the hobby'),\n                            new StringSchema('description', 'A brief description of the hobby'),\n                        ],\n                        requiredFields: ['name', 'description']\n                    )\n                ),\n            ],\n            requiredFields: ['name', 'hobbies']\n        );\n\n        $response = Prism::structured()\n            ->using(Provider::OpenAI, 'gpt-4o')\n            ->withSchema($schema)\n            ->withPrompt('Use names from many languages and vary first initials.')\n            ->asStructured();\n\n        return $response->structured;\n    }\n}\n")),(0,n.kt)("ol",{start:4},(0,n.kt)("li",{parentName:"ol"},"Validate Business Logic")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-php"},"use Workflow\\Activity;\n\nclass ValidateUserActivity extends Activity\n{\n    public function execute($user)\n    {\n        if (empty($user['name']) || !is_array($user['hobbies']) || count($user['hobbies']) === 0) {\n            return false;\n        }\n\n        foreach ($user['hobbies'] as $hobby) {\n            if (empty($hobby['name']) || empty($hobby['description'])) {\n                return false;\n            }\n        }\n\n        // Extra Validation: The user's name must start with a vowel.\n        if (!in_array(strtoupper($user['name'][0]), ['A', 'E', 'I', 'O', 'U'])) {\n            return false;\n        }\n\n        return true;  \n    }\n}\n")),(0,n.kt)("h3",{id:"what-makes-this-pattern-powerful"},"What Makes This Pattern Powerful"),(0,n.kt)("p",null,"This design pattern is what you\u2019d call a reliable agentic loop:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"LLM generation via Prism"),(0,n.kt)("li",{parentName:"ul"},"Validation & retry via Laravel Workflow"),(0,n.kt)("li",{parentName:"ul"},"State persistence for crash recovery or inspection"),(0,n.kt)("li",{parentName:"ul"},"Observability via Waterline")),(0,n.kt)("p",null,"It\u2019s perfect for AI applications where accuracy, safety, and traceability are required."),(0,n.kt)("h3",{id:"try-it-now-in-your-browser"},"Try It Now in Your Browser"),(0,n.kt)("p",null,"We\u2019ve bundled this workflow into the official Laravel Workflow ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/laravel-workflow/sample-app"},"Sample App"),", which runs in GitHub Codespaces."),(0,n.kt)("p",null,"To launch it:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Open the sample-app repo"),(0,n.kt)("li",{parentName:"ol"},"Click the \u201cCode\u201d button \u2192 \u201cCodespaces\u201d \u2192 \u201cCreate codespace on main\u201d"),(0,n.kt)("li",{parentName:"ol"},"Wait a few seconds for setup"),(0,n.kt)("li",{parentName:"ol"},"Set your OPENAI_API_KEY"),(0,n.kt)("li",{parentName:"ol"},"Run:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"php artisan migrate\nphp artisan queue:work\n")),(0,n.kt)("ol",{start:6},(0,n.kt)("li",{parentName:"ol"},"In a second terminal:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"php artisan app:prism\n")),(0,n.kt)("p",null,"You will see the queue working and eventually see the validated output."),(0,n.kt)("h3",{id:"where-to-go-from-here"},"Where to Go From Here"),(0,n.kt)("p",null,"You can easily adapt this pattern to:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"AI agents for form filling"),(0,n.kt)("li",{parentName:"ul"},"Data scraping and validation"),(0,n.kt)("li",{parentName:"ul"},"Content generation with retry policies"),(0,n.kt)("li",{parentName:"ul"},"Moderation and review queues")),(0,n.kt)("p",null,"Each step remains reliable and traceable thanks to Laravel Workflow\u2019s durable execution model."))}c.isMDXComponent=!0}}]);