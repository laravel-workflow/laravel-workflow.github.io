"use strict";(self.webpackChunklaravel_workflow=self.webpackChunklaravel_workflow||[]).push([[2884],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>m});var r=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var c=r.createContext({}),l=function(e){var n=r.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},u=function(e){var n=l(e.components);return r.createElement(c.Provider,{value:n},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},f=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,i=e.originalType,c=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=l(t),f=o,m=p["".concat(c,".").concat(f)]||p[f]||d[f]||i;return t?r.createElement(m,a(a({ref:n},u),{},{components:t})):r.createElement(m,a({ref:n},u))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=t.length,a=new Array(i);a[0]=f;var s={};for(var c in n)hasOwnProperty.call(n,c)&&(s[c]=n[c]);s.originalType=e,s[p]="string"==typeof e?e:o,a[1]=s;for(var l=2;l<i;l++)a[l]=t[l];return r.createElement.apply(null,a)}return r.createElement.apply(null,t)}f.displayName="MDXCreateElement"},9599:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var r=t(7462),o=(t(7294),t(3905));const i={sidebar_position:5},a="Microservices",s={unversionedId:"configuration/microservices",id:"configuration/microservices",title:"Microservices",description:"Workflows can span across multiple Laravel applications. For instance, a workflow might exist in one microservice while its corresponding activity resides in another.",source:"@site/docs/configuration/microservices.md",sourceDirName:"configuration",slug:"/configuration/microservices",permalink:"/docs/configuration/microservices",draft:!1,editUrl:"https://github.com/laravel-workflow/laravel-workflow.github.io/edit/main/docs/configuration/microservices.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"Database Connection",permalink:"/docs/configuration/database-connection"},next:{title:"Constraints",permalink:"/docs/category/constraints"}},c={},l=[],u={toc:l};function p(e){let{components:n,...t}=e;return(0,o.kt)("wrapper",(0,r.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"microservices"},"Microservices"),(0,o.kt)("p",null,"Workflows can span across multiple Laravel applications. For instance, a workflow might exist in one microservice while its corresponding activity resides in another."),(0,o.kt)("p",null,"To enable seamless communication between Laravel applications, set up a shared database and queue connection across all microservices."),(0,o.kt)("p",null,"All microservices must have identical ",(0,o.kt)("inlineCode",{parentName:"p"},"APP_KEY")," values in their ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," files for proper serialization and deserialization from the queue."),(0,o.kt)("p",null,"Below is a guide on configuring a shared MySQL database and Redis connection:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"// config/database.php\n\n'connections' => [\n    'shared' => [\n        'driver' => 'mysql',\n        'url' => env('SHARED_DATABASE_URL'),\n        'host' => env('SHARED_DB_HOST', '127.0.0.1'),\n        'port' => env('SHARED_DB_PORT', '3306'),\n        'database' => env('SHARED_DB_DATABASE', 'forge'),\n        'username' => env('SHARED_DB_USERNAME', 'forge'),\n        'password' => env('SHARED_DB_PASSWORD', ''),\n        'unix_socket' => env('SHARED_DB_SOCKET', ''),\n        'charset' => 'utf8mb4',\n        'collation' => 'utf8mb4_unicode_ci',\n        'prefix' => '',\n        'prefix_indexes' => true,\n        'strict' => true,\n        'engine' => null,\n        'options' => extension_loaded('pdo_mysql') ? array_filter([\n            PDO::MYSQL_ATTR_SSL_CA => env('SHARED_MYSQL_ATTR_SSL_CA'),\n        ]) : [],\n    ],\n],\n\n'redis' => [\n    'shared' => [\n        'url' => env('SHARED_REDIS_URL'),\n        'host' => env('SHARED_REDIS_HOST', '127.0.0.1'),\n        'username' => env('SHARED_REDIS_USERNAME'),\n        'password' => env('SHARED_REDIS_PASSWORD'),\n        'port' => env('SHARED_REDIS_PORT', '6379'),\n        'database' => env('SHARED_REDIS_DB', '0'),\n    ],\n],\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"// config/queue.php\n\n'connections' => [\n    'shared' => [\n        'driver' => 'redis',\n        'connection' => 'shared',\n        'queue' => env('SHARED_REDIS_QUEUE', 'default'),\n        'retry_after' => 90,\n        'block_for' => null,\n        'after_commit' => false,\n    ],\n],\n")),(0,o.kt)("p",null,"For consistency in the workflow database schema across services, designate only one microservice to publish and run the Laravel Workflow migrations."),(0,o.kt)("p",null,"Modify the workflow migrations to use the shared database connection:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"// database/migrations/2022_01_01_000000_create_workflows_table.php\n\nfinal class CreateWorkflowsTable extends Migration\n{\n    protected $connection = 'shared';\n")),(0,o.kt)("p",null,"In each microservice, extend the workflow models to use the shared connection:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"// app\\Models\\StoredWorkflow.php\n\nclass StoredWorkflow extends BaseStoredWorkflow\n{\n    protected $connection = 'shared';\n")),(0,o.kt)("p",null,"Publish the Laravel Workflow config file and update it to use your custom models."),(0,o.kt)("p",null,"Update your workflow and activity classes to use the shared queue connection. Assign unique queue names to each microservice for differentiation:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"// App: workflow microservice\n\nuse Workflow\\ActivityStub;\nuse Workflow\\Workflow;\n\nclass MyWorkflow extends Workflow\n{\n    public $connection = 'shared';\n    public $queue = 'workflow';\n\n    public function execute($name)\n    {\n        $result = yield ActivityStub::make(MyActivity::class, $name);\n        return $result;\n    }\n}\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"// App: activity microservice\n\nuse Workflow\\Activity;\n\nclass MyActivity extends Activity\n{\n    public $connection = 'shared';\n    public $queue = 'activity';\n\n    public function execute($name)\n    {\n        return \"Hello, {$name}!\";\n    }\n}\n")),(0,o.kt)("p",null,"It's crucial to maintain empty duplicate classes in every microservice, ensuring they share the same namespace and class name. This precaution avoids potential exceptions due to class discrepancies:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"// App: workflow microservice\n\nuse Workflow\\Activity;\n\nclass MyActivity extends Activity\n{\n    public $connection = 'shared';\n    public $queue = 'activity';\n}\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"// App: activity microservice\n\nuse Workflow\\ActivityStub;\nuse Workflow\\Workflow;\n\nclass MyWorkflow extends Workflow\n{\n    public $connection = 'shared';\n    public $queue = 'workflow';\n}\n")),(0,o.kt)("p",null,"Note: The workflow code should exclusively reside in the workflow microservice, and the activity code should only be found in the activity microservice. The code isn't duplicated; identical class structures are merely maintained across all microservices."),(0,o.kt)("p",null,"To run queue workers in each microservice, use the shared connection and the respective queue names:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"php artisan queue:work shared --queue=workflow\nphp artisan queue:work shared --queue=activity\n")),(0,o.kt)("p",null,"In this setup, the workflow queue worker runs in the workflow microservice, while the activity queue worker runs in the activity microservice."))}p.isMDXComponent=!0}}]);