"use strict";(self.webpackChunklaravel_workflow=self.webpackChunklaravel_workflow||[]).push([[9320],{3905:(e,t,o)=>{o.d(t,{Zo:()=>c,kt:()=>g});var n=o(7294);function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){r(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function l(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var p=n.createContext({}),s=function(e){var t=n.useContext(p),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},c=function(e){var t=s(e.components);return n.createElement(p.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},f=n.forwardRef((function(e,t){var o=e.components,r=e.mdxType,a=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=s(o),f=r,g=m["".concat(p,".").concat(f)]||m[f]||u[f]||a;return o?n.createElement(g,i(i({ref:t},c),{},{components:o})):n.createElement(g,i({ref:t},c))}));function g(e,t){var o=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=o.length,i=new Array(a);i[0]=f;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[m]="string"==typeof e?e:r,i[1]=l;for(var s=2;s<a;s++)i[s]=o[s];return n.createElement.apply(null,i)}return n.createElement.apply(null,o)}f.displayName="MDXCreateElement"},7609:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>m,frontMatter:()=>a,metadata:()=>l,toc:()=>s});var n=o(7462),r=(o(7294),o(3905));const a={slug:"converting-videos-with-ffmpeg",title:"Converting Videos with FFmpeg and Laravel Workflow",authors:{name:"Richard",title:"Core Team",url:"https://github.com/rmcdaniel",image_url:"https://github.com/rmcdaniel.png"},tags:["video","ffmpeg","conversion","transcoding"]},i=void 0,l={permalink:"/blog/converting-videos-with-ffmpeg",editUrl:"https://github.com/laravel-workflow/laravel-workflow.github.io/edit/main/blog/2022-10-31-converting-videos-with-ffmpeg.md",source:"@site/blog/2022-10-31-converting-videos-with-ffmpeg.md",title:"Converting Videos with FFmpeg and Laravel Workflow",description:"FFmpeg is a free, open-source software project allowing you to record, convert and stream audio and video.",date:"2022-10-31T00:00:00.000Z",formattedDate:"October 31, 2022",tags:[{label:"video",permalink:"/blog/tags/video"},{label:"ffmpeg",permalink:"/blog/tags/ffmpeg"},{label:"conversion",permalink:"/blog/tags/conversion"},{label:"transcoding",permalink:"/blog/tags/transcoding"}],readingTime:1.67,hasTruncateMarker:!1,authors:[{name:"Richard",title:"Core Team",url:"https://github.com/rmcdaniel",image_url:"https://github.com/rmcdaniel.png",imageURL:"https://github.com/rmcdaniel.png"}],frontMatter:{slug:"converting-videos-with-ffmpeg",title:"Converting Videos with FFmpeg and Laravel Workflow",authors:{name:"Richard",title:"Core Team",url:"https://github.com/rmcdaniel",image_url:"https://github.com/rmcdaniel.png",imageURL:"https://github.com/rmcdaniel.png"},tags:["video","ffmpeg","conversion","transcoding"]},nextItem:{title:"Email Verifications Using Laravel Workflow",permalink:"/blog/email-verifications"}},p={authorsImageUrls:[void 0]},s=[],c={toc:s};function m(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://ffmpeg.org/"},"FFmpeg")," is a free, open-source software project allowing you to record, convert and stream audio and video."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://laravel.com/docs/9.x/queues"},"Laravel Queues")," are great for long running tasks. Converting video takes a long time! With ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/laravel-workflow/laravel-workflow"},"Laravel Workflow"),", you can harness the power of queues to convert videos in the background and easily manage the process."),(0,r.kt)("h1",{id:"requirements"},"Requirements"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"You\u2019ll need to ",(0,r.kt)("a",{parentName:"li",href:"https://ffmpeg.org/download.html"},"install FFmpeg")),(0,r.kt)("li",{parentName:"ol"},"Then ",(0,r.kt)("inlineCode",{parentName:"li"},"composer require php-ffmpeg/php-ffmpeg")," (",(0,r.kt)("a",{parentName:"li",href:"https://github.com/PHP-FFMpeg/PHP-FFMpeg#readme"},"docs"),")"),(0,r.kt)("li",{parentName:"ol"},"Finally ",(0,r.kt)("inlineCode",{parentName:"li"},"composer require laravel-workflow/laravel-workflow")," (",(0,r.kt)("a",{parentName:"li",href:"https://github.com/laravel-workflow/laravel-workflow#laravel-workflow-"},"docs"),")")),(0,r.kt)("h1",{id:"workflow"},"Workflow"),(0,r.kt)("p",null,"A workflow is an easy way to orchestrate activities. A workflow that converts a video from one format to another might have several activities, such as downloading the video from storage, the actual conversion, and then finally notifying the user that it\u2019s finished."),(0,r.kt)("p",null,"For simplicity, the workflow we are making today will only contain the most interesting activity, converting the video."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"namespace App\\Workflows\\ConvertVideo;\n\nuse Workflow\\ActivityStub;\nuse Workflow\\Workflow;\n\nclass ConvertVideoWorkflow extends Workflow\n{\n    public function execute()\n    {\n        yield ActivityStub::make(\n            ConvertVideoWebmActivity::class,\n            storage_path('app/oceans.mp4'),\n            storage_path('app/oceans.webm'),\n        );\n    }\n}\n")),(0,r.kt)("p",null,"We need a video to convert. We can use this one:"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"http://vjs.zencdn.net/v/oceans.mp4"},"http://vjs.zencdn.net/v/oceans.mp4")),(0,r.kt)("p",null,"Download it and save it to your app storage folder."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"namespace App\\Workflows\\ConvertVideo;\n\nuse FFMpeg\\FFMpeg;\nuse FFMpeg\\Format\\Video\\WebM;\nuse Workflow\\Activity;\n\nclass ConvertVideoWebmActivity extends Activity\n{\n    public $timeout = 5;\n\n    public function execute($input, $output)\n    {\n        $ffmpeg = FFMpeg::create();\n        $video = $ffmpeg->open($input);\n        $format = new WebM();\n        $format->on('progress', fn () => $this->heartbeat());\n        $video->save($format, $output);\n    }\n}\n")),(0,r.kt)("p",null,"The activity converts any input video into a ",(0,r.kt)("a",{parentName:"p",href:"https://www.webmproject.org/"},"WebM")," output video. While ffmpeg is converting the video, a progress callback is triggered which in turn heartbeats the activity."),(0,r.kt)("p",null,"This is necessary because we have set a reasonable timeout of 5 seconds but we also have no idea how long it will take to convert the video. As long as we send a heartbeat at least once every 5 seconds, the activity will not timeout."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://miro.medium.com/max/1400/1*ccrxeOEZYQciDYEprRKWiQ.webp",alt:"heartbeat"})),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://miro.medium.com/max/1400/1*9ZF3LTqjf4qsVcNVX5LK0A.webp",alt:"no heartbeat"})),(0,r.kt)("p",null,"Without a heartbeat, the worker will be killed after the timeout of 5 seconds is reached."),(0,r.kt)("p",null,"To actually run the workflow you just need to call:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"WorkflowStub::make(ConvertVideoWorkflow::class)->start();\n")),(0,r.kt)("p",null,"And that\u2019s it!"))}m.isMDXComponent=!0}}]);