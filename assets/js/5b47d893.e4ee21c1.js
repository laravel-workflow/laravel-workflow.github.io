"use strict";(self.webpackChunklaravel_workflow=self.webpackChunklaravel_workflow||[]).push([[4163],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>p});var o=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,i=function(e,t){if(null==e)return{};var n,o,i={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=o.createContext({}),c=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=c(e.components);return o.createElement(s.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},h=o.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=c(n),h=i,p=d["".concat(s,".").concat(h)]||d[h]||m[h]||a;return n?o.createElement(p,r(r({ref:t},u),{},{components:n})):o.createElement(p,r({ref:t},u))}));function p(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,r=new Array(a);r[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:i,r[1]=l;for(var c=2;c<a;c++)r[c]=n[c];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}h.displayName="MDXCreateElement"},9454:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var o=n(7462),i=(n(7294),n(3905));const a={slug:"microservice-communication-with-laravel-workflow",title:"Microservice Communication with Workflow",authors:{name:"Richard",title:"Core Team",url:"https://github.com/rmcdaniel",image_url:"https://github.com/rmcdaniel.png"},tags:["microservices","workflow","communication","distributed-systems"]},r=void 0,l={permalink:"/blog/microservice-communication-with-laravel-workflow",editUrl:"https://github.com/laravel-workflow/laravel-workflow.github.io/edit/main/blog/2023-08-18-microservice-communication-with-laravel-workflow.md",source:"@site/blog/2023-08-18-microservice-communication-with-laravel-workflow.md",title:"Microservice Communication with Workflow",description:"In the evolving landscape of microservices, communication has always been a focal point. Microservices can interact in various ways, be it through HTTP/REST calls, using messaging protocols like RabbitMQ or Kafka, or even employing more recent technologies like gRPC. Yet, regardless of the communication method, the goal remains the same: seamless, efficient, and robust interactions. Today, we\u2019ll explore how Workflow can fit into this picture and optimize the communication between microservices in a unique way.",date:"2023-08-18T00:00:00.000Z",formattedDate:"August 18, 2023",tags:[{label:"microservices",permalink:"/blog/tags/microservices"},{label:"workflow",permalink:"/blog/tags/workflow"},{label:"communication",permalink:"/blog/tags/communication"},{label:"distributed-systems",permalink:"/blog/tags/distributed-systems"}],readingTime:3.805,hasTruncateMarker:!1,authors:[{name:"Richard",title:"Core Team",url:"https://github.com/rmcdaniel",image_url:"https://github.com/rmcdaniel.png",imageURL:"https://github.com/rmcdaniel.png"}],frontMatter:{slug:"microservice-communication-with-laravel-workflow",title:"Microservice Communication with Workflow",authors:{name:"Richard",title:"Core Team",url:"https://github.com/rmcdaniel",image_url:"https://github.com/rmcdaniel.png",imageURL:"https://github.com/rmcdaniel.png"},tags:["microservices","workflow","communication","distributed-systems"]},prevItem:{title:"AI Image Moderation with Workflow",permalink:"/blog/ai-image-moderation-with-laravel-workflow"},nextItem:{title:"Saga Pattern and Workflow",permalink:"/blog/saga-pattern-and-laravel-workflow"}},s={authorsImageUrls:[void 0]},c=[{value:"The Challenge",id:"the-challenge",level:2},{value:"Workflow to the Rescue!",id:"workflow-to-the-rescue",level:2},{value:"Defining Workflows and Activities",id:"defining-workflows-and-activities",level:3},{value:"1. Create a workflow.",id:"1-create-a-workflow",level:4},{value:"2. Create an activity.",id:"2-create-an-activity",level:4},{value:"3. Run the workflow.",id:"3-run-the-workflow",level:4},{value:"Balancing Shared and Dedicated Resources",id:"balancing-shared-and-dedicated-resources",level:2},{value:"Step-By-Step Integration",id:"step-by-step-integration",level:2},{value:"1. Install <code>laravel-workflow</code> in all microservices.",id:"1-install-laravel-workflow-in-all-microservices",level:4},{value:"2. Create a shared database/redis connection in all microservices.",id:"2-create-a-shared-databaseredis-connection-in-all-microservices",level:4},{value:"3. Configure a shared queue connection.",id:"3-configure-a-shared-queue-connection",level:4},{value:"4. Ensure only one microservice publishes Workflow migrations.",id:"4-ensure-only-one-microservice-publishes-workflow-migrations",level:4},{value:"5. Extend workflow models in each microservice to use the shared connection.",id:"5-extend-workflow-models-in-each-microservice-to-use-the-shared-connection",level:4},{value:"6. Publish Workflow config and update it with shared models.",id:"6-publish-workflow-config-and-update-it-with-shared-models",level:4},{value:"7. Set workflows and activities to use the shared queue.",id:"7-set-workflows-and-activities-to-use-the-shared-queue",level:4},{value:"8. Ensure microservices define empty counterparts for workflow and activity classes.",id:"8-ensure-microservices-define-empty-counterparts-for-workflow-and-activity-classes",level:4},{value:"In the workflow microservice:",id:"in-the-workflow-microservice",level:4},{value:"In the activity microservice:",id:"in-the-activity-microservice",level:4},{value:"9. Ensure all microservices have the same <code>APP_KEY</code> in their <code>.env</code> file.",id:"9-ensure-all-microservices-have-the-same-app_key-in-their-env-file",level:4},{value:"10. Run queue workers in each microservice.",id:"10-run-queue-workers-in-each-microservice",level:4},{value:"Conclusion",id:"conclusion",level:2}],u={toc:c};function d(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"In the evolving landscape of microservices, communication has always been a focal point. Microservices can interact in various ways, be it through HTTP/REST calls, using messaging protocols like RabbitMQ or Kafka, or even employing more recent technologies like gRPC. Yet, regardless of the communication method, the goal remains the same: seamless, efficient, and robust interactions. Today, we\u2019ll explore how Workflow can fit into this picture and optimize the communication between microservices in a unique way."),(0,i.kt)("h2",{id:"the-challenge"},"The Challenge"),(0,i.kt)("p",null,"In a microservices architecture, decoupling is the name of the game. You want each service to have a single responsibility, to be maintainable, and to be independently deployable. Yet, in the world of workflows, this becomes challenging. How do you split a workflow from its activity and yet ensure they communicate seamlessly?"),(0,i.kt)("h2",{id:"workflow-to-the-rescue"},"Workflow to the Rescue!"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/laravel-workflow/laravel-workflow"},"Workflow")," handles the discovery and orchestration for you! With a shared database and queue connection, you can have your workflow in one Laravel app and its activity logic in another."),(0,i.kt)("h3",{id:"defining-workflows-and-activities"},"Defining Workflows and Activities"),(0,i.kt)("h4",{id:"1-create-a-workflow"},"1. Create a workflow."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"use function Workflow\\activity;\nuse Workflow\\Workflow;\n\nclass MyWorkflow extends Workflow\n{\n    public function execute($name)\n    {\n        $result = yield activity(MyActivity::class, $name);\n        return $result;\n    }\n}\n")),(0,i.kt)("h4",{id:"2-create-an-activity"},"2. Create an activity."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},'use Workflow\\Activity;\n\nclass MyActivity extends Activity\n{\n    public function execute($name)\n    {\n        return "Hello, {$name}!";\n    }\n}\n')),(0,i.kt)("h4",{id:"3-run-the-workflow"},"3. Run the workflow."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"use Workflow\\WorkflowStub;\n\n$workflow = WorkflowStub::make(MyWorkflow::class);\n$workflow->start('world');\nwhile ($workflow->running());\n$workflow->output();\n// Output: 'Hello, world!'\n")),(0,i.kt)("p",null,"The workflow will manage the activity and handle any failures, retries, etc. Think of workflows like job chaining on steroids because you can have conditional logic, loops, return a result that can be used in the next activity, and write everything in typical PHP code that is failure tolerant."),(0,i.kt)("h2",{id:"balancing-shared-and-dedicated-resources"},"Balancing Shared and Dedicated Resources"),(0,i.kt)("p",null,"When working with microservices, it\u2019s common for each service to have its dedicated resources, such as databases, caches, and queues. However, to facilitate communication between workflows and activities across services, a shared connection (like a database or queue) becomes essential. This shared connection acts as a bridge for data and task exchanges while ensuring:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Isolation"),": Dedicated resources prevent cascading failures."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Performance"),": Each service can be optimized independently."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Security"),": Isolation limits potential attack vectors.")),(0,i.kt)("h2",{id:"step-by-step-integration"},"Step-By-Step Integration"),(0,i.kt)("h4",{id:"1-install-laravel-workflow-in-all-microservices"},"1. Install ",(0,i.kt)("inlineCode",{parentName:"h4"},"laravel-workflow")," in all microservices."),(0,i.kt)("p",null,"Follow the ",(0,i.kt)("a",{parentName:"p",href:"https://laravel-workflow.com/docs/installation/"},"installation guide"),"."),(0,i.kt)("h4",{id:"2-create-a-shared-databaseredis-connection-in-all-microservices"},"2. Create a shared database/redis connection in all microservices."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"// config/database.php\n'connections' => [\n    'shared' => [\n        'driver' => 'mysql',\n        'host' => env('SHARED_DB_HOST', '127.0.0.1'),\n        'database' => env('SHARED_DB_DATABASE', 'forge'),\n        'username' => env('SHARED_DB_USERNAME', 'forge'),\n        'password' => env('SHARED_DB_PASSWORD', ''),\n    ],\n],\n")),(0,i.kt)("h4",{id:"3-configure-a-shared-queue-connection"},"3. Configure a shared queue connection."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"// config/queue.php\n'connections' => [\n    'shared' => [\n        'driver' => 'redis',\n        'connection' => 'shared',\n        'queue' => env('SHARED_REDIS_QUEUE', 'default'),\n    ],\n],\n")),(0,i.kt)("h4",{id:"4-ensure-only-one-microservice-publishes-workflow-migrations"},"4. Ensure only one microservice publishes Workflow migrations."),(0,i.kt)("p",null,"Update the migration to use the shared database connection."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"// database/migrations/..._create_workflows_table.php\nclass CreateWorkflowsTable extends Migration\n{\n    protected $connection = 'shared';\n}\n")),(0,i.kt)("h4",{id:"5-extend-workflow-models-in-each-microservice-to-use-the-shared-connection"},"5. Extend workflow models in each microservice to use the shared connection."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"// app/Models/StoredWorkflow.php\nnamespace App\\Models;\n\nuse Workflow\\Models\\StoredWorkflow as BaseStoredWorkflow;\n\nclass StoredWorkflow extends BaseStoredWorkflow\n{\n    protected $connection = 'shared';\n}\n")),(0,i.kt)("h4",{id:"6-publish-workflow-config-and-update-it-with-shared-models"},"6. Publish Workflow config and update it with shared models."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},'php artisan vendor:publish --provider="Workflow\\Providers\\WorkflowServiceProvider" --tag="config"\n')),(0,i.kt)("h4",{id:"7-set-workflows-and-activities-to-use-the-shared-queue"},"7. Set workflows and activities to use the shared queue."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"// app/Workflows/MyWorkflow.php\nclass MyWorkflow extends Workflow\n{\n    public $connection = 'shared';\n    public $queue = 'workflow';\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"// app/Workflows/MyActivity.php\nclass MyActivity extends Activity\n{\n    public $connection = 'shared';\n    public $queue = 'activity';\n}\n")),(0,i.kt)("h4",{id:"8-ensure-microservices-define-empty-counterparts-for-workflow-and-activity-classes"},"8. Ensure microservices define empty counterparts for workflow and activity classes."),(0,i.kt)("h4",{id:"in-the-workflow-microservice"},"In the workflow microservice:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"class MyWorkflow extends Workflow\n{\n    public $connection = 'shared';\n    public $queue = 'workflow';\n\n    public function execute($name)\n    {\n        yield activity(MyActivity::class, $name);\n    }\n}\nclass MyActivity extends Activity\n{\n    public $connection = 'shared';\n    public $queue = 'activity';\n}\n")),(0,i.kt)("h4",{id:"in-the-activity-microservice"},"In the activity microservice:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"class MyWorkflow extends Workflow\n{\n    public $connection = 'shared';\n    public $queue = 'workflow';\n}\nclass MyActivity extends Activity\n{\n    public $connection = 'shared';\n    public $queue = 'activity';\n\n    public function execute($name)\n    {\n        return \"Hello, {$name}!\";\n    }\n}\n")),(0,i.kt)("h4",{id:"9-ensure-all-microservices-have-the-same-app_key-in-their-env-file"},"9. Ensure all microservices have the same ",(0,i.kt)("inlineCode",{parentName:"h4"},"APP_KEY")," in their ",(0,i.kt)("inlineCode",{parentName:"h4"},".env")," file."),(0,i.kt)("p",null,"This is crucial for proper job serialization across services."),(0,i.kt)("h4",{id:"10-run-queue-workers-in-each-microservice"},"10. Run queue workers in each microservice."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"php artisan queue:work shared --queue=workflow\nphp artisan queue:work shared --queue=activity\n")),(0,i.kt)("h2",{id:"conclusion"},"Conclusion"),(0,i.kt)("p",null,"By following the steps above, you can ensure seamless interactions between microservices while maintaining modularity and scalability. Workflow takes care of the discovery and orchestration for you. \ud83d\ude80"),(0,i.kt)("p",null,"Thanks for reading!"))}d.isMDXComponent=!0}}]);