<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">3 posts tagged with &quot;agents&quot; | Durable Workflow</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://durable-workflow.com/img/docusaurus.png"><meta data-rh="true" name="twitter:image" content="https://durable-workflow.com/img/docusaurus.png"><meta data-rh="true" property="og:url" content="https://durable-workflow.com/blog/tags/agents/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="3 posts tagged with &quot;agents&quot; | Durable Workflow"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://durable-workflow.com/blog/tags/agents/"><link data-rh="true" rel="alternate" href="https://durable-workflow.com/blog/tags/agents/" hreflang="en"><link data-rh="true" rel="alternate" href="https://durable-workflow.com/blog/tags/agents/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://IYIBF1DKO0-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Durable Workflow RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Durable Workflow Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HD1YHT442Y"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-HD1YHT442Y",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Durable Workflow" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.e0ea9312.css">
<link rel="preload" href="/assets/js/runtime~main.e30081ab.js" as="script">
<link rel="preload" href="/assets/js/main.2e1ed098.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Workflow Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Workflow Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Durable Workflow</b></a><a class="navbar__item navbar__link" href="/docs/installation/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/durable-workflow/workflow" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/building-a-durable-ai-travel-agent-with-laravel/">Building a Durable AI Travel Agent with Laravel</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/laravel-workflows-as-mcp-tools-for-ai-clients/">Workflows as MCP Tools for AI Clients</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/building-reliable-agentic-loops-with-laravel-workflow-and-prismphp/">Building Reliable Agentic Loops with Workflow and PrismPHP</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/automating-qa-with-playwright-and-laravel-workflow/">Automating QA with Playwright and Workflow</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/extending-laravel-workflow-to-support-spatie-laravel-tags/">Extending Workflow to Support Spatie Laravel Tags</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>3 posts tagged with &quot;agents&quot;</h1><a href="/blog/tags/">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/building-a-durable-ai-travel-agent-with-laravel/">Building a Durable AI Travel Agent with Laravel</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2026-02-07T00:00:00.000Z" itemprop="datePublished">February 7, 2026</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/rmcdaniel" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/rmcdaniel.png" alt="Richard"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/rmcdaniel" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Richard</span></a></div><small class="avatar__subtitle" itemprop="description">Core Team</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Look at these execution logs:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">BookHotelActivity ........... RUNNING</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Booking hotel: Grand Hotel, Paris, 2026-03-01 to 2026-03-03, 1 guest(s). Confirmation #902928</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">BookHotelActivity .......... 4.35ms DONE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">BookFlightActivity .......... RUNNING</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">BookFlightActivity ......... 8.37ms FAIL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CancelHotelActivity ......... RUNNING</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Cancelling hotel Hotel booked: Grand Hotel, Paris, check-in 2026-03-01,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">check-out 2026-03-03, 1 guest(s). Confirmation #902928...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CancelHotelActivity ....... 3.74ms DONE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">AiWorkflow ............... 10.96ms DONE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Read that again. A user asked to book a hotel and a flight in a single message. The hotel went through. The flight failed. And the system <em>automatically cancelled the hotel using the original confirmation number</em>. The user saw this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Agent: Flight booking failed: New York to Paris.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       Any previous bookings have been cancelled.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Distributed transaction management that just works.</p><p>This is a durable AI travel agent built with the Laravel AI SDK and Durable Workflow. It&#x27;s one continuous conversation where every possible outcome is handled gracefully: successful bookings, partial failures, timeouts, and saga compensation, all in about 100 lines of workflow code.</p><p>Let&#x27;s build it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem">The Problem<a class="hash-link" href="#the-problem" title="Direct link to heading">​</a></h2><p>Imagine you&#x27;re tasked with building a conversational AI travel agent. Not a toy, a real one. Users chat with it, ask it to book hotels, flights, and rental cars, and expect it to handle failures gracefully.</p><p>Here&#x27;s what you&#x27;d need with traditional Laravel patterns:</p><p><strong>State management.</strong> A <code>conversation_state</code> table tracking where each user is in the flow. A state machine (or a mess of <code>if</code> statements) to handle transitions. What happens if the user sends a message while a booking is in progress? What if two queue workers pick up the same conversation?</p><p><strong>Failure handling.</strong> An event listener on <code>BookingFailed</code>. Another listener to figure out which previous bookings need to be cancelled. A database query to look up confirmation numbers. A job to call each cancellation API. Another listener in case the <em>cancellation</em> fails.</p><p><strong>Timeouts.</strong> A cron job that runs every minute, queries for &quot;stale&quot; conversations, and closes them. Edge cases when a user sends a message at the exact moment the cron job fires.</p><p><strong>Cleanup.</strong> Scheduled commands to archive old conversations. Orphan detection for bookings that got confirmed but whose conversations crashed. Manual intervention scripts for the support team.</p><p>You&#x27;re looking at 500+ lines of infrastructure code scattered across jobs, events, listeners, models, migrations, service classes, and cron configurations. And you haven&#x27;t written a single line of business logic yet.</p><p>There&#x27;s a better way.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-solution-laravel-ai-sdk--durable-workflows">The Solution: Laravel AI SDK + Durable Workflows<a class="hash-link" href="#the-solution-laravel-ai-sdk--durable-workflows" title="Direct link to heading">​</a></h2><p>We&#x27;re going to build this with three things:</p><ol><li><strong>Laravel AI SDK</strong>, for the conversational agent and tool calling</li><li><strong>Durable Workflow</strong>, for durable execution, saga compensation, and timeouts</li><li><strong>About 100 lines of actual business logic</strong></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-create-the-agent">Step 1: Create the Agent<a class="hash-link" href="#step-1-create-the-agent" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:agent TravelAgent</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And give it some tools:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:tool BookHotel</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:tool BookFlight</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:tool BookRentalCar</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The agent is straightforward:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">class TravelAgent implements Agent, Conversational, HasTools</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    use Promptable;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private array $messages = [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function instructions(): Stringable|string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return &lt;&lt;&lt;&#x27;INSTRUCTIONS&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        You are a professional travel agent. Help users plan and book travel.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        BOOKING RULES:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - When a user asks to book a hotel, flight, or rental car, ALWAYS call</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          the appropriate booking tool immediately with whatever details they</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          provided. Never ask for more details before calling the tool.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - Use reasonable defaults for any missing information (e.g. 1 guest,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          next-day dates, economy class).</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - You may call multiple booking tools in a single response if the user</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          requests multiple bookings.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - For flights, always include a return date if the user mentions round</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          trip, return dates, or trip end dates. Omit return_date only for</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          explicitly one-way flights.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        CONVERSATION RULES:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - Be concise and action-oriented.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - After placing bookings, briefly confirm what was booked.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - You can also help with itinerary planning, destination advice,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          packing lists, and general travel logistics.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        INSTRUCTIONS;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function continue($messages): static</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;messages = $messages;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $this;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function messages(): iterable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $this-&gt;messages;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function tools(): iterable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            new BookHotel(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            new BookFlight(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            new BookRentalCar(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Notice we implement <code>Conversational</code> but we don&#x27;t use <code>RemembersConversations</code>. The workflow history is our conversation store. We pass it in through the <code>continue()</code> method.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-the-tools-pattern">Step 2: The Tools Pattern<a class="hash-link" href="#step-2-the-tools-pattern" title="Direct link to heading">​</a></h3><p>Here&#x27;s the <code>BookHotel</code> tool:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">class BookHotel implements Tool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static array $pending = [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function description(): Stringable|string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return &#x27;Book a hotel for the user.&#x27;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function handle(Request $request): Stringable|string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        self::$pending[] = [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;type&#x27; =&gt; &#x27;book_hotel&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;hotel_name&#x27; =&gt; $request[&#x27;hotel_name&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;check_in_date&#x27; =&gt; $request[&#x27;check_in_date&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;check_out_date&#x27; =&gt; $request[&#x27;check_out_date&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;guests&#x27; =&gt; (int) $request[&#x27;guests&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return &#x27;Booking hotel: &#x27; . $request[&#x27;hotel_name&#x27;] . &#x27; from &#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            . $request[&#x27;check_in_date&#x27;] . &#x27; to &#x27; . $request[&#x27;check_out_date&#x27;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            . &#x27; for &#x27; . $request[&#x27;guests&#x27;] . &#x27; guest(s)&#x27;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function schema(JsonSchema $schema): array</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;hotel_name&#x27; =&gt; $schema-&gt;string()-&gt;required()-&gt;description(&#x27;The name and location of the hotel to book&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;check_in_date&#x27; =&gt; $schema-&gt;string()-&gt;required()-&gt;description(&#x27;Check-in date (YYYY-MM-DD)&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;check_out_date&#x27; =&gt; $schema-&gt;string()-&gt;required()-&gt;description(&#x27;Check-out date (YYYY-MM-DD)&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;guests&#x27; =&gt; $schema-&gt;integer()-&gt;required()-&gt;description(&#x27;Number of guests&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is the key insight: <strong>the tool doesn&#x27;t book anything</strong>. It collects structured data from the AI into a static <code>$pending</code> array and returns a confirmation message to the agent. The actual booking happens later, inside the workflow, as a durable activity.</p><p>Why? Because tool calls happen inside the AI activity. If we booked the hotel directly in the tool&#x27;s <code>handle()</code> method, the workflow wouldn&#x27;t know about it and couldn&#x27;t compensate on failure. By collecting the requests and processing them in the workflow, every side effect is durable and reversible.</p><p><code>BookFlight</code> and <code>BookRentalCar</code> follow the same pattern.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-the-activity">Step 3: The Activity<a class="hash-link" href="#step-3-the-activity" title="Direct link to heading">​</a></h3><p>The <code>TravelAgentActivity</code> bridges the AI agent and the workflow:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">class TravelAgentActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($messages)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        BookHotel::$pending = [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        BookFlight::$pending = [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        BookRentalCar::$pending = [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $history = array_slice($messages, 0, -1);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $currentUserMessage = end($messages);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $response = (new TravelAgent())</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;continue($history)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;prompt($currentUserMessage-&gt;content);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $bookings = array_merge(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            BookHotel::$pending,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            BookFlight::$pending,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            BookRentalCar::$pending,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return json_encode([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;text&#x27; =&gt; (string) $response,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;bookings&#x27; =&gt; $bookings,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It resets the pending arrays, passes the conversation history to the agent, prompts it with the latest user message, and returns both the AI&#x27;s text response <em>and</em> any booking requests the tools collected. The workflow gets everything it needs in one shot.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-workflow-where-it-all-comes-together">The Workflow: Where It All Comes Together<a class="hash-link" href="#the-workflow-where-it-all-comes-together" title="Direct link to heading">​</a></h2><p>Here&#x27;s the complete workflow. (You can also view it on <a href="https://github.com/durable-workflow/sample-app/blob/main/app/Workflows/Ai/AiWorkflow.php" target="_blank" rel="noopener noreferrer">GitHub</a>.) Read it top to bottom. It&#x27;s the entire orchestration layer:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">class AiWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private const INACTIVITY_TIMEOUT = &#x27;2 minutes&#x27;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private const MAX_MESSAGES = 20;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #[SignalMethod]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function send(string $message): void</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;inbox-&gt;receive($message);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #[UpdateMethod]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function receive()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $this-&gt;outbox-&gt;nextUnsent();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($injectFailure = null)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $messages = [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            while (count($messages) &lt; self::MAX_MESSAGES) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $receivedMessage = yield awaitWithTimeout(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    self::INACTIVITY_TIMEOUT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    fn () =&gt; $this-&gt;inbox-&gt;hasUnread(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                if (! $receivedMessage) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    throw new Exception(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        &#x27;Session ended due to inactivity. Please start a new conversation.&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $messages[] = new UserMessage($this-&gt;inbox-&gt;nextUnread());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $result = yield activity(TravelAgentActivity::class, $messages);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $data = json_decode($result, true);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                foreach ($data[&#x27;bookings&#x27;] as $booking) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    yield from $this-&gt;handleBooking($booking, $injectFailure);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $messages[] = new AssistantMessage($data[&#x27;text&#x27;]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $this-&gt;outbox-&gt;send($data[&#x27;text&#x27;]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (count($messages) &gt;= self::MAX_MESSAGES) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                throw new Exception(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &#x27;This conversation has reached its message limit. &#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    . &#x27;Please start a new conversation to continue.&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (Throwable $th) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            yield from $this-&gt;compensate();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $this-&gt;outbox-&gt;send(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $th-&gt;getMessage() . &#x27; Any previous bookings have been cancelled.&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $messages;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private function handleBooking(array $data, ?string $injectFailure)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return match ($data[&#x27;type&#x27;]) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;book_hotel&#x27; =&gt; $this-&gt;bookHotel($data, $injectFailure),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;book_flight&#x27; =&gt; $this-&gt;bookFlight($data, $injectFailure),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;book_rental_car&#x27; =&gt; $this-&gt;bookRentalCar($data, $injectFailure),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private function bookHotel(array $data, ?string $injectFailure)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $hotel = yield activity(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            BookHotelActivity::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $data[&#x27;hotel_name&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $data[&#x27;check_in_date&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $data[&#x27;check_out_date&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            (int) $data[&#x27;guests&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $injectFailure === &#x27;hotel&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;addCompensation(fn () =&gt; activity(CancelHotelActivity::class, $hotel));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $hotel;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private function bookFlight(array $data, ?string $injectFailure)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $flight = yield activity(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            BookFlightActivity::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $data[&#x27;origin&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $data[&#x27;destination&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $data[&#x27;departure_date&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $data[&#x27;return_date&#x27;] ?? null,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $injectFailure === &#x27;flight&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;addCompensation(fn () =&gt; activity(CancelFlightActivity::class, $flight));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $flight;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private function bookRentalCar(array $data, ?string $injectFailure)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $rentalCar = yield activity(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            BookRentalCarActivity::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $data[&#x27;pickup_location&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $data[&#x27;pickup_date&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $data[&#x27;return_date&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $injectFailure === &#x27;car&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;addCompensation(fn () =&gt; activity(CancelRentalCarActivity::class, $rentalCar));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $rentalCar;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There&#x27;s a lot here. Let&#x27;s break it down.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-inbox--outbox-pattern">The Inbox / Outbox Pattern<a class="hash-link" href="#the-inbox--outbox-pattern" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#[SignalMethod]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public function send(string $message): void</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $this-&gt;inbox-&gt;receive($message);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#[UpdateMethod]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">public function receive()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return $this-&gt;outbox-&gt;nextUnsent();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The workflow has two communication channels. The <strong>inbox</strong> receives user messages via <code>SignalMethod</code>, fire-and-forget signals that get appended to a durable queue. The <strong>outbox</strong> holds agent responses, retrieved via <code>UpdateMethod</code>, synchronous queries that replay the workflow and return the next unsent message.</p><p>This is durable messaging. If the server crashes between receiving a user message and processing it, the message is still in the inbox when the workflow resumes. If the agent produces a response but the client disconnects before reading it, it&#x27;s still in the outbox on the next poll.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="timeout-as-business-logic">Timeout as Business Logic<a class="hash-link" href="#timeout-as-business-logic" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$receivedMessage = yield awaitWithTimeout(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    self::INACTIVITY_TIMEOUT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    fn () =&gt; $this-&gt;inbox-&gt;hasUnread(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if (! $receivedMessage) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    throw new Exception(&#x27;Session ended due to inactivity. Please start a new conversation.&#x27;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>awaitWithTimeout</code> pauses the workflow for up to 2 minutes, waiting for the condition to become true. If the user sends a message, execution continues immediately. If they don&#x27;t, it returns <code>false</code> and we throw an exception to end the conversation.</p><p>No cron job. No scheduled command. No database polling. The timeout is expressed <em>as part of the business logic</em>, right where it belongs. The framework handles the timer durably. If the server restarts during the 2-minute window, the timer picks up where it left off.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-conversation-loop">The Conversation Loop<a class="hash-link" href="#the-conversation-loop" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">while (count($messages) &lt; self::MAX_MESSAGES) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Wait for user input (with timeout)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Read the message</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Run the AI agent</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Process any bookings</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // Send the response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This reads like pseudocode, but it&#x27;s the real implementation. Each iteration:</p><ol><li><strong>Waits</strong> for a user message (durably, with timeout)</li><li><strong>Reads</strong> the next unread message from the inbox</li><li><strong>Runs</strong> the AI agent as a durable activity, passing the full conversation history</li><li><strong>Processes</strong> any booking requests the agent&#x27;s tools collected</li><li><strong>Sends</strong> the agent&#x27;s text response to the outbox</li></ol><p>The <code>$messages</code> array accumulates <code>UserMessage</code> and <code>AssistantMessage</code> objects as the conversation progresses. It&#x27;s passed to the agent on every turn so it has full context. And because everything is inside a durable workflow, if the queue worker crashes after step 3 but before step 5, it replays from where it left off.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-saga-pattern-star-of-the-show">The Saga Pattern: Star of the Show<a class="hash-link" href="#the-saga-pattern-star-of-the-show" title="Direct link to heading">​</a></h3><p>This is where it gets interesting.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">private function bookHotel(array $data, ?string $injectFailure)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $hotel = yield activity(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        BookHotelActivity::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $data[&#x27;hotel_name&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $data[&#x27;check_in_date&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $data[&#x27;check_out_date&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        (int) $data[&#x27;guests&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $injectFailure === &#x27;hotel&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $this-&gt;addCompensation(fn () =&gt; activity(CancelHotelActivity::class, $hotel));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return $hotel;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After each successful booking, we register a compensation action. <code>addCompensation</code> takes a callable that knows <em>exactly</em> how to undo what was just done, including the confirmation number, dates, and all the details returned by the booking activity.</p><p>If any subsequent step throws an exception, the <code>catch</code> block runs:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">catch (Throwable $th) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    yield from $this-&gt;compensate();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $this-&gt;outbox-&gt;send(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $th-&gt;getMessage() . &#x27; Any previous bookings have been cancelled.&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>$this-&gt;compensate()</code> executes all registered compensation actions <strong>in reverse order</strong>. If you booked a hotel, then a flight, then a rental car, and the rental car fails, the flight gets cancelled first, then the hotel. (To cancel them in parallel instead, we can set <code>$this-&gt;setParallelCompensation(true)</code>.)</p><p>And notice: the inactivity timeout and message limit are thrown as exceptions too. If a user walks away mid-booking, the <code>catch</code> block fires, compensation runs, and all their reservations get cleaned up. Every exit path goes through the same cleanup logic.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-just-happened">What Just Happened<a class="hash-link" href="#what-just-happened" title="Direct link to heading">​</a></h2><p>Let&#x27;s trace through the actual execution when a user books a hotel and a flight, but the flight fails:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">You: book Grand Hotel in Paris for 2 guests, check-in 2026-03-01,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     check-out 2026-03-03. Also book a flight NYC to Paris departing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     2026-03-01 returning 2026-03-03.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>1. Hotel books successfully</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">BookHotelActivity ........... RUNNING</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Booking hotel: Grand Hotel, Paris, 2026-03-01 to 2026-03-03,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2 guest(s). Confirmation #902928</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">BookHotelActivity .......... 4.35ms DONE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The workflow now has a compensation registered:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">fn () =&gt; activity(CancelHotelActivity::class, &quot;Hotel booked: Grand Hotel... Confirmation #902928&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2. Flight fails</strong> (injected failure for demo purposes)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">BookFlightActivity .......... RUNNING</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">BookFlightActivity ......... 8.37ms FAIL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>NonRetryableException</code> propagates up to the <code>catch</code> block.</p><p><strong>3. Saga compensation kicks in automatically</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CancelHotelActivity ......... RUNNING</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Cancelling hotel Hotel booked: Grand Hotel, Paris, check-in 2026-03-01,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">check-out 2026-03-03, 2 guest(s). Confirmation #902928...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CancelHotelActivity ....... 3.74ms DONE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The framework ran the compensation with the <em>exact</em> confirmation details from the original booking.</p><p><strong>4. User gets clean feedback</strong></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Agent: Flight booking failed: New York to Paris.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       Any previous bookings have been cancelled.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The error message is conversational, not a stack trace. The user knows what happened and what was cleaned up.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="without-sagas">Without Sagas?<a class="hash-link" href="#without-sagas" title="Direct link to heading">​</a></h2><p>Consider what you&#x27;d need without this pattern:</p><ul><li><strong>Orphaned hotel booking.</strong> Confirmation #902928 is still reserved, costing real money.</li><li><strong>Manual cleanup.</strong> Someone has to find and cancel it.</li><li><strong>Database queries</strong> to figure out which bookings belong to this conversation.</li><li><strong>Race conditions.</strong> What if the user retries while you&#x27;re cleaning up?</li><li><strong>Scattered compensation logic.</strong> Cancel handlers spread across event listeners, with no guarantee they all run.</li><li><strong>Angry customers and support tickets.</strong> The inevitable result.</li></ul><p>With sagas, it&#x27;s one line per booking:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$this-&gt;addCompensation(fn () =&gt; activity(CancelHotelActivity::class, $hotel));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The framework handles the rest.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="key-innovations">Key Innovations<a class="hash-link" href="#key-innovations" title="Direct link to heading">​</a></h2><p><strong>Timeouts as business logic.</strong> <code>awaitWithTimeout(&#x27;2 minutes&#x27;, ...)</code> expresses a timeout right in the workflow code, not as infrastructure configuration. If the user goes idle, the conversation ends gracefully with compensation.</p><p><strong>Conversational error messages.</strong> Every failure path (booking errors, timeouts, message limits) flows through the outbox as a normal message. The user never sees a stack trace or a &quot;Something went wrong&quot; page.</p><p><strong>Automatic cleanup on every exit.</strong> The <code>try/catch</code> wrapping the entire conversation loop means <em>any</em> exception triggers compensation. The conversation can&#x27;t end with orphaned bookings, no matter how it ends.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-traditional-approach">The Traditional Approach<a class="hash-link" href="#the-traditional-approach" title="Direct link to heading">​</a></h2><p>Let&#x27;s estimate what this would take with traditional Laravel patterns:</p><table><thead><tr><th>Concern</th><th>Traditional</th><th>Durable Workflow</th></tr></thead><tbody><tr><td>State tracking</td><td>Database table + state machine</td><td>Implicit in workflow position</td></tr><tr><td>Timeout handling</td><td>Cron job + stale detection</td><td><code>awaitWithTimeout()</code></td></tr><tr><td>Failure compensation</td><td>Event listeners + manual queries</td><td><code>addCompensation()</code> + <code>compensate()</code></td></tr><tr><td>Crash recovery</td><td>Custom retry logic + idempotency</td><td>Automatic replay</td></tr><tr><td>Race conditions</td><td>Locks + transactions</td><td>Single-threaded workflow execution</td></tr><tr><td>Cleanup</td><td>Scheduled commands + orphan detection</td><td>Catch block</td></tr><tr><td><strong>Total</strong></td><td><strong>~500 lines across 10+ files</strong></td><td><strong>~100 lines in 1 file</strong></td></tr></tbody></table><p>The traditional approach isn&#x27;t just more code, it&#x27;s more <em>categories</em> of code. You&#x27;re writing infrastructure: state machines, cleanup jobs, event wiring, retry logic. With a durable workflow, you&#x27;re writing business logic: wait for a message, call the agent, book the hotel, compensate on failure.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="observability">Observability<a class="hash-link" href="#observability" title="Direct link to heading">​</a></h2><p>Every message, every activity, every retry, every timeout, every exception, every compensation step, all of it is visible in real time in <a href="https://github.com/durable-workflow/waterline" target="_blank" rel="noopener noreferrer">Waterline</a>.</p><p>You can literally scroll through the workflow and see:</p><ul><li>Each user message arriving via a signal</li><li>Each AI turn as a durable activity</li><li>Every booking attempt with inputs and outputs</li><li>The exact moment a failure occurs (and the line it occured on with a stack trace)</li><li>The saga compensation steps, executed automatically in reverse order</li><li>How long each step took, down to the millisecond</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>This is a paradigm shift. Instead of building infrastructure to manage state, handle failures, and coordinate distributed operations, you write a function that describes what should happen. The framework provides durability, retry, compensation, and crash recovery.</p><p>The entire travel agent (AI conversation, multi-step bookings, saga compensation, inactivity timeouts, message limits, and graceful error handling) is expressed in a single workflow class. Production-grade UX with development-friendly code.</p><p>No state machine tables. No cleanup crons. No orphaned bookings. No scattered event listeners. Just a workflow that reads like the business requirements it implements.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="try-it-now-in-your-browser">Try It Now in Your Browser<a class="hash-link" href="#try-it-now-in-your-browser" title="Direct link to heading">​</a></h3><p>We’ve bundled this workflow into the official Workflow <a href="https://github.com/durable-workflow/sample-app" target="_blank" rel="noopener noreferrer">Sample App</a>.</p><p>To try it:</p><ol><li>Open the sample-app repo on GitHub</li><li>Click <strong>Code</strong> → <strong>Codespaces</strong> → <strong>Create codespace on main</strong></li><li>Wait for the environment to build</li><li>Set your OPENAI_API_KEY in the .env</li><li>Setup the app and start the queue worker:<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan app:init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan queue:work</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>In a second terminal:</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan app:ai</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note: You can optionally inject a failure at one of the booking steps by running it with the <code>--inject-failure</code> flag e.g. <code>php artisan app:ai --inject-failure flight</code>. Valid options are <code>hotel</code>, <code>flight</code> or <code>car</code>.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai/">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/workflow/">workflow</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/agents/">agents</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/tools/">tools</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/laravel-workflows-as-mcp-tools-for-ai-clients/">Workflows as MCP Tools for AI Clients</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-12-03T00:00:00.000Z" itemprop="datePublished">December 3, 2025</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/rmcdaniel" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/rmcdaniel.png" alt="Richard"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/rmcdaniel" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Richard</span></a></div><small class="avatar__subtitle" itemprop="description">Core Team</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>The Model Context Protocol (MCP) is rapidly becoming the standard way for AI assistants like Claude, ChatGPT, and GitHub Copilot to interact with external tools and services. With Laravel MCP, you can expose your Workflow processes as callable tools that any MCP-compatible AI client can discover, invoke, and monitor.</p><p>In this post, we&#x27;ll show how to build an MCP server that allows AI clients to:</p><ul><li>Discover available workflows</li><li>Start workflows asynchronously</li><li>Poll for status and retrieve results</li></ul><p>This creates a powerful pattern where AI agents can orchestrate long-running, durable workflows, perfect for complex tasks that can&#x27;t complete in a single request.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-mcp--durable-workflow">Why MCP + Durable Workflow?<a class="hash-link" href="#why-mcp--durable-workflow" title="Direct link to heading">​</a></h3><p>Durable Workflow (formerly Laravel Workflow) excels at durable, stateful execution. MCP excels at giving AI clients structured access to external capabilities. Together, they enable:</p><ul><li><strong>Async AI operations</strong>: Start a workflow, continue the conversation, check results later</li><li><strong>Reliable execution</strong>: Workflows survive crashes, retries, and long wait times</li><li><strong>Observability</strong>: Track every workflow through Waterline&#x27;s dashboard</li><li><strong>Stateless servers</strong>: The MCP server doesn&#x27;t hold state. Clients track workflow IDs</li></ul><p>This mirrors how humans delegate tasks: &quot;Start this report, I&#x27;ll check back later.&quot;</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-were-building">What We&#x27;re Building<a class="hash-link" href="#what-were-building" title="Direct link to heading">​</a></h3><p>We&#x27;ll create an MCP server with three tools:</p><table><thead><tr><th>Tool</th><th>Purpose</th></tr></thead><tbody><tr><td><code>list_workflows</code></td><td>Discover available workflows and view recent runs</td></tr><tr><td><code>start_workflow</code></td><td>Start a workflow and get a tracking ID</td></tr><tr><td><code>get_workflow_result</code></td><td>Check status and retrieve output when complete</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-implementation">Step-by-Step Implementation<a class="hash-link" href="#step-by-step-implementation" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-install-laravel-mcp">1. Install Laravel MCP<a class="hash-link" href="#1-install-laravel-mcp" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">composer</span><span class="token plain"> require laravel/mcp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan vendor:publish --tag</span><span class="token operator">=</span><span class="token plain">ai-routes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This gives you <code>routes/ai.php</code> where you&#x27;ll register your MCP server.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-create-the-mcp-server">2. Create the MCP Server<a class="hash-link" href="#2-create-the-mcp-server" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:mcp-server WorkflowServer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Configure it with instructions for the AI:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Mcp\Servers;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Mcp\Tools\GetWorkflowResultTool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Mcp\Tools\ListWorkflowsTool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Mcp\Tools\StartWorkflowTool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Server;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class WorkflowServer extends Server</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $name = &#x27;Workflow Server&#x27;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $version = &#x27;1.0.0&#x27;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $instructions = &lt;&lt;&lt;&#x27;MARKDOWN&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        This server allows you to start and monitor Workflows.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ## Typical Usage Pattern</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        1. Call `list_workflows` to see what workflows are available.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        2. Call `start_workflow` with the workflow name and arguments.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        3. Store the returned `workflow_id`.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        4. Call `get_workflow_result` until status is `WorkflowCompletedStatus`.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        5. Read the `output` field for the result.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ## Status Values</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowCreatedStatus` - Workflow has been created</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowPendingStatus` - Queued for execution</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowRunningStatus` - Currently executing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowWaitingStatus` - Waiting (timer, signal, etc.)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowCompletedStatus` - Finished successfully</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowFailedStatus` - Encountered an error</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MARKDOWN;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected array $tools = [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ListWorkflowsTool::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        StartWorkflowTool::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        GetWorkflowResultTool::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-create-the-start-workflow-tool">3. Create the Start Workflow Tool<a class="hash-link" href="#3-create-the-start-workflow-tool" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:mcp-tool StartWorkflowTool</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Mcp\Tools;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Contracts\JsonSchema\JsonSchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Arr;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Request;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Response;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Server\Tool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\WorkflowStub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class StartWorkflowTool extends Tool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $description = &lt;&lt;&lt;&#x27;MARKDOWN&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Start a Workflow asynchronously and return its workflow ID.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        The workflow will execute in the background on the queue. Use the</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        `get_workflow_result` tool to poll for status and retrieve results</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        once the workflow completes.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MARKDOWN;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function handle(Request $request): Response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $data = $request-&gt;validate([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;workflow&#x27; =&gt; [&#x27;required&#x27;, &#x27;string&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;args&#x27; =&gt; [&#x27;nullable&#x27;, &#x27;array&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;external_id&#x27; =&gt; [&#x27;nullable&#x27;, &#x27;string&#x27;, &#x27;max:255&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflowKey = $data[&#x27;workflow&#x27;];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $args = Arr::get($data, &#x27;args&#x27;, []);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $externalId = $data[&#x27;external_id&#x27;] ?? null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflowClass = $this-&gt;resolveWorkflowClass($workflowKey);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if ($workflowClass === null) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return Response::error(&quot;Unknown workflow: {$workflowKey}&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (! class_exists($workflowClass) || ! is_subclass_of($workflowClass, Workflow::class)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return Response::error(&quot;Invalid workflow class: {$workflowClass}&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $stub = WorkflowStub::make($workflowClass);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $stub-&gt;start(...array_values($args));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $status = $stub-&gt;status();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $statusName = is_object($status) ? class_basename($status) : class_basename((string) $status);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return Response::json([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;workflow_id&#x27; =&gt; $stub-&gt;id(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;workflow&#x27; =&gt; $workflowKey,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;status&#x27; =&gt; $statusName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;external_id&#x27; =&gt; $externalId,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;message&#x27; =&gt; &#x27;Workflow started. Use get_workflow_result to poll status.&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected function resolveWorkflowClass(string $key): ?string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $mapped = config(&quot;workflow_mcp.workflows.{$key}&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if ($mapped !== null) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return $mapped;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (config(&#x27;workflow_mcp.allow_fqcn&#x27;, false) &amp;&amp; str_contains($key, &#x27;\\&#x27;)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return $key;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function schema(JsonSchema $schema): array</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflows = implode(&#x27;, &#x27;, array_keys(config(&#x27;workflow_mcp.workflows&#x27;, [])));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;workflow&#x27; =&gt; $schema-&gt;string()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description(&quot;The workflow to start. Available: {$workflows}&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;args&#x27; =&gt; $schema-&gt;object()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description(&#x27;Arguments for the workflow execute() method.&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;external_id&#x27; =&gt; $schema-&gt;string()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description(&#x27;Optional idempotency key for tracking.&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-create-the-get-result-tool">4. Create the Get Result Tool<a class="hash-link" href="#4-create-the-get-result-tool" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:mcp-tool GetWorkflowResultTool</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Mcp\Tools;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Models\StoredWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Contracts\JsonSchema\JsonSchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Request;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Response;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Server\Tool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\States\WorkflowCompletedStatus;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\States\WorkflowFailedStatus;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\WorkflowStub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class GetWorkflowResultTool extends Tool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $description = &lt;&lt;&lt;&#x27;MARKDOWN&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Fetch the status and, if completed, the output of a Workflow.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Use the workflow_id returned by `start_workflow` to check progress.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Once status is `WorkflowCompletedStatus`, the output field contains the result.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MARKDOWN;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function handle(Request $request): Response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $data = $request-&gt;validate([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;workflow_id&#x27; =&gt; [&#x27;required&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflowId = $data[&#x27;workflow_id&#x27;];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $stored = StoredWorkflow::find($workflowId);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (! $stored) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return Response::json([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                &#x27;found&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                &#x27;message&#x27; =&gt; &quot;Workflow {$workflowId} not found.&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow = WorkflowStub::load($workflowId);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $status = $workflow-&gt;status();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $statusName = is_object($status) ? class_basename($status) : class_basename((string) $status);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $running = $workflow-&gt;running();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $result = null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $error = null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (! $running &amp;&amp; str_contains($statusName, &#x27;Completed&#x27;)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $result = $workflow-&gt;output();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (! $running &amp;&amp; str_contains($statusName, &#x27;Failed&#x27;)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $exception = $stored-&gt;exceptions()-&gt;latest()-&gt;first();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $error = $exception?-&gt;exception ?? &#x27;Unknown error&#x27;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return Response::json([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;found&#x27; =&gt; true,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;workflow_id&#x27; =&gt; $workflowId,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;status&#x27; =&gt; $statusName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;running&#x27; =&gt; $running,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;output&#x27; =&gt; $result,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;error&#x27; =&gt; $error,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;created_at&#x27; =&gt; $stored-&gt;created_at?-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;updated_at&#x27; =&gt; $stored-&gt;updated_at?-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function schema(JsonSchema $schema): array</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;workflow_id&#x27; =&gt; $schema-&gt;string()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description(&#x27;The workflow ID returned by start_workflow.&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-create-the-list-workflows-tool">5. Create the List Workflows Tool<a class="hash-link" href="#5-create-the-list-workflows-tool" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:mcp-tool ListWorkflowsTool</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Mcp\Tools;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Models\StoredWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Contracts\JsonSchema\JsonSchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Request;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Response;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Server\Tool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class ListWorkflowsTool extends Tool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $description = &lt;&lt;&lt;&#x27;MARKDOWN&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List available workflow types and optionally show recent workflow runs.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Use this to discover what workflows can be started, or to see</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        the status of recent executions.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MARKDOWN;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function handle(Request $request): Response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $data = $request-&gt;validate([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;show_recent&#x27; =&gt; [&#x27;nullable&#x27;, &#x27;boolean&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;limit&#x27; =&gt; [&#x27;nullable&#x27;, &#x27;integer&#x27;, &#x27;min:1&#x27;, &#x27;max:50&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;status&#x27; =&gt; [&#x27;nullable&#x27;, &#x27;string&#x27;],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $showRecent = $data[&#x27;show_recent&#x27;] ?? false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $limit = $data[&#x27;limit&#x27;] ?? 10;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $statusFilter = $data[&#x27;status&#x27;] ?? null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $availableWorkflows = [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        foreach (config(&#x27;workflow_mcp.workflows&#x27;, []) as $key =&gt; $class) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $availableWorkflows[] = [&#x27;key&#x27; =&gt; $key, &#x27;class&#x27; =&gt; $class];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $response = [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;available_workflows&#x27; =&gt; $availableWorkflows,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if ($showRecent) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $query = StoredWorkflow::query()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;orderBy(&#x27;created_at&#x27;, &#x27;desc&#x27;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;limit($limit);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if ($statusFilter) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $query-&gt;where(&#x27;status&#x27;, &#x27;like&#x27;, &quot;%{$statusFilter}%&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $response[&#x27;recent_workflows&#x27;] = $query-&gt;get()-&gt;map(function ($w) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $status = $w-&gt;status;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $statusName = is_object($status) ? class_basename($status) : class_basename((string) $status);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &#x27;id&#x27; =&gt; $w-&gt;id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &#x27;class&#x27; =&gt; $w-&gt;class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &#x27;status&#x27; =&gt; $statusName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    &#x27;created_at&#x27; =&gt; $w-&gt;created_at?-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return Response::json($response);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function schema(JsonSchema $schema): array</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;show_recent&#x27; =&gt; $schema-&gt;boolean()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description(&#x27;Include recent workflow runs in response.&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;limit&#x27; =&gt; $schema-&gt;integer()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description(&#x27;Max recent workflows to return (default: 10).&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &#x27;status&#x27; =&gt; $schema-&gt;string()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description(&#x27;Filter by status (e.g., &quot;Completed&quot;, &quot;Failed&quot;).&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="6-configure-available-workflows">6. Configure Available Workflows<a class="hash-link" href="#6-configure-available-workflows" title="Direct link to heading">​</a></h4><p>Create <code>config/workflow_mcp.php</code> to whitelist which workflows AI clients can start:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;allow_fqcn&#x27; =&gt; env(&#x27;WORKFLOW_MCP_ALLOW_FQCN&#x27;, false),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &#x27;workflows&#x27; =&gt; [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &#x27;simple&#x27; =&gt; App\Workflows\Simple\SimpleWorkflow::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &#x27;prism&#x27; =&gt; App\Workflows\Prism\PrismWorkflow::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This prevents arbitrary class execution. Only mapped workflows are accessible.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="7-register-the-mcp-server">7. Register the MCP Server<a class="hash-link" href="#7-register-the-mcp-server" title="Direct link to heading">​</a></h4><p>Update <code>routes/ai.php</code>:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Mcp\Servers\WorkflowServer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Facades\Mcp;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Mcp::web(&#x27;/mcp/workflows&#x27;, WorkflowServer::class);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="connecting-ai-clients">Connecting AI Clients<a class="hash-link" href="#connecting-ai-clients" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="vs-code--github-copilot">VS Code / GitHub Copilot<a class="hash-link" href="#vs-code--github-copilot" title="Direct link to heading">​</a></h4><p>Create <code>.vscode/mcp.json</code> in your project:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;servers&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;laravel-workflow&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;url&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http://localhost/mcp/workflows&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This configuration works for both local development and GitHub Codespaces. In Codespaces, the VS Code server runs inside the container, so <code>localhost</code> correctly reaches the Laravel server without needing public ports or the <code>*.app.github.dev</code> URL.</p><p>After reloading VS Code (Cmd/Ctrl+Shift+P → &quot;Developer: Reload Window&quot;), Copilot can use the workflow tools directly in chat.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="real-world-usage">Real-World Usage<a class="hash-link" href="#real-world-usage" title="Direct link to heading">​</a></h3><p>Once connected, you can have natural conversations with your AI assistant:</p><blockquote><p><strong>You:</strong> &quot;What workflows are available?&quot;</p><p><strong>AI:</strong> <em>calls list_workflows</em> &quot;I found 2 workflows: <code>simple</code> and <code>prism</code>.&quot;</p></blockquote><blockquote><p><strong>You:</strong> &quot;Start the prism workflow&quot;</p><p><strong>AI:</strong> <em>calls start_workflow</em> &quot;Started workflow ID 42. I&#x27;ll check its status.&quot;</p></blockquote><blockquote><p><strong>AI:</strong> <em>calls get_workflow_result</em> &quot;The workflow completed! Here&#x27;s the generated user profile: { name: &#x27;Elena&#x27;, hobbies: <!-- -->[...]<!-- --> }&quot;</p></blockquote><p>This creates a seamless experience where AI assistants can orchestrate complex, long-running operations while keeping the user informed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-makes-this-pattern-powerful">What Makes This Pattern Powerful<a class="hash-link" href="#what-makes-this-pattern-powerful" title="Direct link to heading">​</a></h3><ul><li><strong>Durability</strong>: Workflows survive server restarts and network failures</li><li><strong>Async by design</strong>: AI clients don&#x27;t block waiting for completion</li><li><strong>Observable</strong>: Every workflow is tracked in Waterline&#x27;s dashboard</li><li><strong>Secure</strong>: Whitelist-based workflow access prevents arbitrary execution</li><li><strong>Stateless MCP</strong>: The server holds no state. Clients track workflow IDs</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="try-it-now-in-your-browser">Try It Now in Your Browser<a class="hash-link" href="#try-it-now-in-your-browser" title="Direct link to heading">​</a></h3><p>This MCP integration is included and pre-configured in the Durable Workflow <a href="https://github.com/durable-workflow/sample-app" target="_blank" rel="noopener noreferrer">Sample App</a>.</p><p>To try it:</p><ol><li>Open the sample-app repo on GitHub</li><li>Click <strong>Code</strong> → <strong>Codespaces</strong> → <strong>Create codespace on main</strong></li><li>Wait for the environment to build</li><li>Setup the app and start the queue worker:<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan app:init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan queue:work</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>Enable the Durable Workflow Server MCP tools</li><li>Ask your AI to list and run workflows!</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="where-to-go-from-here">Where to Go From Here<a class="hash-link" href="#where-to-go-from-here" title="Direct link to heading">​</a></h3><p>You can extend this pattern to:</p><ul><li><strong>Parameterized workflows</strong>: Pass user input to workflow arguments</li><li><strong>Webhook notifications</strong>: Push completion events instead of polling</li><li><strong>Workflow signals</strong>: Let AI clients send signals to waiting workflows</li><li><strong>Progress streaming</strong>: Use SSE to stream workflow progress in real-time</li><li><strong>Multi-step agents</strong>: Chain multiple workflows together in a conversation</li></ul><p>The combination of Durable Workflow&#x27;s durable execution and MCP&#x27;s tool protocol creates a foundation for truly capable AI agents that can handle real-world complexity.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai/">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/workflow/">workflow</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mcp/">mcp</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/agents/">agents</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/tools/">tools</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/building-reliable-agentic-loops-with-laravel-workflow-and-prismphp/">Building Reliable Agentic Loops with Workflow and PrismPHP</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-07-10T00:00:00.000Z" itemprop="datePublished">July 10, 2025</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/rmcdaniel" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/rmcdaniel.png" alt="Richard"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/rmcdaniel" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Richard</span></a></div><small class="avatar__subtitle" itemprop="description">Core Team</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" src="https://raw.githubusercontent.com/prism-php/prism/main/assets/prism-logo.webp" alt="captionless image" class="img_ev3q"></p><p>Workflow is a powerful tool for orchestrating long-running, stateful workflows in PHP. Paired with <a href="https://prismphp.com/" target="_blank" rel="noopener noreferrer">PrismPHP</a>, it becomes a compelling foundation for building reliable AI agents that not only generate structured data but verify and retry until results meet strict real-world constraints.</p><p>In this post, we’ll show how to use Workflow + Prism to create an agentic loop that:</p><ul><li>Generates structured data using an LLM</li><li>Validates the result against custom rules</li><li>Retries automatically until the result passes</li></ul><p>You can try this exact workflow right now in your browser with no setup or coding required. Just click the button in the Workflow <a href="https://github.com/laravel-workflow/sample-app" target="_blank" rel="noopener noreferrer">Sample App</a> and launch a GitHub Codespace to run it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-were-building">What We’re Building<a class="hash-link" href="#what-were-building" title="Direct link to heading">​</a></h3><p>We’ll create a workflow that asks an LLM to generate a user profile with hobbies. Then we’ll validate that:</p><ul><li>The name is present</li><li>At least one hobby is defined</li><li>The name starts with a vowel</li></ul><p>If the result fails validation, we loop back to the LLM and regenerate. All of this is durable, asynchronous, and tracked through stateful events.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-example">Step-by-Step Example<a class="hash-link" href="#step-by-step-example" title="Direct link to heading">​</a></h3><ol><li>Console Command to Trigger the Workflow</li></ol><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Workflows\Prism\PrismWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Console\Command;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\WorkflowStub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class Prism extends Command</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected $signature = &#x27;app:prism&#x27;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected $description = &#x27;Runs a Prism AI workflow&#x27;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function handle()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow = WorkflowStub::make(PrismWorkflow::class);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow-&gt;start();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        while ($workflow-&gt;running());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $user = $workflow-&gt;output();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;info(&#x27;Generated User:&#x27;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;info(json_encode($user, JSON_PRETTY_PRINT));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Define the Workflow Logic</li></ol><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class PrismWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        do {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $user = yield activity(GenerateUserActivity::class);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $valid = yield activity(ValidateUserActivity::class, $user);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } while (!$valid);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $user;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is a classic agent loop. If validation fails, we prompt again automatically.</p><ol start="3"><li>Generate Structured User Data with PrismPHP</li></ol><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Prism\Prism\Prism;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Prism\Prism\Enums\Provider;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Prism\Prism\Schema\ArraySchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Prism\Prism\Schema\ObjectSchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Prism\Prism\Schema\StringSchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class GenerateUserActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $schema = new ObjectSchema(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            name: &#x27;user&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            description: &#x27;A user profile with their hobbies&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            properties: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new StringSchema(&#x27;name&#x27;, &#x27;The user\&#x27;s full name&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new ArraySchema(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    name: &#x27;hobbies&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    description: &#x27;The user\&#x27;s list of hobbies&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    items: new ObjectSchema(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        name: &#x27;hobby&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        description: &#x27;A detailed hobby entry&#x27;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        properties: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                            new StringSchema(&#x27;name&#x27;, &#x27;The name of the hobby&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                            new StringSchema(&#x27;description&#x27;, &#x27;A brief description of the hobby&#x27;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        requiredFields: [&#x27;name&#x27;, &#x27;description&#x27;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                ),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            requiredFields: [&#x27;name&#x27;, &#x27;hobbies&#x27;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $response = Prism::structured()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;using(Provider::OpenAI, &#x27;gpt-4o&#x27;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;withSchema($schema)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;withPrompt(&#x27;Use names from many languages and vary first initials.&#x27;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;asStructured();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $response-&gt;structured;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>Validate Business Logic</li></ol><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class ValidateUserActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($user)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (empty($user[&#x27;name&#x27;]) || !is_array($user[&#x27;hobbies&#x27;]) || count($user[&#x27;hobbies&#x27;]) === 0) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        foreach ($user[&#x27;hobbies&#x27;] as $hobby) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (empty($hobby[&#x27;name&#x27;]) || empty($hobby[&#x27;description&#x27;])) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                return false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // Extra Validation: The user&#x27;s name must start with a vowel.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (!in_array(strtoupper($user[&#x27;name&#x27;][0]), [&#x27;A&#x27;, &#x27;E&#x27;, &#x27;I&#x27;, &#x27;O&#x27;, &#x27;U&#x27;])) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return true;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-makes-this-pattern-powerful">What Makes This Pattern Powerful<a class="hash-link" href="#what-makes-this-pattern-powerful" title="Direct link to heading">​</a></h3><p>This design pattern is what you’d call a reliable agentic loop:</p><ul><li>LLM generation via Prism</li><li>Validation &amp; retry via Workflow</li><li>State persistence for crash recovery or inspection</li><li>Observability via Waterline</li></ul><p>It’s perfect for AI applications where accuracy, safety, and traceability are required.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="try-it-now-in-your-browser">Try It Now in Your Browser<a class="hash-link" href="#try-it-now-in-your-browser" title="Direct link to heading">​</a></h3><p>We’ve bundled this workflow into the official Workflow <a href="https://github.com/laravel-workflow/sample-app" target="_blank" rel="noopener noreferrer">Sample App</a>.</p><p>To try it:</p><ol><li>Open the sample-app repo on GitHub</li><li>Click <strong>Code</strong> → <strong>Codespaces</strong> → <strong>Create codespace on main</strong></li><li>Wait for the environment to build</li><li>Set your OPENAI_API_KEY in the .env</li><li>Setup the app and start the queue worker:<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan app:init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan queue:work</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>In a second terminal:</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan app:prism</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You will see the queue working and eventually see the validated output.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="where-to-go-from-here">Where to Go From Here<a class="hash-link" href="#where-to-go-from-here" title="Direct link to heading">​</a></h3><p>You can easily adapt this pattern to:</p><ul><li>AI agents for form filling</li><li>Data scraping and validation</li><li>Content generation with retry policies</li><li>Moderation and review queues</li></ul><p>Each step remains reliable and traceable thanks to Workflow’s durable execution model.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai/">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/workflow/">workflow</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/agents/">agents</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/agentic/">agentic</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/installation/">Installation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/xu5aDDpqVy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/DurableWorkflow" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://durable-workflow.com/llms.txt" target="_blank" rel="noopener noreferrer" class="footer__link-item">LLM Docs</a></li><li class="footer__item"><a href="https://packagist.org/packages/laravel-workflow/laravel-workflow" target="_blank" rel="noopener noreferrer" class="footer__link-item">Packagist<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 <a href="https://durable-workflow.com">Durable Workflow</a>.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e30081ab.js"></script>
<script src="/assets/js/main.2e1ed098.js"></script>
</body>
</html>