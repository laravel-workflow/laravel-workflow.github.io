<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Workflow Blog</title>
        <link>https://laravel-workflow.com/blog</link>
        <description>Workflow Blog</description>
        <lastBuildDate>Wed, 03 Dec 2025 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Laravel Workflows as MCP Tools for AI Clients]]></title>
            <link>https://laravel-workflow.com/blog/laravel-workflows-as-mcp-tools-for-ai-clients</link>
            <guid>laravel-workflows-as-mcp-tools-for-ai-clients</guid>
            <pubDate>Wed, 03 Dec 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[The Model Context Protocol (MCP) is rapidly becoming the standard way for AI assistants like Claude, ChatGPT, and GitHub Copilot to interact with external tools and services. With Laravel MCP, you can expose your Laravel Workflow processes as callable tools that any MCP-compatible AI client can discover, invoke, and monitor.]]></description>
            <content:encoded><![CDATA[<p>The Model Context Protocol (MCP) is rapidly becoming the standard way for AI assistants like Claude, ChatGPT, and GitHub Copilot to interact with external tools and services. With Laravel MCP, you can expose your Laravel Workflow processes as callable tools that any MCP-compatible AI client can discover, invoke, and monitor.</p><p>In this post, we'll show how to build an MCP server that allows AI clients to:</p><ul><li>Discover available workflows</li><li>Start workflows asynchronously</li><li>Poll for status and retrieve results</li></ul><p>This creates a powerful pattern where AI agents can orchestrate long-running, durable workflows, perfect for complex tasks that can't complete in a single request.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-mcp--laravel-workflow">Why MCP + Laravel Workflow?<a class="hash-link" href="#why-mcp--laravel-workflow" title="Direct link to heading">​</a></h3><p>Laravel Workflow excels at durable, stateful execution. MCP excels at giving AI clients structured access to external capabilities. Together, they enable:</p><ul><li><strong>Async AI operations</strong>: Start a workflow, continue the conversation, check results later</li><li><strong>Reliable execution</strong>: Workflows survive crashes, retries, and long wait times</li><li><strong>Observability</strong>: Track every workflow through Waterline's dashboard</li><li><strong>Stateless servers</strong>: The MCP server doesn't hold state. Clients track workflow IDs</li></ul><p>This mirrors how humans delegate tasks: "Start this report, I'll check back later."</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-were-building">What We're Building<a class="hash-link" href="#what-were-building" title="Direct link to heading">​</a></h3><p>We'll create an MCP server with three tools:</p><table><thead><tr><th>Tool</th><th>Purpose</th></tr></thead><tbody><tr><td><code>list_workflows</code></td><td>Discover available workflows and view recent runs</td></tr><tr><td><code>start_workflow</code></td><td>Start a workflow and get a tracking ID</td></tr><tr><td><code>get_workflow_result</code></td><td>Check status and retrieve output when complete</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-implementation">Step-by-Step Implementation<a class="hash-link" href="#step-by-step-implementation" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-install-laravel-mcp">1. Install Laravel MCP<a class="hash-link" href="#1-install-laravel-mcp" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">composer</span><span class="token plain"> require laravel/mcp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan vendor:publish --tag</span><span class="token operator">=</span><span class="token plain">ai-routes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This gives you <code>routes/ai.php</code> where you'll register your MCP server.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-create-the-mcp-server">2. Create the MCP Server<a class="hash-link" href="#2-create-the-mcp-server" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:mcp-server WorkflowServer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Configure it with instructions for the AI:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Mcp\Servers;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Mcp\Tools\GetWorkflowResultTool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Mcp\Tools\ListWorkflowsTool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Mcp\Tools\StartWorkflowTool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Server;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class WorkflowServer extends Server</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $name = 'Laravel Workflow Server';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $version = '1.0.0';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $instructions = &lt;&lt;&lt;'MARKDOWN'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        This server allows you to start and monitor Laravel Workflows.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ## Typical Usage Pattern</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        1. Call `list_workflows` to see what workflows are available.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        2. Call `start_workflow` with the workflow name and arguments.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        3. Store the returned `workflow_id`.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        4. Call `get_workflow_result` until status is `WorkflowCompletedStatus`.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        5. Read the `output` field for the result.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ## Status Values</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowCreatedStatus` - Workflow has been created</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowPendingStatus` - Queued for execution</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowRunningStatus` - Currently executing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowWaitingStatus` - Waiting (timer, signal, etc.)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowCompletedStatus` - Finished successfully</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - `WorkflowFailedStatus` - Encountered an error</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MARKDOWN;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected array $tools = [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ListWorkflowsTool::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        StartWorkflowTool::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        GetWorkflowResultTool::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-create-the-start-workflow-tool">3. Create the Start Workflow Tool<a class="hash-link" href="#3-create-the-start-workflow-tool" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:mcp-tool StartWorkflowTool</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Mcp\Tools;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Contracts\JsonSchema\JsonSchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Arr;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Request;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Response;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Server\Tool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\WorkflowStub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class StartWorkflowTool extends Tool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $description = &lt;&lt;&lt;'MARKDOWN'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Start a Laravel Workflow asynchronously and return its workflow ID.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        The workflow will execute in the background on the queue. Use the</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        `get_workflow_result` tool to poll for status and retrieve results</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        once the workflow completes.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MARKDOWN;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function handle(Request $request): Response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $data = $request-&gt;validate([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'workflow' =&gt; ['required', 'string'],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'args' =&gt; ['nullable', 'array'],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'external_id' =&gt; ['nullable', 'string', 'max:255'],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflowKey = $data['workflow'];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $args = Arr::get($data, 'args', []);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $externalId = $data['external_id'] ?? null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflowClass = $this-&gt;resolveWorkflowClass($workflowKey);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if ($workflowClass === null) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return Response::error("Unknown workflow: {$workflowKey}");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (! class_exists($workflowClass) || ! is_subclass_of($workflowClass, Workflow::class)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return Response::error("Invalid workflow class: {$workflowClass}");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $stub = WorkflowStub::make($workflowClass);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $stub-&gt;start(...array_values($args));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $status = $stub-&gt;status();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $statusName = is_object($status) ? class_basename($status) : class_basename((string) $status);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return Response::json([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'workflow_id' =&gt; $stub-&gt;id(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'workflow' =&gt; $workflowKey,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'status' =&gt; $statusName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'external_id' =&gt; $externalId,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'message' =&gt; 'Workflow started. Use get_workflow_result to poll status.',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected function resolveWorkflowClass(string $key): ?string</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $mapped = config("workflow_mcp.workflows.{$key}");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if ($mapped !== null) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return $mapped;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (config('workflow_mcp.allow_fqcn', false) &amp;&amp; str_contains($key, '\\')) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return $key;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function schema(JsonSchema $schema): array</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflows = implode(', ', array_keys(config('workflow_mcp.workflows', [])));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'workflow' =&gt; $schema-&gt;string()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description("The workflow to start. Available: {$workflows}"),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'args' =&gt; $schema-&gt;object()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description('Arguments for the workflow execute() method.'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'external_id' =&gt; $schema-&gt;string()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description('Optional idempotency key for tracking.'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-create-the-get-result-tool">4. Create the Get Result Tool<a class="hash-link" href="#4-create-the-get-result-tool" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:mcp-tool GetWorkflowResultTool</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Mcp\Tools;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Models\StoredWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Contracts\JsonSchema\JsonSchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Request;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Response;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Server\Tool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\States\WorkflowCompletedStatus;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\States\WorkflowFailedStatus;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\WorkflowStub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class GetWorkflowResultTool extends Tool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $description = &lt;&lt;&lt;'MARKDOWN'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Fetch the status and, if completed, the output of a Laravel Workflow.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Use the workflow_id returned by `start_workflow` to check progress.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Once status is `WorkflowCompletedStatus`, the output field contains the result.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MARKDOWN;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function handle(Request $request): Response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $data = $request-&gt;validate([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'workflow_id' =&gt; ['required'],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflowId = $data['workflow_id'];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $stored = StoredWorkflow::find($workflowId);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (! $stored) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return Response::json([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                'found' =&gt; false,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                'message' =&gt; "Workflow {$workflowId} not found.",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow = WorkflowStub::load($workflowId);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $status = $workflow-&gt;status();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $statusName = is_object($status) ? class_basename($status) : class_basename((string) $status);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $running = $workflow-&gt;running();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $result = null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $error = null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (! $running &amp;&amp; str_contains($statusName, 'Completed')) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $result = $workflow-&gt;output();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (! $running &amp;&amp; str_contains($statusName, 'Failed')) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $exception = $stored-&gt;exceptions()-&gt;latest()-&gt;first();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $error = $exception?-&gt;exception ?? 'Unknown error';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return Response::json([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'found' =&gt; true,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'workflow_id' =&gt; $workflowId,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'status' =&gt; $statusName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'running' =&gt; $running,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'output' =&gt; $result,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'error' =&gt; $error,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'created_at' =&gt; $stored-&gt;created_at?-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'updated_at' =&gt; $stored-&gt;updated_at?-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function schema(JsonSchema $schema): array</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'workflow_id' =&gt; $schema-&gt;string()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description('The workflow ID returned by start_workflow.'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-create-the-list-workflows-tool">5. Create the List Workflows Tool<a class="hash-link" href="#5-create-the-list-workflows-tool" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan make:mcp-tool ListWorkflowsTool</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Mcp\Tools;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Models\StoredWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Contracts\JsonSchema\JsonSchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Request;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Response;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Server\Tool;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class ListWorkflowsTool extends Tool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected string $description = &lt;&lt;&lt;'MARKDOWN'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List available workflow types and optionally show recent workflow runs.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Use this to discover what workflows can be started, or to see</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        the status of recent executions.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MARKDOWN;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function handle(Request $request): Response</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $data = $request-&gt;validate([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'show_recent' =&gt; ['nullable', 'boolean'],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'limit' =&gt; ['nullable', 'integer', 'min:1', 'max:50'],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'status' =&gt; ['nullable', 'string'],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $showRecent = $data['show_recent'] ?? false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $limit = $data['limit'] ?? 10;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $statusFilter = $data['status'] ?? null;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $availableWorkflows = [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        foreach (config('workflow_mcp.workflows', []) as $key =&gt; $class) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $availableWorkflows[] = ['key' =&gt; $key, 'class' =&gt; $class];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $response = [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'available_workflows' =&gt; $availableWorkflows,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if ($showRecent) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $query = StoredWorkflow::query()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;orderBy('created_at', 'desc')</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;limit($limit);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if ($statusFilter) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $query-&gt;where('status', 'like', "%{$statusFilter}%");</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $response['recent_workflows'] = $query-&gt;get()-&gt;map(function ($w) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $status = $w-&gt;status;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $statusName = is_object($status) ? class_basename($status) : class_basename((string) $status);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    'id' =&gt; $w-&gt;id,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    'class' =&gt; $w-&gt;class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    'status' =&gt; $statusName,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    'created_at' =&gt; $w-&gt;created_at?-&gt;toIso8601String(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return Response::json($response);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function schema(JsonSchema $schema): array</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'show_recent' =&gt; $schema-&gt;boolean()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description('Include recent workflow runs in response.'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'limit' =&gt; $schema-&gt;integer()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description('Max recent workflows to return (default: 10).'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'status' =&gt; $schema-&gt;string()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                -&gt;description('Filter by status (e.g., "Completed", "Failed").'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="6-configure-available-workflows">6. Configure Available Workflows<a class="hash-link" href="#6-configure-available-workflows" title="Direct link to heading">​</a></h4><p>Create <code>config/workflow_mcp.php</code> to whitelist which workflows AI clients can start:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    'allow_fqcn' =&gt; env('WORKFLOW_MCP_ALLOW_FQCN', false),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    'workflows' =&gt; [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'simple' =&gt; App\Workflows\Simple\SimpleWorkflow::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'prism' =&gt; App\Workflows\Prism\PrismWorkflow::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This prevents arbitrary class execution. Only mapped workflows are accessible.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="7-register-the-mcp-server">7. Register the MCP Server<a class="hash-link" href="#7-register-the-mcp-server" title="Direct link to heading">​</a></h4><p>Update <code>routes/ai.php</code>:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Mcp\Servers\WorkflowServer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Laravel\Mcp\Facades\Mcp;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Mcp::web('/mcp/workflows', WorkflowServer::class);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="connecting-ai-clients">Connecting AI Clients<a class="hash-link" href="#connecting-ai-clients" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="vs-code--github-copilot">VS Code / GitHub Copilot<a class="hash-link" href="#vs-code--github-copilot" title="Direct link to heading">​</a></h4><p>Create <code>.vscode/mcp.json</code> in your project:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"servers"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"laravel-workflow"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"type"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"http"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"url"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"http://localhost/mcp/workflows"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This configuration works for both local development and GitHub Codespaces. In Codespaces, the VS Code server runs inside the container, so <code>localhost</code> correctly reaches the Laravel server without needing public ports or the <code>*.app.github.dev</code> URL.</p><p>After reloading VS Code (Cmd/Ctrl+Shift+P → "Developer: Reload Window"), Copilot can use the workflow tools directly in chat.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="real-world-usage">Real-World Usage<a class="hash-link" href="#real-world-usage" title="Direct link to heading">​</a></h3><p>Once connected, you can have natural conversations with your AI assistant:</p><blockquote><p><strong>You:</strong> "What workflows are available?"</p><p><strong>AI:</strong> <em>calls list_workflows</em> "I found 2 workflows: <code>simple</code> and <code>prism</code>."</p></blockquote><blockquote><p><strong>You:</strong> "Start the prism workflow"</p><p><strong>AI:</strong> <em>calls start_workflow</em> "Started workflow ID 42. I'll check its status."</p></blockquote><blockquote><p><strong>AI:</strong> <em>calls get_workflow_result</em> "The workflow completed! Here's the generated user profile: { name: 'Elena', hobbies: <!-- -->[...]<!-- --> }"</p></blockquote><p>This creates a seamless experience where AI assistants can orchestrate complex, long-running operations while keeping the user informed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-makes-this-pattern-powerful">What Makes This Pattern Powerful<a class="hash-link" href="#what-makes-this-pattern-powerful" title="Direct link to heading">​</a></h3><ul><li><strong>Durability</strong>: Workflows survive server restarts and network failures</li><li><strong>Async by design</strong>: AI clients don't block waiting for completion</li><li><strong>Observable</strong>: Every workflow is tracked in Waterline's dashboard</li><li><strong>Secure</strong>: Whitelist-based workflow access prevents arbitrary execution</li><li><strong>Stateless MCP</strong>: The server holds no state. Clients track workflow IDs</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="try-it-now-in-your-browser">Try It Now in Your Browser<a class="hash-link" href="#try-it-now-in-your-browser" title="Direct link to heading">​</a></h3><p>This MCP integration is included and pre-configured in the Laravel Workflow <a href="https://github.com/laravel-workflow/sample-app" target="_blank" rel="noopener noreferrer">Sample App</a>.</p><p>To try it:</p><ol><li>Open the sample-app repo on GitHub</li><li>Click <strong>Code</strong> → <strong>Codespaces</strong> → <strong>Create codespace on main</strong></li><li>Wait for the environment to build</li><li>Setup the app and start the queue worker:<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan app:init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan queue:work</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>Enable the Laravel Workflow Server MCP tools</li><li>Ask your AI to list and run workflows!</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="where-to-go-from-here">Where to Go From Here<a class="hash-link" href="#where-to-go-from-here" title="Direct link to heading">​</a></h3><p>You can extend this pattern to:</p><ul><li><strong>Parameterized workflows</strong>: Pass user input to workflow arguments</li><li><strong>Webhook notifications</strong>: Push completion events instead of polling</li><li><strong>Workflow signals</strong>: Let AI clients send signals to waiting workflows</li><li><strong>Progress streaming</strong>: Use SSE to stream workflow progress in real-time</li><li><strong>Multi-step agents</strong>: Chain multiple workflows together in a conversation</li></ul><p>The combination of Laravel Workflow's durable execution and MCP's tool protocol creates a foundation for truly capable AI agents that can handle real-world complexity.</p>]]></content:encoded>
            <category>ai</category>
            <category>workflow</category>
            <category>mcp</category>
            <category>agents</category>
            <category>tools</category>
        </item>
        <item>
            <title><![CDATA[Building Reliable Agentic Loops with Laravel Workflow and PrismPHP]]></title>
            <link>https://laravel-workflow.com/blog/building-reliable-agentic-loops-with-laravel-workflow-and-prismphp</link>
            <guid>building-reliable-agentic-loops-with-laravel-workflow-and-prismphp</guid>
            <pubDate>Thu, 10 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[captionless image]]></description>
            <content:encoded><![CDATA[<p><img loading="lazy" src="https://raw.githubusercontent.com/prism-php/prism/main/assets/prism-logo.webp" alt="captionless image" class="img_ev3q"></p><p>Laravel Workflow is a powerful tool for orchestrating long-running, stateful workflows in PHP. Paired with <a href="https://prismphp.com/" target="_blank" rel="noopener noreferrer">PrismPHP</a>, it becomes a compelling foundation for building reliable AI agents that not only generate structured data but verify and retry until results meet strict real-world constraints.</p><p>In this post, we’ll show how to use Laravel Workflow + Prism to create an agentic loop that:</p><ul><li>Generates structured data using an LLM</li><li>Validates the result against custom rules</li><li>Retries automatically until the result passes</li></ul><p>You can try this exact workflow right now in your browser with no setup or coding required. Just click the button in the Laravel Workflow <a href="https://github.com/laravel-workflow/sample-app" target="_blank" rel="noopener noreferrer">Sample App</a> and launch a GitHub Codespace to run it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-were-building">What We’re Building<a class="hash-link" href="#what-were-building" title="Direct link to heading">​</a></h3><p>We’ll create a workflow that asks an LLM to generate a user profile with hobbies. Then we’ll validate that:</p><ul><li>The name is present</li><li>At least one hobby is defined</li><li>The name starts with a vowel</li></ul><p>If the result fails validation, we loop back to the LLM and regenerate. All of this is durable, asynchronous, and tracked through stateful events.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-example">Step-by-Step Example<a class="hash-link" href="#step-by-step-example" title="Direct link to heading">​</a></h3><ol><li>Console Command to Trigger the Workflow</li></ol><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Workflows\Prism\PrismWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Console\Command;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\WorkflowStub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class Prism extends Command</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected $signature = 'app:prism';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected $description = 'Runs a Prism AI workflow';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function handle()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow = WorkflowStub::make(PrismWorkflow::class);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow-&gt;start();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        while ($workflow-&gt;running());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $user = $workflow-&gt;output();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;info('Generated User:');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;info(json_encode($user, JSON_PRETTY_PRINT));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Define the Workflow Logic</li></ol><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class PrismWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        do {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $user = yield activity(GenerateUserActivity::class);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $valid = yield activity(ValidateUserActivity::class, $user);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } while (!$valid);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $user;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is a classic agent loop. If validation fails, we prompt again automatically.</p><ol start="3"><li>Generate Structured User Data with PrismPHP</li></ol><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Prism\Prism\Prism;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Prism\Prism\Enums\Provider;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Prism\Prism\Schema\ArraySchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Prism\Prism\Schema\ObjectSchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Prism\Prism\Schema\StringSchema;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class GenerateUserActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $schema = new ObjectSchema(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            name: 'user',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            description: 'A user profile with their hobbies',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            properties: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new StringSchema('name', 'The user\'s full name'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new ArraySchema(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    name: 'hobbies',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    description: 'The user\'s list of hobbies',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    items: new ObjectSchema(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        name: 'hobby',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        description: 'A detailed hobby entry',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        properties: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                            new StringSchema('name', 'The name of the hobby'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                            new StringSchema('description', 'A brief description of the hobby'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        requiredFields: ['name', 'description']</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                ),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            requiredFields: ['name', 'hobbies']</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $response = Prism::structured()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;using(Provider::OpenAI, 'gpt-4o')</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;withSchema($schema)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;withPrompt('Use names from many languages and vary first initials.')</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;asStructured();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $response-&gt;structured;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>Validate Business Logic</li></ol><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class ValidateUserActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($user)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (empty($user['name']) || !is_array($user['hobbies']) || count($user['hobbies']) === 0) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        foreach ($user['hobbies'] as $hobby) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (empty($hobby['name']) || empty($hobby['description'])) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                return false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // Extra Validation: The user's name must start with a vowel.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (!in_array(strtoupper($user['name'][0]), ['A', 'E', 'I', 'O', 'U'])) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return true;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-makes-this-pattern-powerful">What Makes This Pattern Powerful<a class="hash-link" href="#what-makes-this-pattern-powerful" title="Direct link to heading">​</a></h3><p>This design pattern is what you’d call a reliable agentic loop:</p><ul><li>LLM generation via Prism</li><li>Validation &amp; retry via Laravel Workflow</li><li>State persistence for crash recovery or inspection</li><li>Observability via Waterline</li></ul><p>It’s perfect for AI applications where accuracy, safety, and traceability are required.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="try-it-now-in-your-browser">Try It Now in Your Browser<a class="hash-link" href="#try-it-now-in-your-browser" title="Direct link to heading">​</a></h3><p>We’ve bundled this workflow into the official Laravel Workflow <a href="https://github.com/laravel-workflow/sample-app" target="_blank" rel="noopener noreferrer">Sample App</a>.</p><p>To try it:</p><ol><li>Open the sample-app repo on GitHub</li><li>Click <strong>Code</strong> → <strong>Codespaces</strong> → <strong>Create codespace on main</strong></li><li>Wait for the environment to build</li><li>Set your OPENAI_API_KEY in the .env</li><li>Setup the app and start the queue worker:<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan app:init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan queue:work</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>In a second terminal:</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan app:prism</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You will see the queue working and eventually see the validated output.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="where-to-go-from-here">Where to Go From Here<a class="hash-link" href="#where-to-go-from-here" title="Direct link to heading">​</a></h3><p>You can easily adapt this pattern to:</p><ul><li>AI agents for form filling</li><li>Data scraping and validation</li><li>Content generation with retry policies</li><li>Moderation and review queues</li></ul><p>Each step remains reliable and traceable thanks to Laravel Workflow’s durable execution model.</p>]]></content:encoded>
            <category>ai</category>
            <category>workflow</category>
            <category>agents</category>
            <category>agentic</category>
        </item>
        <item>
            <title><![CDATA[Automating QA with Playwright and Laravel Workflow]]></title>
            <link>https://laravel-workflow.com/blog/automating-qa-with-playwright-and-laravel-workflow</link>
            <guid>automating-qa-with-playwright-and-laravel-workflow</guid>
            <pubDate>Fri, 07 Feb 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[playwright]]></description>
            <content:encoded><![CDATA[<p><img loading="lazy" src="https://miro.medium.com/v2/resize:fit:300/format:webp/1*b6eXVs5J3aRNzYAiqnS9Vw.png" alt="playwright" class="img_ev3q"></p><p>Have you ever spent hours tracking down a frontend bug that only happens in production? When working with web applications, debugging frontend issues can be challenging. Console errors and unexpected UI behaviors often require careful inspection and reproducible test cases. Wouldn’t it be great if you could automate this process, capture errors, and even record a video of the session for later analysis?</p><p>With <strong>Playwright</strong> and <strong>Laravel Workflow</strong>, you can achieve just that! In this post, I’ll walk you through an automated workflow that:</p><ul><li>Loads a webpage and captures console errors.</li><li>Records a video of the session.</li><li>Converts the video to an MP4 format for easy sharing.</li><li>Runs seamlessly in a <strong>GitHub Codespace</strong>.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-stack">The Stack<a class="hash-link" href="#the-stack" title="Direct link to heading">​</a></h2><ul><li><strong>Playwright</strong>: A powerful browser automation tool for testing web applications.</li><li><strong>Laravel Workflow</strong>: A durable workflow engine for handling long-running, distributed processes.</li><li><strong>FFmpeg</strong>: Used to convert Playwright’s WebM recordings to MP4 format.</li></ul><div class="themedImageWrapper_nM_G"><div class="lightImage_srvP"><a href="https://mermaid.live/edit#pako:eNpNkl1v0zAUhv_K0bngKhtNSdYmQkMsbbZJFKYVMUHSC68-TS0SO3LtbqPtf8d2mMadj5_3PV86B1wrTpjjplVP6y3TBr7PagnwuVoaHz0o_duzFZydXcJVdW8l3LXs5UmLZmtgudaiN6taes-V1xwL1hurCQold6olmGut9O4IxWF4Qams5J9O3lEEx09yeFZ9Uc0_8eqNfVVHmFculxHSUgCz0EpZvbbmKnV9S2ag84H-39E9rZXm8ENwctmuqyXbEzzQ4wJK0Q6u6-C68YX25Mf21ChY3CWwF-zjo35_WZZdT02Q3wT5rduRcpO-g2_W9NZ4dcC3Qw8YYaMFx9xoSxF2pDvmQzx4UY1mSx3VmLsnpw2zramxlidn65n8pVT36tTKNlvMN6zducj2nBmaCdZo9iYhyUkXbrUG8yxkwPyAz5gno-w8i9M4HiXpeJpNxkmEL-774nw6SbJJOk3H8YeLSZycIvwTio4cSSMkLtx4i-E-wpmc_gKg97DW" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNpNkl1v0zAUhv_K0bngKhtNSdYmQkMsbbZJFKYVMUHSC68-TS0SO3LtbqPtf8d2mMadj5_3PV86B1wrTpjjplVP6y3TBr7PagnwuVoaHz0o_duzFZydXcJVdW8l3LXs5UmLZmtgudaiN6taes-V1xwL1hurCQold6olmGut9O4IxWF4Qams5J9O3lEEx09yeFZ9Uc0_8eqNfVVHmFculxHSUgCz0EpZvbbmKnV9S2ag84H-39E9rZXm8ENwctmuqyXbEzzQ4wJK0Q6u6-C68YX25Mf21ChY3CWwF-zjo35_WZZdT02Q3wT5rduRcpO-g2_W9NZ4dcC3Qw8YYaMFx9xoSxF2pDvmQzx4UY1mSx3VmLsnpw2zramxlidn65n8pVT36tTKNlvMN6zducj2nBmaCdZo9iYhyUkXbrUG8yxkwPyAz5gno-w8i9M4HiXpeJpNxkmEL-774nw6SbJJOk3H8YeLSZycIvwTio4cSSMkLtx4i-E-wpmc_gKg97DW?type=png" alt="Playwright QA Workflow Diagram"></a></div><div class="darkImage_qlOL"><a href="https://mermaid.live/edit#pako:eNpNkl1P2zAUhv-KdS52FbrWNMGNEBOkDSDRDVEE2pJemOaQWiR25NoF1va_z3Zg252Pn_c9Xzo7WKkKIYXnRr2u1lwbcj8tJSHnxcL46FHpF8-W5OjojFwUd1aS24a_v2pRrw1ZrLTozLKU3nPhNfuMd8ZqJJmSG9UgmWmt9GZPsl3_Irmysvp28I4sOH6iw9PiRtUf4uU_9l3tyaxwuYyQFgOYhlby4rM1V6ntGjQ9nfX0_47ucKV0RR5EhS7bZbHgWySP-DQnuWh612VwXflCW_Rje2oUmd-OyVbw0yf99SzP2w7rIL8K8mu3I-Um_UJ-WNNZ49UBX_c9QAS1FhWkRluMoEXdch_CzotKMGtssYTUPSuuX0oo5cF5Oi5_KdV-2rSy9RrSZ95sXGS7ihucCl5r3v791Sgr1JlbrIGUxiEHpDt4g3SUxIPkhMUnI0bj4YQNkwjenYglg2QcJ2wypkMW0_j4EMHvUHY4iMfHE8omdEQpTVjCIsBKuFHn_a2Ekzn8AZMbsr4" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNpNkl1P2zAUhv-KdS52FbrWNMGNEBOkDSDRDVEE2pJemOaQWiR25NoF1va_z3Zg252Pn_c9Xzo7WKkKIYXnRr2u1lwbcj8tJSHnxcL46FHpF8-W5OjojFwUd1aS24a_v2pRrw1ZrLTozLKU3nPhNfuMd8ZqJJmSG9UgmWmt9GZPsl3_Irmysvp28I4sOH6iw9PiRtUf4uU_9l3tyaxwuYyQFgOYhlby4rM1V6ntGjQ9nfX0_47ucKV0RR5EhS7bZbHgWySP-DQnuWh612VwXflCW_Rje2oUmd-OyVbw0yf99SzP2w7rIL8K8mu3I-Um_UJ-WNNZ49UBX_c9QAS1FhWkRluMoEXdch_CzotKMGtssYTUPSuuX0oo5cF5Oi5_KdV-2rSy9RrSZ95sXGS7ihucCl5r3v791Sgr1JlbrIGUxiEHpDt4g3SUxIPkhMUnI0bj4YQNkwjenYglg2QcJ2wypkMW0_j4EMHvUHY4iMfHE8omdEQpTVjCIsBKuFHn_a2Ekzn8AZMbsr4?type=png" alt="Playwright QA Workflow Diagram"></a></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-capturing-errors-and-video-with-playwright">1. Capturing Errors and Video with Playwright<a class="hash-link" href="#1-capturing-errors-and-video-with-playwright" title="Direct link to heading">​</a></h4><p>The Playwright script automates a browser session, navigates to a given URL, and logs any console errors. It also records a video of the entire session.</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token imports"> chromium </span><span class="token imports punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'playwright'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token imports">path</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'path'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token imports">fs</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'fs'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> url </span><span class="token operator">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">argv</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> videoDir </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'./videos'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token plain">fs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">existsSync</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">videoDir</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">mkdirSync</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">videoDir</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">recursive</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> browser </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> chromium</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">launch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">args</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'--no-sandbox'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> context </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> browser</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">newContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token literal-property property">recordVideo</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">dir</span><span class="token operator">:</span><span class="token plain"> videoDir </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> page </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">newPage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> errors </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    page</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'console'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token parameter">msg</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'error'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            errors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> page</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">goto</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">waitUntil</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'networkidle'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token literal-property property">timeout</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        errors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token template-string string" style="color:rgb(255, 121, 198)">Page load error: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token template-string interpolation">error</span><span class="token template-string interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token template-string interpolation property-access">message</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> video </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> page</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">video</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> browser</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">stringify</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> errors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> video </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-running-the-workflow">2. Running the Workflow<a class="hash-link" href="#2-running-the-workflow" title="Direct link to heading">​</a></h4><p>A Laravel console command (<code>php artisan app:playwright</code>) starts the workflow which:</p><ul><li>Runs the Playwright script and collects errors.</li><li>Converts the video from <code>.webm</code> to <code>.mp4</code> using FFmpeg.</li><li>Returns the errors and the final video file path.</li></ul><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Console\Commands;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Workflows\Playwright\CheckConsoleErrorsWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Console\Command;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\WorkflowStub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class Playwright extends Command</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected $signature = 'app:playwright';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected $description = 'Runs a playwright workflow';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function handle()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow = WorkflowStub::make(CheckConsoleErrorsWorkflow::class);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow-&gt;start('https://example.com');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        while ($workflow-&gt;running());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;info($workflow-&gt;output()['mp4']);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-the-workflow">3. The Workflow<a class="hash-link" href="#3-the-workflow" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\Playwright;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class CheckConsoleErrorsWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute(string $url)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $result = yield activity(CheckConsoleErrorsActivity::class, $url);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $mp4 = yield activity(ConvertVideoActivity::class, $result['video']);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'errors' =&gt; $result['errors'],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'mp4' =&gt; $mp4,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-running-playwright">4. Running Playwright<a class="hash-link" href="#4-running-playwright" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\Playwright;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Process;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class CheckConsoleErrorsActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute(string $url)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $result = Process::run([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'node', base_path('playwright-script.js'), $url</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ])-&gt;throw();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return json_decode($result-&gt;output(), true);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-video-conversion-with-ffmpeg">5. Video Conversion with FFmpeg<a class="hash-link" href="#5-video-conversion-with-ffmpeg" title="Direct link to heading">​</a></h4><p>The Playwright recording is stored in WebM format, but we need an MP4 for wider compatibility. Laravel Workflow runs this process asynchronously.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\Playwright;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Process;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class ConvertVideoActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute(string $webm)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $mp4 = str_replace('.webm', '.mp4', $webm);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Process::run([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'ffmpeg', '-i', $webm, '-c:v', 'libx264', '-preset', 'fast', '-crf', '23', '-c:a', 'aac', '-b:a', '128k', $mp4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ])-&gt;throw();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        unlink($webm);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $mp4;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="try-it-now-in-your-browser">Try It Now in Your Browser<a class="hash-link" href="#try-it-now-in-your-browser" title="Direct link to heading">​</a></h2><p>You don’t need to set up anything on your local machine. Everything is already configured in the Laravel Workflow <a href="https://github.com/laravel-workflow/sample-app" target="_blank" rel="noopener noreferrer">Sample App</a>.</p><p>To try it:</p><ol><li>Open the sample-app repo on GitHub</li><li>Click <strong>Code</strong> → <strong>Codespaces</strong> → <strong>Create codespace on main</strong></li><li>Wait for the environment to build</li><li>Setup the app and start the queue worker:<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan app:init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan queue:work</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>In a second terminal:</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan app:playwright</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That’s it! The workflow will execute, capture console errors, record a video, and convert it to MP4. You can find the video in the videos folder. Take a look at the sample app’s README.md for more information on other workflows and how to view the Waterline UI.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>By integrating Playwright with Laravel Workflow, we’ve automated frontend error detection and debugging. This setup allows teams to quickly identify and resolve issues, all while leveraging Laravel’s queue system to run tasks asynchronously.</p>]]></content:encoded>
            <category>playwright</category>
            <category>workflow</category>
            <category>automation</category>
            <category>qa</category>
            <category>testing</category>
        </item>
        <item>
            <title><![CDATA[Extending Laravel Workflow to Support Spatie Laravel Tags]]></title>
            <link>https://laravel-workflow.com/blog/extending-laravel-workflow-to-support-spatie-laravel-tags</link>
            <guid>extending-laravel-workflow-to-support-spatie-laravel-tags</guid>
            <pubDate>Mon, 28 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[One of the strengths of the Laravel ecosystem is its flexibility, thanks to a myriad of community-driven packages that enhance the framework’s capabilities. The laravel-workflow and spatie/laravel-tags packages are two such examples, and in this post, we'll integrate them together to make workflows taggable.]]></description>
            <content:encoded><![CDATA[<p>One of the strengths of the Laravel ecosystem is its flexibility, thanks to a myriad of community-driven packages that enhance the framework’s capabilities. The <code>laravel-workflow</code> and <code>spatie/laravel-tags</code> packages are two such examples, and in this post, we'll integrate them together to make workflows taggable.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installation-instructions">Installation Instructions<a class="hash-link" href="#installation-instructions" title="Direct link to heading">​</a></h2><p>Before diving into the code, let’s ensure both libraries are properly installed:</p><ol><li>Install <a href="https://github.com/laravel-workflow/laravel-workflow" target="_blank" rel="noopener noreferrer">Laravel Workflow</a> and <a href="https://github.com/spatie/laravel-tags" target="_blank" rel="noopener noreferrer">Spatie Laravel Tags</a>.</li></ol><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">composer require laravel-workflow/laravel-workflow spatie/laravel-tags</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Both packages include migrations that must be published.</li></ol><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan vendor:publish --provider="Workflow\Providers\WorkflowServiceProvider" --tag="migrations"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan vendor:publish --provider="Spatie\Tags\TagsServiceProvider" --tag="tags-migrations"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>Run the migrations.</li></ol><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan migrate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="publishing-configuration">Publishing Configuration<a class="hash-link" href="#publishing-configuration" title="Direct link to heading">​</a></h2><p>To extend Laravel Workflow, publish its configuration file:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan vendor:publish --provider="Workflow\Providers\WorkflowServiceProvider" --tag="config"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="extending-workflows-to-support-tags">Extending Workflows to Support Tags<a class="hash-link" href="#extending-workflows-to-support-tags" title="Direct link to heading">​</a></h2><p>We need to extend the <code>StoredWorkflow</code> model of <code>laravel-workflow</code> to support tagging.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Models;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Spatie\Tags\HasTags;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Models\StoredWorkflow as BaseStoredWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\WorkflowStub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class StoredWorkflow extends BaseStoredWorkflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    use HasTags;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static function tag(WorkflowStub $workflow, $tag): void</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $storedWorkflow = static::find($workflow-&gt;id());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if ($storedWorkflow) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $storedWorkflow-&gt;attachTag($tag);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public static function findByTag($tag): ?WorkflowStub</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $storedWorkflow = static::withAnyTags([$tag])-&gt;first();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if ($storedWorkflow) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return WorkflowStub::fromStoredWorkflow($storedWorkflow);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="modify-the-configuration">Modify the Configuration<a class="hash-link" href="#modify-the-configuration" title="Direct link to heading">​</a></h2><p>In <code>config/workflow.php</code>, update this line:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">'stored_workflow_model' =&gt; Workflow\Models\StoredWorkflow::class,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">'stored_workflow_model' =&gt; App\Models\StoredWorkflow::class,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This ensures Laravel Workflow uses the extended model.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-tagged-workflows">Running Tagged Workflows<a class="hash-link" href="#running-tagged-workflows" title="Direct link to heading">​</a></h2><p>With the taggable <code>StoredWorkflow</code> ready, create a console command to create, tag, retrieve, and run a workflow.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Console\Commands;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Models\StoredWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Workflows\Simple\SimpleWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Console\Command;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\WorkflowStub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class Workflow extends Command</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected $signature = 'workflow';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected $description = 'Runs a workflow';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function handle()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // Create a workflow and tag it</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow = WorkflowStub::make(SimpleWorkflow::class);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        StoredWorkflow::tag($workflow, 'tag1');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // Find the workflow by tag and start it</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow = StoredWorkflow::findByTag('tag1');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow-&gt;start();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        while ($workflow-&gt;running());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;info($workflow-&gt;output());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>By integrating <code>laravel-workflow</code> with <code>spatie/laravel-tags</code>, we've enabled tagging for workflows, making management more intuitive in larger applications. Thanks to Laravel’s extensible nature, endless possibilities await developers leveraging these powerful packages.</p>]]></content:encoded>
            <category>laravel</category>
            <category>workflow</category>
            <category>spatie</category>
            <category>tags</category>
            <category>automation</category>
        </item>
        <item>
            <title><![CDATA[AI Image Moderation with Laravel Workflow]]></title>
            <link>https://laravel-workflow.com/blog/ai-image-moderation-with-laravel-workflow</link>
            <guid>ai-image-moderation-with-laravel-workflow</guid>
            <pubDate>Sun, 20 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Before we begin, let’s understand the scenario. We are building an image moderation system where:]]></description>
            <content:encoded><![CDATA[<p>Before we begin, let’s understand the scenario. We are building an image moderation system where:</p><ol><li>Every image undergoes an initial AI check to determine if it’s safe.</li><li>If the AI deems the image unsafe, it’s automatically logged and deleted.</li><li>If it’s potentially safe, a human moderator is alerted to further review the image. They have the option to approve or reject the image.</li><li>Approved images are moved to a public location, whereas rejected images are deleted.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="laravel-workflow">Laravel Workflow<a class="hash-link" href="#laravel-workflow" title="Direct link to heading">​</a></h2><p>Laravel Workflow is designed to streamline and organize complex processes in applications. It allows developers to define, manage, and execute workflows seamlessly. You can find installation instructions <a href="https://github.com/laravel-workflow/laravel-workflow" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clarifai-api">ClarifAI API<a class="hash-link" href="#clarifai-api" title="Direct link to heading">​</a></h2><p>ClarifAI provides AI-powered moderation tools for analyzing visual content. They offer a <a href="https://www.clarifai.com/pricing" target="_blank" rel="noopener noreferrer">free plan</a> with up to 1,000 actions per month.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-store-your-credentials-in-env">1. Store your credentials in <code>.env</code>.<a class="hash-link" href="#1-store-your-credentials-in-env" title="Direct link to heading">​</a></h4><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CLARIFAI_API_KEY=key</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CLARIFAI_APP=my-application</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CLARIFAI_WORKFLOW=my-workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CLARIFAI_USER=username</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-add-the-service-to-configservicesphp">2. Add the service to <code>config/services.php</code>.<a class="hash-link" href="#2-add-the-service-to-configservicesphp" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">'clarifai' =&gt; [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    'api_key' =&gt; env('CLARIFAI_API_KEY'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    'app' =&gt; env('CLARIFAI_APP'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    'workflow' =&gt; env('CLARIFAI_WORKFLOW'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    'user' =&gt; env('CLARIFAI_USER'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">],</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-create-a-service-at-appservicesclarifaiphp">3. Create a service at <code>app/Services/ClarifAI.php</code>.<a class="hash-link" href="#3-create-a-service-at-appservicesclarifaiphp" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Services;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Http;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class ClarifAI</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private $apiKey;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private $apiUrl;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function __construct()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $app = config('services.clarifai.app');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $workflow = config('services.clarifai.workflow');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $user = config('services.clarifai.user');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;apiKey = config('services.clarifai.api_key');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;apiUrl = "https://api.clarifai.com/v2/users/{$user}/apps/{$app}/workflows/{$workflow}/results/";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function checkImage(string $image): bool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $response = Http::withToken($this-&gt;apiKey, 'Key')</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;post($this-&gt;apiUrl, ['inputs' =&gt; [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                ['data' =&gt; ['image' =&gt; ['base64' =&gt; base64_encode($image)]]],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ]]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return collect($response-&gt;json('results.0.outputs.0.data.concepts', []))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;filter(fn ($value) =&gt; $value['name'] === 'safe')</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;map(fn ($value) =&gt; round((float) $value['value']) &gt; 0)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;first() ?? false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-the-workflow">Creating the Workflow<a class="hash-link" href="#creating-the-workflow" title="Direct link to heading">​</a></h2><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\SignalMethod;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\{activity, all, awaitWithTimeout};</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class ImageModerationWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private bool $approved = false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private bool $rejected = false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #[SignalMethod]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function approve()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;approved = true;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #[SignalMethod]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function reject()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;rejected = true;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($imagePath)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $safe = yield from $this-&gt;check($imagePath);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (! $safe) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            yield from $this-&gt;unsafe($imagePath);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return 'unsafe';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        yield from $this-&gt;moderate($imagePath);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $this-&gt;approved ? 'approved' : 'rejected';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private function check($imagePath)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return yield activity(AutomatedImageCheckActivity::class, $imagePath);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private function unsafe($imagePath)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        yield all([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            activity(LogUnsafeImageActivity::class, $imagePath),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            activity(DeleteImageActivity::class, $imagePath),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private function moderate($imagePath)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            yield activity(NotifyImageModeratorActivity::class, $imagePath);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $signaled = yield awaitWithTimeout('24 hours', fn () =&gt; $this-&gt;approved || $this-&gt;rejected);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if ($signaled) break;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="activities">Activities<a class="hash-link" href="#activities" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="automated-image-check">Automated Image Check<a class="hash-link" href="#automated-image-check" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Services\ClarifAI;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Storage;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class AutomatedImageCheckActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($imagePath)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return app(ClarifAI::class)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;checkImage(Storage::get($imagePath));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="logging-unsafe-images">Logging Unsafe Images<a class="hash-link" href="#logging-unsafe-images" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Log;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class LogUnsafeImageActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($imagePath)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Log::info('Unsafe image detected at: ' . $imagePath);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deleting-images">Deleting Images<a class="hash-link" href="#deleting-images" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Storage;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class DeleteImageActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($imagePath)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Storage::delete($imagePath);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="starting-and-signaling-the-workflow">Starting and Signaling the Workflow<a class="hash-link" href="#starting-and-signaling-the-workflow" title="Direct link to heading">​</a></h2><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow = WorkflowStub::make(ImageModerationWorkflow::class);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow-&gt;start('tmp/good.jpg');</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For approvals or rejections:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow = WorkflowStub::load($id);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow-&gt;approve();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// or</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow-&gt;reject();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p><a href="https://github.com/laravel-workflow/laravel-workflow" target="_blank" rel="noopener noreferrer">Laravel Workflow</a> provides a structured approach to handle complex processes like image moderation. It supports asynchronous processing, external API integrations, and modular design for scalability. Thanks for reading!</p>]]></content:encoded>
            <category>ai</category>
            <category>image-moderation</category>
            <category>workflow</category>
            <category>automation</category>
        </item>
        <item>
            <title><![CDATA[Microservice Communication with Laravel Workflow]]></title>
            <link>https://laravel-workflow.com/blog/microservice-communication-with-laravel-workflow</link>
            <guid>microservice-communication-with-laravel-workflow</guid>
            <pubDate>Fri, 18 Aug 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[In the evolving landscape of microservices, communication has always been a focal point. Microservices can interact in various ways, be it through HTTP/REST calls, using messaging protocols like RabbitMQ or Kafka, or even employing more recent technologies like gRPC. Yet, regardless of the communication method, the goal remains the same: seamless, efficient, and robust interactions. Today, we’ll explore how Laravel Workflow can fit into this picture and optimize the communication between microservices in a unique way.]]></description>
            <content:encoded><![CDATA[<p>In the evolving landscape of microservices, communication has always been a focal point. Microservices can interact in various ways, be it through HTTP/REST calls, using messaging protocols like RabbitMQ or Kafka, or even employing more recent technologies like gRPC. Yet, regardless of the communication method, the goal remains the same: seamless, efficient, and robust interactions. Today, we’ll explore how Laravel Workflow can fit into this picture and optimize the communication between microservices in a unique way.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-challenge">The Challenge<a class="hash-link" href="#the-challenge" title="Direct link to heading">​</a></h2><p>In a microservices architecture, decoupling is the name of the game. You want each service to have a single responsibility, to be maintainable, and to be independently deployable. Yet, in the world of workflows, this becomes challenging. How do you split a workflow from its activity and yet ensure they communicate seamlessly?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="laravel-workflow-to-the-rescue">Laravel Workflow to the Rescue!<a class="hash-link" href="#laravel-workflow-to-the-rescue" title="Direct link to heading">​</a></h2><p><a href="https://github.com/laravel-workflow/laravel-workflow" target="_blank" rel="noopener noreferrer">Laravel Workflow</a> handles the discovery and orchestration for you! With a shared database and queue connection, you can have your workflow in one Laravel app and its activity logic in another.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="defining-workflows-and-activities">Defining Workflows and Activities<a class="hash-link" href="#defining-workflows-and-activities" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-create-a-workflow">1. Create a workflow.<a class="hash-link" href="#1-create-a-workflow" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class MyWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($name)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $result = yield activity(MyActivity::class, $name);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $result;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-create-an-activity">2. Create an activity.<a class="hash-link" href="#2-create-an-activity" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class MyActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($name)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return "Hello, {$name}!";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-run-the-workflow">3. Run the workflow.<a class="hash-link" href="#3-run-the-workflow" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\WorkflowStub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow = WorkflowStub::make(MyWorkflow::class);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow-&gt;start('world');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">while ($workflow-&gt;running());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow-&gt;output();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Output: 'Hello, world!'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The workflow will manage the activity and handle any failures, retries, etc. Think of workflows like job chaining on steroids because you can have conditional logic, loops, return a result that can be used in the next activity, and write everything in typical PHP code that is failure tolerant.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="balancing-shared-and-dedicated-resources">Balancing Shared and Dedicated Resources<a class="hash-link" href="#balancing-shared-and-dedicated-resources" title="Direct link to heading">​</a></h2><p>When working with microservices, it’s common for each service to have its dedicated resources, such as databases, caches, and queues. However, to facilitate communication between workflows and activities across services, a shared connection (like a database or queue) becomes essential. This shared connection acts as a bridge for data and task exchanges while ensuring:</p><ol><li><strong>Isolation</strong>: Dedicated resources prevent cascading failures.</li><li><strong>Performance</strong>: Each service can be optimized independently.</li><li><strong>Security</strong>: Isolation limits potential attack vectors.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-by-step-integration">Step-By-Step Integration<a class="hash-link" href="#step-by-step-integration" title="Direct link to heading">​</a></h2><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-install-laravel-workflow-in-all-microservices">1. Install <code>laravel-workflow</code> in all microservices.<a class="hash-link" href="#1-install-laravel-workflow-in-all-microservices" title="Direct link to heading">​</a></h4><p>Follow the <a href="https://laravel-workflow.com/docs/installation/" target="_blank" rel="noopener noreferrer">installation guide</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-create-a-shared-databaseredis-connection-in-all-microservices">2. Create a shared database/redis connection in all microservices.<a class="hash-link" href="#2-create-a-shared-databaseredis-connection-in-all-microservices" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// config/database.php</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">'connections' =&gt; [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    'shared' =&gt; [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'driver' =&gt; 'mysql',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'host' =&gt; env('SHARED_DB_HOST', '127.0.0.1'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'database' =&gt; env('SHARED_DB_DATABASE', 'forge'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'username' =&gt; env('SHARED_DB_USERNAME', 'forge'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'password' =&gt; env('SHARED_DB_PASSWORD', ''),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">],</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-configure-a-shared-queue-connection">3. Configure a shared queue connection.<a class="hash-link" href="#3-configure-a-shared-queue-connection" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// config/queue.php</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">'connections' =&gt; [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    'shared' =&gt; [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'driver' =&gt; 'redis',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'connection' =&gt; 'shared',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'queue' =&gt; env('SHARED_REDIS_QUEUE', 'default'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">],</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-ensure-only-one-microservice-publishes-laravel-workflow-migrations">4. Ensure only one microservice publishes Laravel Workflow migrations.<a class="hash-link" href="#4-ensure-only-one-microservice-publishes-laravel-workflow-migrations" title="Direct link to heading">​</a></h4><p>Update the migration to use the shared database connection.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// database/migrations/..._create_workflows_table.php</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class CreateWorkflowsTable extends Migration</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected $connection = 'shared';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-extend-workflow-models-in-each-microservice-to-use-the-shared-connection">5. Extend workflow models in each microservice to use the shared connection.<a class="hash-link" href="#5-extend-workflow-models-in-each-microservice-to-use-the-shared-connection" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// app/Models/StoredWorkflow.php</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Models;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Models\StoredWorkflow as BaseStoredWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class StoredWorkflow extends BaseStoredWorkflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protected $connection = 'shared';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="6-publish-laravel-workflow-config-and-update-it-with-shared-models">6. Publish Laravel Workflow config and update it with shared models.<a class="hash-link" href="#6-publish-laravel-workflow-config-and-update-it-with-shared-models" title="Direct link to heading">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan vendor:publish --provider="Workflow\Providers\WorkflowServiceProvider" --tag="config"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="7-set-workflows-and-activities-to-use-the-shared-queue">7. Set workflows and activities to use the shared queue.<a class="hash-link" href="#7-set-workflows-and-activities-to-use-the-shared-queue" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// app/Workflows/MyWorkflow.php</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class MyWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $connection = 'shared';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $queue = 'workflow';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// app/Workflows/MyActivity.php</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class MyActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $connection = 'shared';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $queue = 'activity';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="8-ensure-microservices-define-empty-counterparts-for-workflow-and-activity-classes">8. Ensure microservices define empty counterparts for workflow and activity classes.<a class="hash-link" href="#8-ensure-microservices-define-empty-counterparts-for-workflow-and-activity-classes" title="Direct link to heading">​</a></h4><h4 class="anchor anchorWithStickyNavbar_LWe7" id="in-the-workflow-microservice">In the workflow microservice:<a class="hash-link" href="#in-the-workflow-microservice" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">class MyWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $connection = 'shared';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $queue = 'workflow';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($name)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        yield activity(MyActivity::class, $name);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class MyActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $connection = 'shared';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $queue = 'activity';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="in-the-activity-microservice">In the activity microservice:<a class="hash-link" href="#in-the-activity-microservice" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">class MyWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $connection = 'shared';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $queue = 'workflow';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class MyActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $connection = 'shared';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $queue = 'activity';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($name)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return "Hello, {$name}!";</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="9-ensure-all-microservices-have-the-same-app_key-in-their-env-file">9. Ensure all microservices have the same <code>APP_KEY</code> in their <code>.env</code> file.<a class="hash-link" href="#9-ensure-all-microservices-have-the-same-app_key-in-their-env-file" title="Direct link to heading">​</a></h4><p>This is crucial for proper job serialization across services.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="10-run-queue-workers-in-each-microservice">10. Run queue workers in each microservice.<a class="hash-link" href="#10-run-queue-workers-in-each-microservice" title="Direct link to heading">​</a></h4><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan queue:work shared --queue=workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan queue:work shared --queue=activity</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>By following the steps above, you can ensure seamless interactions between microservices while maintaining modularity and scalability. Laravel Workflow takes care of the discovery and orchestration for you. 🚀</p><p>Thanks for reading!</p>]]></content:encoded>
            <category>microservices</category>
            <category>workflow</category>
            <category>communication</category>
            <category>distributed-systems</category>
        </item>
        <item>
            <title><![CDATA[Saga Pattern and Laravel Workflow]]></title>
            <link>https://laravel-workflow.com/blog/saga-pattern-and-laravel-workflow</link>
            <guid>saga-pattern-and-laravel-workflow</guid>
            <pubDate>Sun, 21 May 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Suppose we are working on a Laravel application that offers trip booking. A typical trip booking involves several steps such as:]]></description>
            <content:encoded><![CDATA[<p>Suppose we are working on a Laravel application that offers trip booking. A typical trip booking involves several steps such as:</p><ol><li>Booking a flight.</li><li>Booking a hotel.</li><li>Booking a rental car.</li></ol><p>Our customers expect an all-or-nothing transaction — it doesn’t make sense to book a hotel without a flight. Now imagine each of these booking steps being represented by a distinct API.</p><p>Together, these steps form a distributed transaction spanning multiple services and databases. For a successful booking, all three APIs must accomplish their individual local transactions. If any step fails, the preceding successful transactions need to be reversed in an orderly fashion. With money and bookings at stake, we can’t merely erase prior transactions — we need an immutable record of attempts and failures. Thus, we should compile a list of compensatory actions for execution in the event of a failure.</p><h1>Prerequisites</h1><p>To follow this tutorial, you should:</p><ol><li>Set up a local development environment for Laravel Workflow applications in PHP or use the sample app in a GitHub <a href="https://github.com/laravel-workflow/sample-app" target="_blank" rel="noopener noreferrer">codespace</a>.</li><li>Familiarize yourself with the basics of starting a Laravel Workflow project by reviewing the <a href="https://laravel-workflow.com/docs/installation" target="_blank" rel="noopener noreferrer">documentation</a>.</li><li>Review the <a href="https://microservices.io/patterns/data/saga.html" target="_blank" rel="noopener noreferrer">Saga architecture pattern</a>.</li></ol><p>Sagas are an established design pattern for managing complex, long-running operations:</p><ol><li>A Saga manages transactions using a sequence of local transactions.</li><li>A local transaction is a work unit performed by a saga participant (a microservice).</li><li>Each operation in the Saga can be reversed by a compensatory transaction.</li><li>The Saga pattern assures that all operations are either completed successfully or the corresponding compensation transactions are run to reverse any completed work.</li></ol><p>Laravel Workflow provides inherent support for the Saga pattern, simplifying the process of handling rollbacks and executing compensatory transactions.</p><h1>Booking Saga Flow</h1><p>We will visualize the Saga pattern for our trip booking scenario with a diagram.</p><div class="themedImageWrapper_nM_G"><div class="lightImage_srvP"><a href="https://mermaid.live/edit#pako:eNptkstuwjAQRX_FmrVBYEgwqdSKhNei7QJWLWFhJZMQ1djIcdRHxL83JA2kVb3y1Zw545FcQqRjBA8Sqd-jgzCWPG5CRaoz221tlfek17snfrmUWXqwZFtEEeZ5UsiHc6ga0q8Q8oJ5TQblWluUf8Ar9qxrar2bSUl8rd8yleYkECpCKTHet86g65yXG1RWyIoz_4iDjni1a1ykee_VN-_6Fr-n34z7DvwjXLbCeq2rb9lMa8Kq2amtRVLkOfFpQOckxijLM63uuqUZXdAlXdE1EZG9FIFCarIYPGsKpHBEcxSXCOWlLQR7wCOG4FXXGBNRSBtCqM5V20moV62PbafRRXoALxEyr1JxioXFeSZSI24IqhhNoAtlwXNqA3glfIA3dJ2-O-HOZMiZM5jygUvhEzzG3b47dlw-HbMBd5gzOlP4qocO-s54NGV8yoaMMZe7nALGmdXmqflW9e86fwOyNLgF" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNptkstuwjAQRX_FmrVBYEgwqdSKhNei7QJWLWFhJZMQ1djIcdRHxL83JA2kVb3y1Zw545FcQqRjBA8Sqd-jgzCWPG5CRaoz221tlfek17snfrmUWXqwZFtEEeZ5UsiHc6ga0q8Q8oJ5TQblWluUf8Ar9qxrar2bSUl8rd8yleYkECpCKTHet86g65yXG1RWyIoz_4iDjni1a1ykee_VN-_6Fr-n34z7DvwjXLbCeq2rb9lMa8Kq2amtRVLkOfFpQOckxijLM63uuqUZXdAlXdE1EZG9FIFCarIYPGsKpHBEcxSXCOWlLQR7wCOG4FXXGBNRSBtCqM5V20moV62PbafRRXoALxEyr1JxioXFeSZSI24IqhhNoAtlwXNqA3glfIA3dJ2-O-HOZMiZM5jygUvhEzzG3b47dlw-HbMBd5gzOlP4qocO-s54NGV8yoaMMZe7nALGmdXmqflW9e86fwOyNLgF?type=png" alt="Saga Pattern Flow Diagram"></a></div><div class="darkImage_qlOL"><a href="https://mermaid.live/edit#pako:eNptkktvgzAMgP9K5HNatSnQwKRNBfo4bDu0p630EEEKqCGpQtAeiP8-CmvHpuUUx58_x5JriFXCwYOjUG9xxrRBj9tIovYs9jvTxgc0Gt0jv16JPM0M2lVxzMvyWImHJpI96bcIeuFlRwb1Rhku_oA37Fl11Ga_EAL5Sp1ymZYoYDLmQvDkcHUGQ2dYb7k0TLSc_kccDMTrfe9C_X9vvnDoW_7u_mM8DOBv4eoq7Ma6-VZ9tz5Y9zNdc7FgZYl8HOAQJTzOy1zJu2FqgZd4hdd4g1hsLknAkOo8Ac_oimMouC7YJYT6UhaByXjBI_Daa8L0KYJINm3NmclXpYprmVZVmoF3ZKJso-qcMMPDnKWaFbdXzWXCdaAqacCz7M4BXg3v4E0de-zMqT2fUmJPXDpxMHyAR6gzdizboa5FJtQm9qzB8Nm1nYxta-YS6pIpIcShDsXAk9wo_dRvVbdczRe1TrdB" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNptkktvgzAMgP9K5HNatSnQwKRNBfo4bDu0p630EEEKqCGpQtAeiP8-CmvHpuUUx58_x5JriFXCwYOjUG9xxrRBj9tIovYs9jvTxgc0Gt0jv16JPM0M2lVxzMvyWImHJpI96bcIeuFlRwb1Rhku_oA37Fl11Ga_EAL5Sp1ymZYoYDLmQvDkcHUGQ2dYb7k0TLSc_kccDMTrfe9C_X9vvnDoW_7u_mM8DOBv4eoq7Ma6-VZ9tz5Y9zNdc7FgZYl8HOAQJTzOy1zJu2FqgZd4hdd4g1hsLknAkOo8Ac_oimMouC7YJYT6UhaByXjBI_Daa8L0KYJINm3NmclXpYprmVZVmoF3ZKJso-qcMMPDnKWaFbdXzWXCdaAqacCz7M4BXg3v4E0de-zMqT2fUmJPXDpxMHyAR6gzdizboa5FJtQm9qzB8Nm1nYxta-YS6pIpIcShDsXAk9wo_dRvVbdczRe1TrdB?type=png" alt="Saga Pattern Flow Diagram"></a></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="workflow-implementation">Workflow Implementation<a class="hash-link" href="#workflow-implementation" title="Direct link to heading">​</a></h2><p>We’ll begin by creating a high-level flow of our trip booking process, which we’ll name <code>BookingSagaWorkflow</code>.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">class BookingSagaWorkflow extends Workflow  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, we’ll imbue our saga with logic, by adding booking steps:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class BookingSagaWorkflow extends Workflow  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $flightId = yield activity(BookFlightActivity::class);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $hotelId = yield activity(BookHotelActivity::class);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $carId = yield activity(BookRentalCarActivity::class);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (Throwable $th) {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Everything inside the <code>try</code> block is our "happy path". If any steps within this distributed transaction fail, we move into the <code>catch</code> block and execute compensations.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="adding-compensations">Adding Compensations<a class="hash-link" href="#adding-compensations" title="Direct link to heading">​</a></h2><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class BookingSagaWorkflow extends Workflow  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $flightId = yield activity(BookFlightActivity::class);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $this-&gt;addCompensation(fn () =&gt; activity(CancelFlightActivity::class, $flightId));  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $hotelId = yield activity(BookHotelActivity::class);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $this-&gt;addCompensation(fn () =&gt; activity(CancelHotelActivity::class, $hotelId));  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $carId = yield activity(BookRentalCarActivity::class);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $this-&gt;addCompensation(fn () =&gt; activity(CancelRentalCarActivity::class, $carId));  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (Throwable $th) {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above code, we sequentially book a flight, a hotel, and a car. We use the <code>$this-&gt;addCompensation()</code> method to add a compensation, providing a callable to reverse a distributed transaction.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="executing-the-compensation-strategy">Executing the Compensation Strategy<a class="hash-link" href="#executing-the-compensation-strategy" title="Direct link to heading">​</a></h2><p>With the above setup, we can finalize our saga and populate the <code>catch</code> block:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">class BookingSagaWorkflow extends Workflow  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $flightId = yield activity(BookFlightActivity::class);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $this-&gt;addCompensation(fn () =&gt; activity(CancelFlightActivity::class, $flightId));  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $hotelId = yield activity(BookHotelActivity::class);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $this-&gt;addCompensation(fn () =&gt; activity(CancelHotelActivity::class, $hotelId));  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $carId = yield activity(BookRentalCarActivity::class);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $this-&gt;addCompensation(fn () =&gt; activity(CancelRentalCarActivity::class, $carId));  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        } catch (Throwable $th) {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            yield from $this-&gt;compensate();  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw $th;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Within the <code>catch</code> block, we call the <code>compensate()</code> method, which triggers the compensation strategy and executes all previously registered compensation callbacks. Once done, we rethrow the exception for debugging.</p><p>By default, compensations execute sequentially. To run them in parallel, use <code>$this-&gt;setParallelCompensation(true)</code>. To ignore exceptions that occur inside compensation activities while keeping them sequential, use <code>$this-&gt;setContinueWithError(true)</code> instead.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-the-workflow">Testing the Workflow<a class="hash-link" href="#testing-the-workflow" title="Direct link to heading">​</a></h2><p>Let’s run this workflow with simulated failures in each activity to fully understand the process.</p><p>First, we run the workflow normally to see the sequence of bookings: flight, then hotel, then rental car.</p><p><img loading="lazy" src="https://miro.medium.com/v2/1*3IgEjKzHK8Fpp-uumr4dIw.png" alt="booking saga with no errors" class="img_ev3q"></p><p>Next, we simulate an error with the flight booking activity. Since no bookings were made, the workflow logs the exception and fails.</p><p><img loading="lazy" src="https://miro.medium.com/v2/1*ZuDAFa_q0l2-PT6PhRguaw.png" alt="booking saga error with flight" class="img_ev3q"></p><p>Then, we simulate an error with the hotel booking activity. The flight is booked successfully, but when the hotel booking fails, the workflow cancels the flight.</p><p><img loading="lazy" src="https://miro.medium.com/v2/1*_OwO5PUOLFqcLfd38gNpEQ.png" alt="booking saga error with hotel" class="img_ev3q"></p><p>Finally, we simulate an error with the rental car booking. The flight and hotel are booked successfully, but when the rental car booking fails, the workflow cancels the hotel first and then the flight.</p><p><img loading="lazy" src="https://miro.medium.com/v2/1*3qR9GKQH-YtghwPK_x9wUQ.png" alt="booking saga error with rental car" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>In this tutorial, we implemented the Saga architecture pattern for distributed transactions in a microservices-based application using Laravel Workflow. Writing Sagas can be complex, but Laravel Workflow takes care of the difficult parts such as handling errors and retries, and invoking compensatory transactions, allowing us to focus on the details of our application.</p>]]></content:encoded>
            <category>sagas</category>
            <category>microservices</category>
        </item>
        <item>
            <title><![CDATA[Combining Laravel Workflow and State Machines]]></title>
            <link>https://laravel-workflow.com/blog/combining-laravel-workflow-and-state-machines</link>
            <guid>combining-laravel-workflow-and-state-machines</guid>
            <pubDate>Tue, 25 Apr 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[When it comes to building web applications, managing complex processes and activities can be a daunting task. Laravel Workflow simplifies this process by providing tools for defining and managing workflows and activities. In addition, integrating a state machine library can offer more explicit control over the transitions between states or activities, resulting in a more structured and visual representation of the workflow. In this blog post, we will explore the benefits of using Laravel Workflow along with a state machine and walk through an example of integrating Laravel Workflow with Finite, a simple state machine library.]]></description>
            <content:encoded><![CDATA[<p>When it comes to building web applications, managing complex processes and activities can be a daunting task. Laravel Workflow simplifies this process by providing tools for defining and managing workflows and activities. In addition, integrating a state machine library can offer more explicit control over the transitions between states or activities, resulting in a more structured and visual representation of the workflow. In this blog post, we will explore the benefits of using Laravel Workflow along with a state machine and walk through an example of integrating Laravel Workflow with Finite, a simple state machine library.</p><h1>Benefits of Combining Laravel Workflow and State Machines</h1><p>Using Laravel Workflow and a state machine together provides several advantages:</p><ol><li>Flexibility and modularity: Laravel Workflow allows developers to break down complex processes into smaller, modular units that are easy to maintain and update.</li><li>Explicit control over transitions: State machines provide a clear visualization of workflow states, activities, and transitions, making it easier to understand and maintain.</li><li>Robust error handling and retries: Laravel Workflow offers built-in support for handling errors and retries, ensuring that workflows are executed reliably and consistently.</li><li>Scalability: Laravel Workflow supports queuing and parallel execution, allowing workflows to be executed asynchronously on worker servers.</li><li>Integration with Laravel’s queue and event systems: This allows for seamless integration with other Laravel features and packages.</li></ol><h1>Installation Guide</h1><p>To get started with Laravel Workflow and Finite, you will need to install them in your Laravel project:</p><p>For Laravel Workflow, run the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">composer</span><span class="token plain"> require laravel-workflow/laravel-workflow</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For <a href="https://github.com/yohang/Finite" target="_blank" rel="noopener noreferrer">Finite</a>, run the following command:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">composer</span><span class="token plain"> require yohang/finite</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Loan Application Workflow Example</h1><p>The following code demonstrates how to create a <code>LoanApplicationWorkflow</code> using Laravel Workflow and Finite:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Finite\StatefulInterface;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Finite\StateMachine\StateMachine;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Finite\State\State;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Finite\State\StateInterface;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\await;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Models\StoredWorkflow;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\SignalMethod;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class LoanApplicationWorkflow extends Workflow implements StatefulInterface  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private $state;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private $stateMachine;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function setFiniteState($state)  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;state = $state;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function getFiniteState()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $this-&gt;state;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #[SignalMethod]  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function submit()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;apply('submit');  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #[SignalMethod]  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function approve()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;apply('approve');  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #[SignalMethod]  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function deny()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;apply('deny');  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function isSubmitted()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $this-&gt;stateMachine-&gt;getCurrentState()-&gt;getName() === 'submitted';  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function isApproved()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $this-&gt;stateMachine-&gt;getCurrentState()-&gt;getName() === 'approved';  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function isDenied()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $this-&gt;stateMachine-&gt;getCurrentState()-&gt;getName() === 'denied';  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function __construct(  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        public StoredWorkflow $storedWorkflow,  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ...$arguments  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ) {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        parent::__construct($storedWorkflow, $arguments);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine = new StateMachine();  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;addState(new State('created', StateInterface::TYPE\_INITIAL));  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;addState('submitted');  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;addState(new State('approved', StateInterface::TYPE\_FINAL));  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;addState(new State('denied', StateInterface::TYPE\_FINAL));  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;addTransition('submit', 'created', 'submitted');  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;addTransition('approve', 'submitted', 'approved');  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;addTransition('deny', 'submitted', 'denied');  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;setObject($this);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;stateMachine-&gt;initialize();  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // loan created  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        yield await(fn () =&gt; $this-&gt;isSubmitted());  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // loan submitted  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        yield await(fn () =&gt; $this-&gt;isApproved() || $this-&gt;isDenied());  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        // loan approved/denied  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $this-&gt;stateMachine-&gt;getCurrentState()-&gt;getName();  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this example, we define a <code>LoanApplicationWorkflow</code> class that extends <code>Workflow</code> and implements <code>StatefulInterface</code>. The workflow has four states: created, submitted, approved or denied. The workflow transitions between these states by externally calling the <code>submit()</code>, <code>approve()</code>, and <code>deny()</code> signal methods.</p><p>To use the <code>LoanApplicationWorkflow</code>, you can create a new instance of it, start the workflow, submit the loan application, approve it, and get the output as follows:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// create workflow  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow = WorkflowStub::make(LoanApplicationWorkflow::class);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// start workflow  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow-&gt;start();  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sleep(1);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// submit signal  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow-&gt;submit();  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sleep(1);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// approve signal  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow-&gt;approve();  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sleep(1);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$workflow-&gt;output();  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// "approved"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is the view from <a href="https://github.com/laravel-workflow/waterline" target="_blank" rel="noopener noreferrer">Waterline</a>.</p><p><img loading="lazy" src="https://miro.medium.com/max/1400/1*m6cOftX9kjBjr6CJGpyQPA.webp" alt="timeline" class="img_ev3q"></p><h1>Conclusion</h1><p>Although Laravel Workflow offers a way to define and manage workflows and activities, some developers might still prefer to use a state machine to have more explicit control over the transitions between states or activities.</p><p>A state machine can provide a more structured and visual representation of the workflow, making it easier to understand and maintain. In such cases, a state machine library can be integrated with Laravel Workflow. This allows developers to define their workflow states, activities, and transitions using the state machine library while still leveraging Laravel Workflow’s features, such as queuing, parallel execution, error handling, retries, and integration with Laravel’s queue and event systems.</p><p>The Laravel developer community has created several state machine packages that can be integrated with Laravel Workflow, such as the following:</p><ul><li><a href="https://github.com/yohang/Finite" target="_blank" rel="noopener noreferrer">https://github.com/yohang/Finite</a></li><li><a href="https://github.com/spatie/laravel-model-states" target="_blank" rel="noopener noreferrer">https://github.com/spatie/laravel-model-states</a></li><li><a href="https://github.com/sebdesign/laravel-state-machine" target="_blank" rel="noopener noreferrer">https://github.com/sebdesign/laravel-state-machine</a></li><li><a href="https://github.com/symfony/workflow" target="_blank" rel="noopener noreferrer">https://github.com/symfony/workflow</a></li></ul><p>By integrating a state machine library with Laravel Workflow, developers can get the best of both worlds: the flexibility and modularity of Laravel Workflow and the explicit control and visualization of a state machine. This can help to create more maintainable, robust, and scalable workflows for complex business processes.</p>]]></content:encoded>
            <category>side-effects</category>
            <category>random</category>
            <category>determinism</category>
        </item>
        <item>
            <title><![CDATA[Introducing Child Workflows in Laravel Workflow]]></title>
            <link>https://laravel-workflow.com/blog/introducing-child-workflows-in-laravel-workflow</link>
            <guid>introducing-child-workflows-in-laravel-workflow</guid>
            <pubDate>Wed, 05 Apr 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Laravel Workflow has introduced an exciting new feature called “Child Workflows.” This addition aims to enhance the organization and maintainability of complex processes by allowing developers to encapsulate sub-processes within a parent workflow. This article will discuss the benefits of using child workflows, their similarities with running a workflow as an activity, and their compatibility with retry and resume features.]]></description>
            <content:encoded><![CDATA[<p>Laravel Workflow has introduced an exciting new feature called “Child Workflows.” This addition aims to enhance the organization and maintainability of complex processes by allowing developers to encapsulate sub-processes within a parent workflow. This article will discuss the benefits of using child workflows, their similarities with running a workflow as an activity, and their compatibility with retry and resume features.</p><h1>What are Child Workflows?</h1><p>In Laravel Workflow, child workflows are a way to manage complex processes by breaking them down into smaller, more manageable units. They enable developers to create hierarchical and modular structures for their workflows, making them more organized and easier to maintain. A child workflow is essentially a separate workflow that is invoked within a parent workflow using the <code>child()</code> helper function.</p><h1>Benefits of Using Child Workflows</h1><ol><li>Modularity: Child workflows promote modularity by allowing developers to encapsulate specific functionality within separate, reusable units. This enables better code organization and easier management of complex processes.</li><li>Reusability: Child workflows can be invoked within multiple parent workflows, which encourages reusability and reduces code duplication.</li><li>Maintainability: By breaking down complex processes into smaller units, developers can better understand, debug, and maintain their workflows.</li></ol><h1>Workflows as Activities</h1><p>Child workflows are similar to running a workflow as an activity in that they both encapsulate specific functionality within a parent workflow. However, child workflows offer more flexibility and reusability than activities.</p><div class="themedImageWrapper_nM_G"><div class="lightImage_srvP"><a href="https://mermaid.live/edit#pako:eNp1kl1rwjAUhv9KOOBdlTbaGnsx8Hu6DcYYDNbuImtTW2wTianOif99bYwoluUi5Jwn73tykhwhEjEDH5Jc7KOUSoXeRyFH1RgGr1QyrtCHkOsaf53zo2AYqWyXqQNyTGocLPhOrBkap1ke3wqMFWq3H9BIz-NLstVCzyxR6FtSHqW-0e6N1hhrySRo-NZwouHUwMahphrP7jE2eKbx_B53DZ5r_BhMeYxE8l9jVQ9v2Sq9NmGuLBJcZbxk29s2FkHjEAsNlkGj_FKDp0v55kuEHCxYySwGX8mSWVAwWdA6hGNtEYJKWcFC8KtlzBJa5iqEkJ8q2YbyTyGKi1KKcpWCn9B8W0XlJqaKTTK6kvS6hfGYybEouQLf6WoL8I_wU0We2_H6xO07BLv2gNieBQfwMfE6Xs_1yKCHbeJit3uy4FdXtTturzvAZIAdjLFHPGIBizMl5Mv5L-ovefoDcS7LIg" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNp1kl1rwjAUhv9KOOBdlTbaGnsx8Hu6DcYYDNbuImtTW2wTianOif99bYwoluUi5Jwn73tykhwhEjEDH5Jc7KOUSoXeRyFH1RgGr1QyrtCHkOsaf53zo2AYqWyXqQNyTGocLPhOrBkap1ke3wqMFWq3H9BIz-NLstVCzyxR6FtSHqW-0e6N1hhrySRo-NZwouHUwMahphrP7jE2eKbx_B53DZ5r_BhMeYxE8l9jVQ9v2Sq9NmGuLBJcZbxk29s2FkHjEAsNlkGj_FKDp0v55kuEHCxYySwGX8mSWVAwWdA6hGNtEYJKWcFC8KtlzBJa5iqEkJ8q2YbyTyGKi1KKcpWCn9B8W0XlJqaKTTK6kvS6hfGYybEouQLf6WoL8I_wU0We2_H6xO07BLv2gNieBQfwMfE6Xs_1yKCHbeJit3uy4FdXtTturzvAZIAdjLFHPGIBizMl5Mv5L-ovefoDcS7LIg?type=png" alt="Child Workflows Diagram"></a></div><div class="darkImage_qlOL"><a href="https://mermaid.live/edit#pako:eNp1kl1rwjAUhv9KOOBdFRttjLkY-D3dBmMMBmt3kbXRFm0iMdU58b-vxriJZbkIOefhfc85SQ4Qq0QAg_lK7eKUa4Ne-5FE5eqFz1wLadCb0ssT_jjn-2EvNtk2M3vku9QgnMqtWgo0SLNVci1wVqhev0N9uw8uyVoNPYq5QZ-ayzhlTrtzWmdsJcOw4nuCQwtHDlaaGlk8vsXY4bHFk1vccnhi8X04kglS8_8GK2d4yRbp3xDuymIlTSYLsbkeYxpWmphaMAsr5WcWPFzKV18ikuDBQmcJMKML4UEudM5PIRxOFhGYVOQiAlYeE66XEUTyWGrWXL4rlV9kWhWLFNicrzZlVKwTbsQw4wvN899sWTsReqAKaYCRwHoAO8AXMJ8EDdKhQcenOGh2aZN4sAeGKWmQdkBot42bNMBB6-jBty3bbATtVhfTLvYxxoQS6oFIMqP00_kn2g95_AGd-cox" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNp1kl1rwjAUhv9KOOBdFRttjLkY-D3dBmMMBmt3kbXRFm0iMdU58b-vxriJZbkIOefhfc85SQ4Qq0QAg_lK7eKUa4Ne-5FE5eqFz1wLadCb0ssT_jjn-2EvNtk2M3vku9QgnMqtWgo0SLNVci1wVqhev0N9uw8uyVoNPYq5QZ-ayzhlTrtzWmdsJcOw4nuCQwtHDlaaGlk8vsXY4bHFk1vccnhi8X04kglS8_8GK2d4yRbp3xDuymIlTSYLsbkeYxpWmphaMAsr5WcWPFzKV18ikuDBQmcJMKML4UEudM5PIRxOFhGYVOQiAlYeE66XEUTyWGrWXL4rlV9kWhWLFNicrzZlVKwTbsQw4wvN899sWTsReqAKaYCRwHoAO8AXMJ8EDdKhQcenOGh2aZN4sAeGKWmQdkBot42bNMBB6-jBty3bbATtVhfTLvYxxoQS6oFIMqP00_kn2g95_AGd-cox?type=png" alt="Child Workflows Diagram"></a></div></div><p>Activities are single-purpose units that perform a specific action within a workflow, such as sending an email or updating a database record. On the other hand, child workflows are complete workflows in themselves, which can be composed of multiple activities and even other child workflows. This allows developers to create complex, nested structures to manage intricate processes more efficiently.</p><h1>Retries and Resumes in Child Workflows</h1><p>Child workflows inherit the same retry and resume features as their parent workflows, enabling developers to manage error handling and recovery more effectively. When a child workflow fails, Laravel Workflow will automatically attempt to retry the failed operation, following the configured retry policy. If the child workflow still fails after all retries have been exhausted, the parent workflow can also be configured to handle the failure accordingly.</p><p>In addition, child workflows can be resumed if they are interrupted due to a system failure or crash. This ensures that the entire process can continue from the point of interruption without losing progress or requiring manual intervention.</p><h1>Conclusion</h1><p>Laravel Workflow’s Child Workflows feature offers developers an effective way to manage complex processes by breaking them down into smaller, more manageable units. This enhances organization, maintainability, and reusability, making it easier for developers to build and maintain intricate workflows. With the added benefits of retry and resume features, child workflows provide a robust and efficient solution for managing complex processes in Laravel applications.</p>]]></content:encoded>
            <category>child-workflows</category>
            <category>nesting</category>
        </item>
        <item>
            <title><![CDATA[New Laravel Workflow Feature: Side Effects]]></title>
            <link>https://laravel-workflow.com/blog/new-laravel-workflow-feature-side-effects</link>
            <guid>new-laravel-workflow-feature-side-effects</guid>
            <pubDate>Thu, 22 Dec 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Workflows provide a more organized and structured approach to managing distributed processes, making it easier for developers to understand and work with complex logic.]]></description>
            <content:encoded><![CDATA[<p>Workflows provide a more organized and structured approach to managing distributed processes, making it easier for developers to understand and work with complex logic.</p><p>Laravel Workflow is a powerful package for the Laravel web framework that provides tools for defining and managing workflows.</p><p>One of the key features of any workflow engine is the ability to track the history of a workflow as it is executed which allows a workflow to be retried if it fails or encounters an error. However, this also means that your workflow code must be deterministic and any non-deterministic code has to be carefully managed.</p><p>Recently, Laravel Workflow added support for <a href="https://laravel-workflow.com/docs/features/side-effects" target="_blank" rel="noopener noreferrer">side effects</a>, which are closures containing non-deterministic code that is only executed once and the result saved. Side effects are a useful way to introduce non-deterministic behavior into a workflow, such as generating a random number or UUID.</p><p>Here is an example workflow that demonstrates side effects.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\{activity, sideEffect};</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class SideEffectWorkflow extends Workflow  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $sideEffect = yield sideEffect(  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          fn () =&gt; random_int(PHP_INT_MIN, PHP_INT_MAX)  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        );  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $badSideEffect = random_int(PHP_INT_MIN, PHP_INT_MAX);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $result1 = yield activity(SimpleActivity::class, $sideEffect);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $result2 = yield activity(SimpleActivity::class, $badSideEffect);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if ($sideEffect !== $result1) {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw new Exception(  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                'These side effects should match because it was properly wrapped in sideEffect().'  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            );  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if ($badSideEffect === $result2) {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            throw new Exception(  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                'These side effects should not match because it was not wrapped in sideEffect().'  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            );  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The activity doesn’t actually do anything. It just takes the input and passes it back out unmodified, so that we can compare the result to what we generated inside of the workflow.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">class SimpleActivity extends Activity  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($input)  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $input;  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this example, the workflow generates two random integers: one using a side effect and the other using a local variable. The values of these integers are then passed to two different activities.</p><p>The first activity receives the value of the side effect, which has been saved. As a result, the value of the side effect should remain constant throughout the execution of the workflow.</p><p>The second activity receives the value of the local variable, which is not saved and will be regenerated. This means that the value of the local variable will change between executions of the workflow.</p><p>As a result, it is not expected that the value of the local variable will match the value returned from the second activity. The odds of two random integers generated using <code>random_int(PHP_INT_MIN, PHP_INT_MAX)</code> being equal are extremely low, since there are a very large number of possible integers in this range.</p><p>It’s important to use side effects appropriately in your workflow to ensure that your workflow is reliable and can recover from failures. Only use side effects for short pieces of code that cannot fail, and make sure to use activities to perform long-running work that may fail and need to be retried, such as API requests or external processes.</p><p>Overall, side effects are a powerful tool for introducing non-deterministic behavior into your workflows. When used correctly, they can help you to add more flexibility and complexity to your application’s logic.</p><p>Laravel Workflow is a powerful tool for managing workflows in your Laravel applications, and the addition of support for side effects makes it even more powerful!</p>]]></content:encoded>
            <category>side-effects</category>
            <category>random</category>
            <category>determinism</category>
        </item>
        <item>
            <title><![CDATA[Laravel Workflow: Job Chaining vs. Fan-out/Fan-in]]></title>
            <link>https://laravel-workflow.com/blog/job-chaining-vs-fan-out-fan-in</link>
            <guid>job-chaining-vs-fan-out-fan-in</guid>
            <pubDate>Tue, 06 Dec 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Chaining is a workflow design pattern that involves the sequential execution of a series of activities, with the output of one activity potentially serving as the input to the next activity in the chain. This pattern is often used to create a linear, step-by-step process for completing a task.]]></description>
            <content:encoded><![CDATA[<p><a href="https://laravel.com/docs/9.x/queues#job-chaining" target="_blank" rel="noopener noreferrer">Chaining</a> is a workflow design pattern that involves the sequential execution of a series of activities, with the output of one activity potentially serving as the input to the next activity in the chain. This pattern is often used to create a linear, step-by-step process for completing a task.</p><div class="themedImageWrapper_nM_G"><div class="lightImage_srvP"><a href="https://mermaid.live/edit#pako:eNptkctOwzAQRX8lmhVIaYhtnIeFuoAoK9iwpOnCjZ2HlNiV64hHlB9hx6_xJThpC4vizfjOnTN3MSOUWkhgUHX6tWy4sd7jc6E893K0-f78utuZm3U-qNK2Wnloe_Sye7S5yrjlO36Q16dmji8B_AvgfwByCRDnnfO91Wo9Ry01xyd5rDkBH2rTCmDWDNKHXpqezxLGmS_ANrKXBTD3FbLiQ2cLKNTksD1XL1r3Z9LooW6AVbw7ODXsBbcya3lt-N-IVEKaBz0oCwyRZQWwEd5mFQaEEIToLcaUhrEP78AISgIcIxInYUSx86PJh48lNAxoSglKoyQhOEQ0TX2QorXaPB1PsVxk-gF0nnts" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNptkctOwzAQRX8lmhVIaYhtnIeFuoAoK9iwpOnCjZ2HlNiV64hHlB9hx6_xJThpC4vizfjOnTN3MSOUWkhgUHX6tWy4sd7jc6E893K0-f78utuZm3U-qNK2Wnloe_Sye7S5yrjlO36Q16dmji8B_AvgfwByCRDnnfO91Wo9Ry01xyd5rDkBH2rTCmDWDNKHXpqezxLGmS_ANrKXBTD3FbLiQ2cLKNTksD1XL1r3Z9LooW6AVbw7ODXsBbcya3lt-N-IVEKaBz0oCwyRZQWwEd5mFQaEEIToLcaUhrEP78AISgIcIxInYUSx86PJh48lNAxoSglKoyQhOEQ0TX2QorXaPB1PsVxk-gF0nnts?type=png" alt="Job Chaining Diagram"></a></div><div class="darkImage_qlOL"><a href="https://mermaid.live/edit#pako:eNptkU1ugzAQha-CZtVKhGI75seqsmgRq3bTZUMWDnYANdiRY9QfxEW669V6khpIsklnM_Pm6Zu3mB5KLSQw2O31e1lzY72nl0J5rnK0_v3-ud-au1XeqdI2WnloM3vZA1rfZNzyLT_K29Myx9cAvgD4H4BcA8R553xvsViNUVPP8UnOPSfgQ2UaAcyaTvrQStPyUUI_8gXYWrayAOZGwc1bAYUaHHPg6lXr9owZ3VU1sB3fH53qDoJbmTW8Mry9bI1UQppH3SkLbBmT6QiwHj6AIRIGhBCE6BJjSsPYh09gBCUBjhGJkzCi2PnR4MPXFBsGNKUEpVGSEBwimqY-SNFYbZ7nT0wPGf4AtoR6rg" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNptkU1ugzAQha-CZtVKhGI75seqsmgRq3bTZUMWDnYANdiRY9QfxEW669V6khpIsklnM_Pm6Zu3mB5KLSQw2O31e1lzY72nl0J5rnK0_v3-ud-au1XeqdI2WnloM3vZA1rfZNzyLT_K29Myx9cAvgD4H4BcA8R553xvsViNUVPP8UnOPSfgQ2UaAcyaTvrQStPyUUI_8gXYWrayAOZGwc1bAYUaHHPg6lXr9owZ3VU1sB3fH53qDoJbmTW8Mry9bI1UQppH3SkLbBmT6QiwHj6AIRIGhBCE6BJjSsPYh09gBCUBjhGJkzCi2PnR4MPXFBsGNKUEpVGSEBwimqY-SNFYbZ7nT0wPGf4AtoR6rg?type=png" alt="Job Chaining Diagram"></a></div></div><p>In contrast, the fan-out/fan-in pattern involves dividing a task into smaller sub-tasks and then combining the results of those sub-tasks to produce the final result. This pattern is often used to parallelize a task and improve its performance by leveraging the power of multiple queue workers.</p><div class="themedImageWrapper_nM_G"><div class="lightImage_srvP"><a href="https://mermaid.live/edit#pako:eNptkUtOwzAQhq8SzQqkNMQ2zsNCXUDUFWxY0nThNs5DSuzKdcQjykXYcTVOgpM0raB45X8-fzMjuYOdygQwyGv1uiu5Ns7jcyode1Zo_f35dbfVN8tVK3emUtJBm4kl92h9lXDDt_wgrm3xqGBz6eDNDJv_4dwS_245OuRSIedxyFkslsMyp63Ggl3jCPCUyV_ezDyV4EKhqwyY0a1woRG64UOEbpBSMKVoRArMXjOR87Y2KaSyt9qeyxelmtnUqi1KYDmvDza1-4wbkVS80Pz8RMhM6AfVSgMMkbEFsA7ehuR7hBCE6C3GlPqhC-_ACIo8HCISRn5AseVB78LHONT3aEwJioMoIthHNI5dEFlllH6afnT82P4HgHeQGg" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNptkUtOwzAQhq8SzQqkNMQ2zsNCXUDUFWxY0nThNs5DSuzKdcQjykXYcTVOgpM0raB45X8-fzMjuYOdygQwyGv1uiu5Ns7jcyode1Zo_f35dbfVN8tVK3emUtJBm4kl92h9lXDDt_wgrm3xqGBz6eDNDJv_4dwS_245OuRSIedxyFkslsMyp63Ggl3jCPCUyV_ezDyV4EKhqwyY0a1woRG64UOEbpBSMKVoRArMXjOR87Y2KaSyt9qeyxelmtnUqi1KYDmvDza1-4wbkVS80Pz8RMhM6AfVSgMMkbEFsA7ehuR7hBCE6C3GlPqhC-_ACIo8HCISRn5AseVB78LHONT3aEwJioMoIthHNI5dEFlllH6afnT82P4HgHeQGg?type=png" alt="Fan-out/Fan-in Diagram"></a></div><div class="darkImage_qlOL"><a href="https://mermaid.live/edit#pako:eNptkU1ugzAQRq-CZtVKhGI7mMSqsmhRVu2my4YsHHAANbYjx6g_iIt016v1JDUQErWpV57v6c2MNA1kOhfAYLvTr1nJjfUenlLlubdEq-_Pr9uNuVksa5XZSisPrQeW3KHVVcIt3_CDuHbhUcH20sHrEcr_4dgS_27ZO-RSIedxyJtMFt0yp636wK1xBHioyV8uR54q8KEwVQ7Mmlr4IIWRvCuh6aQUbCmkSIG5b87NSwqpap2z5-pZazlqRtdFCWzLdwdX1fucW5FUvDBcnlIjVC7Mva6VBTYlcd8EWANvwBAJA0IIQtEU4ygKHXwHRtAswDEi8SykEXactj589GPDIJpHBM1pTCl1CvVB5JXV5nG4Z3_W9gchII8n" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNptkU1ugzAQRq-CZtVKhGI7mMSqsmhRVu2my4YsHHAANbYjx6g_iIt016v1JDUQErWpV57v6c2MNA1kOhfAYLvTr1nJjfUenlLlubdEq-_Pr9uNuVksa5XZSisPrQeW3KHVVcIt3_CDuHbhUcH20sHrEcr_4dgS_27ZO-RSIedxyJtMFt0yp636wK1xBHioyV8uR54q8KEwVQ7Mmlr4IIWRvCuh6aQUbCmkSIG5b87NSwqpap2z5-pZazlqRtdFCWzLdwdX1fucW5FUvDBcnlIjVC7Mva6VBTYlcd8EWANvwBAJA0IIQtEU4ygKHXwHRtAswDEi8SykEXactj589GPDIJpHBM1pTCl1CvVB5JXV5nG4Z3_W9gchII8n?type=png" alt="Fan-out/Fan-in Diagram"></a></div></div><p>There are two phases: fan-out and fan-in.</p><p>In the fan-out phase, the workflow divides the main task into smaller sub-tasks and assigns each of those sub-tasks to a different activity. In the fan-in phase, the workflow collects the results of the activities and combines them to produce the final result.</p><p>The below workflow represents a simple example of a fan-out/fan-in pattern in which multiple activities are executed in parallel and their results are then merged together.</p><p>The workflow divides the task of creating a PDF into activities, with each activity responsible for rendering a single page of the document. Once the individual pages have been rendered, the fan-in phase of the workflow combines the rendered pages into a single PDF document.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\BuildPDF;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\{activity, all};</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class BuildPDFWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $page1 = activity(ConvertURLActivity::class, 'https://example.com/');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $page2 = activity(ConvertURLActivity::class, 'https://example.com/');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $pages = yield all([$page1, $page2]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $result = yield activity(MergePDFActivity::class, $pages);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $result;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>ConvertURLActivity</code> is passed a URL as an argument, and it converts the contents of that URL into a PDF document. Because two separate activities are created, this results in the execution of two instances of <code>ConvertURLActivity</code> in parallel.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\BuildPDF;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Http;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class ConvertURLActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($url)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $fileName = uniqid() . '.pdf';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Http::withHeaders([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'Apikey' =&gt; 'YOUR-API-KEY-GOES-HERE',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ])</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        -&gt;withOptions([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'sink' =&gt; storage_path($fileName),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ])</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        -&gt;post('https://api.cloudmersive.com/convert/web/url/to/pdf', [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'Url' =&gt; $url,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $fileName;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, the <code>BuildPDFWorkflow</code> uses <code>all()</code> to wait for both <code>ConvertURLActivity</code> instances to complete. This is an example of the fan-in part of the fan-out/fan-in pattern, as it collects the results of the parallel activities and combines them into a single array of PDF files.</p><p>Finally, the <code>BuildPDFWorkflow</code> executes the<code>MergePDFActivity</code>, which is passed the array of PDFs that were generated by the <code>ConvertURLActivity</code> instances, and merges them into a single PDF document.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\BuildPDF;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use setasign\Fpdi\Fpdi;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class MergePDFActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($pages)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $fileName = uniqid() . '.pdf';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $pdf = new Fpdi();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        foreach ($pages as $page) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $pdf-&gt;AddPage();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $pdf-&gt;setSourceFile(storage_path($page));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            $pdf-&gt;useTemplate($pdf-&gt;importPage(1));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $pdf-&gt;Output('F', storage_path($fileName));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        foreach ($pages as $page) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            unlink(storage_path($page));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return $fileName;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is what the final PDF looks like…</p><p><img loading="lazy" src="https://miro.medium.com/max/1400/1*A3PKGEk8JptFIxB9IqCh6w.webp" alt="merged PDF" class="img_ev3q"></p><p>Overall, using the fan-out/fan-in pattern in this way can significantly reduce the time it takes to create a PDF document, making the process more efficient and scalable.</p><p>Thanks for reading!</p>]]></content:encoded>
            <category>chaining</category>
            <category>fan-out</category>
            <category>fan-in</category>
            <category>batching</category>
        </item>
        <item>
            <title><![CDATA[Waterline: Elegant UI for Laravel Workflows]]></title>
            <link>https://laravel-workflow.com/blog/waterline-ui</link>
            <guid>waterline-ui</guid>
            <pubDate>Sat, 19 Nov 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[One of the pros to using workflows is that it makes monitoring easy. Using Waterline makes it even easier!]]></description>
            <content:encoded><![CDATA[<p>One of the pros to using workflows is that it makes monitoring easy. Using Waterline makes it even easier!</p><p><img loading="lazy" src="https://miro.medium.com/max/1400/1*2FP4crjpM8C48kAnqAjv5A.webp" alt="dashboard" class="img_ev3q"></p><p>Look familiar? Yes, this is shamelessly based on Horizon! However, the similarity is only superficial. Waterline is geared towards workflows, not queues. In fact, Horizon is still the best way to monitor your queues and plays along nicely with it.</p><blockquote><p>Waterline is to workflows what Horizon is to queues.</p></blockquote><p><img loading="lazy" src="https://miro.medium.com/max/1400/1*EKWNNFy6kYRrqMbaozA8IQ.webp" alt="workflow view" class="img_ev3q"></p><p>At this point you can see a lot of differences! You can see the arguments passed to the workflow and the output from the completed workflow. You can see a timeline that shows each activity at a glance along with any exceptions that were thrown. There is also a list view for the activities and their results.</p><p>At the bottom are any exceptions thrown, including a stack trace and a snippet of code showing the exact line. This makes debugging a breeze.</p><p>If you’re familiar with Horizon then installing Waterline will be like déjà vu but the setup is simpler because Waterline doesn’t care about queues, only workflows.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installation">Installation<a class="hash-link" href="#installation" title="Direct link to heading">​</a></h2><p>You can find the official <a href="https://github.com/laravel-workflow/waterline" target="_blank" rel="noopener noreferrer">documentation</a> here but setup is simple.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">composer</span><span class="token plain"> require laravel-workflow/waterline  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">php artisan waterline:publish</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That’s it! Now you should be able to view the <code>/waterline</code> URL in your app. By default this URL is only available in local environments. To view this outside of local environments you will have to modify the <code>WaterlineServiceProvider</code>.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Gate::define('viewWaterline', function ($user) {  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return in_array($user-&gt;email, [  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'admin@example.com',  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ]);  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will allow only the single admin user to access the Waterline UI.</p><p>If you want more context for the workflow that is show in the screenshot above, make sure to read my <a href="https://medium.com/@laravel-workflow/email-verifications-using-laravel-workflow-acd6707aa7b3" target="_blank" rel="noopener noreferrer">previous article</a>.</p><p>Thanks for reading!</p>]]></content:encoded>
            <category>ui</category>
            <category>horizon</category>
            <category>queues</category>
            <category>workflows</category>
        </item>
        <item>
            <title><![CDATA[Invalidating Cloud Images in Laravel with Workflows]]></title>
            <link>https://laravel-workflow.com/blog/invalidating-cloud-images</link>
            <guid>invalidating-cloud-images</guid>
            <pubDate>Tue, 15 Nov 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Many services like Cloud Image offer a way to invalidate cached images so that they are pulled from your server again. This is useful if you have updated the source image on your server and want future requests to use the latest copy.]]></description>
            <content:encoded><![CDATA[<p>Many services like <a href="https://docs.cloudimage.io/go/cloudimage-documentation-v7/en/caching-acceleration/invalidation-api" target="_blank" rel="noopener noreferrer">Cloud Image</a> offer a way to invalidate cached images so that they are pulled from your server again. This is useful if you have updated the source image on your server and want future requests to use the latest copy.</p><p>However, it can be challenging if you want to automate this and also ensure that the image has been invalidated. This is because most invalidation APIs are asynchronous. When you request an image to be cleared from the cache, the API will return a response immediately. Then the actual process to clear the image from the cache runs in the background, sometimes taking up to 30 seconds before the image is updated. You could simply trust that the process works but it is also possible to be 100% sure with an automated workflow.</p><p>The workflow we need to write is as follows:</p><ol><li>Check the currently cached image’s timestamp via HEAD call</li><li>Invalidate cached image via API call</li><li>Check if the image timestamp has changed</li><li>If not, wait a while and check again</li><li>After 3 failed checks, go back to step 2</li></ol><p>The workflow consists of two activities. The first activity gets the current timestamp of the image. This timestamp is used to determine if the image was actually cleared from the cache or not.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\InvalidateCache;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Http;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class CheckImageDateActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($url)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return Http::head('https://' . config('services.cloudimage.token') . '.cloudimg.io/' . $url)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            -&gt;header('date');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The second activity makes the actual call to Cloud Image’s API to invalidate the image from the cache.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\InvalidateCache;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Http;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class InvalidateCacheActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($url)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Http::withHeaders([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'X-Client-key' =&gt; config('services.cloudimage.key'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'Content-Type' =&gt; 'application/json'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ])-&gt;post('https://api.cloudimage.com/invalidate', [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'scope' =&gt; 'original',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            'urls' =&gt; [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                '/' . $url</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The workflow looks as follows and is the same process as outlined before.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\InvalidateCache;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\{activity, timer};</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class InvalidateCacheWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($url)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $oldDate = yield activity(CheckImageDateActivity::class, $url);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            yield activity(InvalidateCacheActivity::class, $url);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            for ($i = 0; $i &lt; 3; ++$i) { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                yield timer(30);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                $newDate = yield activity(CheckImageDateActivity::class, $url);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                if ($oldDate !== $newDate) return;    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Line 13 uses an activity to get the current timestamp of the image we want to invalidate from the cache.</p><p>Line 15 starts a loop that only exits when the image timestamp has changed.</p><p>Line 16 uses an activity to invalidate the image from the cache.</p><p>Line 18 starts a loop that tries a maximum of three times to first sleep and then check if the image timestamp has change, after three times the loop restarts at line 15.</p><p>Line 19 sleeps the workflow for 30 seconds. This gives Cloud Image time to clear the image from their cache before checking the timestamp again.</p><p>Lines 21–23 reuse the activity from earlier to get the current timestamp of the cached image and compare it to the one saved on line 13. If the timestamps don’t match then the image has successfully been cleared from the cache and we can exit the workflow. Otherwise, after three attempts, we start the process over again.</p><p>This is how the workflow execution looks in the queue assuming no retries are needed.</p><p><img loading="lazy" src="https://miro.medium.com/max/1400/1*7psZLD9mKGJnzEw508oIAw.webp" alt="workflow execution" class="img_ev3q"></p><p>The added benefit is that your image is now cached again and will be fast for the next user! Thanks for reading!</p>]]></content:encoded>
            <category>cache</category>
            <category>invalidation</category>
            <category>cloud</category>
            <category>images</category>
        </item>
        <item>
            <title><![CDATA[Converting Videos with FFmpeg and Laravel Workflow]]></title>
            <link>https://laravel-workflow.com/blog/converting-videos-with-ffmpeg</link>
            <guid>converting-videos-with-ffmpeg</guid>
            <pubDate>Mon, 31 Oct 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[FFmpeg is a free, open-source software project allowing you to record, convert and stream audio and video.]]></description>
            <content:encoded><![CDATA[<p><a href="https://ffmpeg.org/" target="_blank" rel="noopener noreferrer">FFmpeg</a> is a free, open-source software project allowing you to record, convert and stream audio and video.</p><p><a href="https://laravel.com/docs/9.x/queues" target="_blank" rel="noopener noreferrer">Laravel Queues</a> are great for long running tasks. Converting video takes a long time! With <a href="https://github.com/laravel-workflow/laravel-workflow" target="_blank" rel="noopener noreferrer">Laravel Workflow</a>, you can harness the power of queues to convert videos in the background and easily manage the process.</p><h1>Requirements</h1><ol><li>You’ll need to <a href="https://ffmpeg.org/download.html" target="_blank" rel="noopener noreferrer">install FFmpeg</a></li><li>Then <code>composer require php-ffmpeg/php-ffmpeg</code> (<a href="https://github.com/PHP-FFMpeg/PHP-FFMpeg#readme" target="_blank" rel="noopener noreferrer">docs</a>)</li><li>Finally <code>composer require laravel-workflow/laravel-workflow</code> (<a href="https://github.com/laravel-workflow/laravel-workflow#laravel-workflow-" target="_blank" rel="noopener noreferrer">docs</a>)</li></ol><h1>Workflow</h1><p>A workflow is an easy way to orchestrate activities. A workflow that converts a video from one format to another might have several activities, such as downloading the video from storage, the actual conversion, and then finally notifying the user that it’s finished.</p><p>For simplicity, the workflow we are making today will only contain the most interesting activity, converting the video.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\ConvertVideo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class ConvertVideoWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        yield activity(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ConvertVideoWebmActivity::class,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            storage_path('app/oceans.mp4'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            storage_path('app/oceans.webm'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We need a video to convert. We can use this one:</p><p><a href="http://vjs.zencdn.net/v/oceans.mp4" target="_blank" rel="noopener noreferrer">http://vjs.zencdn.net/v/oceans.mp4</a></p><p>Download it and save it to your app storage folder.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\ConvertVideo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use FFMpeg\FFMpeg;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use FFMpeg\Format\Video\WebM;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class ConvertVideoWebmActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public $timeout = 5;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($input, $output)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $ffmpeg = FFMpeg::create();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $video = $ffmpeg-&gt;open($input);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $format = new WebM();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $format-&gt;on('progress', fn () =&gt; $this-&gt;heartbeat());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $video-&gt;save($format, $output);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The activity converts any input video into a <a href="https://www.webmproject.org/" target="_blank" rel="noopener noreferrer">WebM</a> output video. While ffmpeg is converting the video, a progress callback is triggered which in turn heartbeats the activity.</p><p>This is necessary because we have set a reasonable timeout of 5 seconds but we also have no idea how long it will take to convert the video. As long as we send a heartbeat at least once every 5 seconds, the activity will not timeout.</p><p><img loading="lazy" src="https://miro.medium.com/max/1400/1*ccrxeOEZYQciDYEprRKWiQ.webp" alt="heartbeat" class="img_ev3q"></p><p><img loading="lazy" src="https://miro.medium.com/max/1400/1*9ZF3LTqjf4qsVcNVX5LK0A.webp" alt="no heartbeat" class="img_ev3q"></p><p>Without a heartbeat, the worker will be killed after the timeout of 5 seconds is reached.</p><p>To actually run the workflow you just need to call:</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">WorkflowStub::make(ConvertVideoWorkflow::class)-&gt;start();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And that’s it!</p>]]></content:encoded>
            <category>video</category>
            <category>ffmpeg</category>
            <category>conversion</category>
            <category>transcoding</category>
        </item>
        <item>
            <title><![CDATA[Email Verifications Using Laravel Workflow]]></title>
            <link>https://laravel-workflow.com/blog/email-verifications</link>
            <guid>email-verifications</guid>
            <pubDate>Sat, 29 Oct 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[A typical registration process goes as follows:]]></description>
            <content:encoded><![CDATA[<p>A typical registration process goes as follows:</p><ol><li>User fills out registration form and submits it</li><li>Laravel creates user in database with null <code>email_verified_at</code></li><li>Laravel sends email with a code, or a link back to our website</li><li>User enters code, or clicks link</li><li>Laravel sets <code>email_verified_at</code> to the current time</li></ol><p>What’s wrong with this? Nothing. But like all things, as soon as real world complexity creeps in, this pattern could become painful. What if you wanted to send an email after the code or link expires? And do you really need a user in your database if they never verify their email address?</p><p>Let’s take this trivial example and replace it with a workflow. This is based on the <a href="https://github.com/laravel-workflow/laravel-workflow" target="_blank" rel="noopener noreferrer">Laravel Workflow</a> library.</p><h1>Get Started</h1><p>Create a standard Laravel application and create the following files. First, the API routes.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Workflows\VerifyEmail\VerifyEmailWorkflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Hash;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Route;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\WorkflowStub;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Route::get('/register', function () {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $workflow = WorkflowStub::make(VerifyEmailWorkflow::class);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $workflow-&gt;start(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'test+1@example.com',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Hash::make('password'),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return response()-&gt;json([</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        'workflow_id' =&gt; $workflow-&gt;id(),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">});</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Route::get('/verify-email', function () {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $workflow = WorkflowStub::load(request('workflow_id'));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    $workflow-&gt;verify();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    return response()-&gt;json('ok');</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">})-&gt;name('verify-email');</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>register</code> route creates a new <code>VerifyEmailWorkflow</code> , passes in the email and password, and then starts the workflow. Notice that we hash the password before giving it to the workflow. This prevents the plain text from being stored in the workflow logs.</p><p>The <code>verify-email</code> route receives a workflow id, loads it and then calls the <code>verify()</code> signal method.</p><p>Now let’s take a look at the actual workflow.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\SignalMethod;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Workflow;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use function Workflow\{activity, await};</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class VerifyEmailWorkflow extends Workflow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private bool $verified = false;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #[SignalMethod]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function verify()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;verified = true;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($email = '', $password = '')</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        yield activity(SendEmailVerificationEmailActivity::class, $email);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        yield await(fn () =&gt; $this-&gt;verified);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        yield activity(VerifyEmailActivity::class, $email, $password);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Take notice of the <code>yield</code> keywords. Because PHP (and most other languages) cannot save their execution state, coroutines rather than normal functions are used inside of workflows (but not activities). A coroutine will be called multiple times in order to execute to completion.</p><table><thead><tr><th>Normal Function</th><th>Coroutine</th></tr></thead><tbody><tr><td><div class="themedImageWrapper_nM_G"><div class="lightImage_srvP"><a href="https://mermaid.live/edit#pako:eNplkU1vwyAMhv9K5HNaEUIH4bBLq562204LO9DgNJESqChoH1X--0i6al8-2a_fxwb5Ao0zCBLawb02nfYhe9opm6U4x8PR61OXPdB6H20Temdfrq059oWuPYbobyJao-xftKi3ehjQ_wC3CWyS-Es61An_Pyh5s9Xqfl52FfZfQiKUhRyOvjcgg4-Yw4h-1HMJl9msIHQ4ogKZUoOtjkNQoOyUsJO2z86NN9K7eOxAtno4pyqejA6463X6w7clvQr91kUbQBblMgLkBd5AUlKsBeGkEISSigqWwzvIkpG12PDNpqyIYFSUUw4fy06yZpwKzitWMX5HGSU8BzR9cP7xeozlJtMnm-Z59g" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNplkU1vwyAMhv9K5HNaEUIH4bBLq562204LO9DgNJESqChoH1X--0i6al8-2a_fxwb5Ao0zCBLawb02nfYhe9opm6U4x8PR61OXPdB6H20Temdfrq059oWuPYbobyJao-xftKi3ehjQ_wC3CWyS-Es61An_Pyh5s9Xqfl52FfZfQiKUhRyOvjcgg4-Yw4h-1HMJl9msIHQ4ogKZUoOtjkNQoOyUsJO2z86NN9K7eOxAtno4pyqejA6463X6w7clvQr91kUbQBblMgLkBd5AUlKsBeGkEISSigqWwzvIkpG12PDNpqyIYFSUUw4fy06yZpwKzitWMX5HGSU8BzR9cP7xeozlJtMnm-Z59g?type=png" alt="Normal Function Diagram"></a></div><div class="darkImage_qlOL"><a href="https://mermaid.live/edit#pako:eNplkTtvwyAQgP-KdbNjYYIDZuiSKFO7darpQGxiW7UhuoD6sPLfi52m6uMm7uO-O9BNULvGgITj4F7rTqNPHnfKJjHO4dCiPnXJPa32wda-d_b5ejXHPtcVGh_wBo1tlP2r5tVWD4PBH-I2inWEv9Chivr_RrE2Wa3u5mFXsP8C0VAWUmixb0B6DCaF0eCo5xSmuViB78xoFMh4bDS-KFD2Ep2Ttk_OjTcNXWg7kEc9nGMWTo32Ztfr-IHxm2J8k8GtC9aD5BuxNAE5wRtISvJMEE5yQSgpqWApvINcM5KJghfFuiSCUbG-pPCxTCUZ41RwXrKS8Q1llPAUTNN7hw_XXSwruXwC4h15Pw" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNplkTtvwyAQgP-KdbNjYYIDZuiSKFO7darpQGxiW7UhuoD6sPLfi52m6uMm7uO-O9BNULvGgITj4F7rTqNPHnfKJjHO4dCiPnXJPa32wda-d_b5ejXHPtcVGh_wBo1tlP2r5tVWD4PBH-I2inWEv9Chivr_RrE2Wa3u5mFXsP8C0VAWUmixb0B6DCaF0eCo5xSmuViB78xoFMh4bDS-KFD2Ep2Ttk_OjTcNXWg7kEc9nGMWTo32Ztfr-IHxm2J8k8GtC9aD5BuxNAE5wRtISvJMEE5yQSgpqWApvINcM5KJghfFuiSCUbG-pPCxTCUZ41RwXrKS8Q1llPAUTNN7hw_XXSwruXwC4h15Pw?type=png" alt="Normal Function Diagram"></a></div></div></td><td><div class="themedImageWrapper_nM_G"><div class="lightImage_srvP"><a href="https://mermaid.live/edit#pako:eNptkj1vwyAQhv-KdbMTYSAFM3RxtqhL1al2B2JIbMkGC4P6EeW_l9hOm1a5iXuf--BOd4LaKg0CDp19rxvpfPKyrUwSbQz7o5NDkzzjsrDOBt8a_Tazi-2ycgzjoI26FfE9kZRO--DMokVamf9NsrKQXafdTV6BZVlH8Y-0j7XG0Os_Yn1PVKWyPz--6RnLJqvVYxxg9nfZ5MbSV76fOV44Xnh95fXMycLJwmMHSOHoWgXCu6BT6LXr5cWF0yW2At_oXlcg4lPpgwydr6Ay55g2SPNqbX_NjPs-NiAOshujFwYlvd62Mi7rNyTOpF1hg_EgMjKVAHGCDxAYZWuOGMo4wijHnKbwCYJQtOYbttmQHHGKOTmn8DX1RGvKMGcspzllD5hixFLQqvXWPc33MZ3J-RssOJ-L" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNptkj1vwyAQhv-KdbMTYSAFM3RxtqhL1al2B2JIbMkGC4P6EeW_l9hOm1a5iXuf--BOd4LaKg0CDp19rxvpfPKyrUwSbQz7o5NDkzzjsrDOBt8a_Tazi-2ycgzjoI26FfE9kZRO--DMokVamf9NsrKQXafdTV6BZVlH8Y-0j7XG0Os_Yn1PVKWyPz--6RnLJqvVYxxg9nfZ5MbSV76fOV44Xnh95fXMycLJwmMHSOHoWgXCu6BT6LXr5cWF0yW2At_oXlcg4lPpgwydr6Ay55g2SPNqbX_NjPs-NiAOshujFwYlvd62Mi7rNyTOpF1hg_EgMjKVAHGCDxAYZWuOGMo4wijHnKbwCYJQtOYbttmQHHGKOTmn8DX1RGvKMGcspzllD5hixFLQqvXWPc33MZ3J-RssOJ-L?type=png" alt="Coroutine Diagram"></a></div><div class="darkImage_qlOL"><a href="https://mermaid.live/edit#pako:eNptkj1vwyAQhv-KdbMTYUwKZujibFGXqlPtDsQQ26oNFgb1I8p_L7GdKKlyE_c-3HscuiNURirgcOjMV9UI66K3bamjEKPf11YMTfSKi9xY412r1cfMzrFLitGPg9LyVsSPxLSwynmrFy3QUv9vkhS56Dplb-pyLIoqiHfSPniNvld3YvVIlIU01xff9Ay20Wr1HAaY810ypcH6wvczxwvHC68uvJp5uvB04aEDxFDbVgJ31qsYemV7cU7heL5bgmtUr0rg4SiF_Syh1KdQMwj9bkx_KQufXTfAD6IbQ-YHKZzatiL8VH9VbZhI2dx47YDTBE8mwI_wDRyjZM0QRQlDGGWYkRh-gKcErdmGbjZphhjBLD3F8Dt1RWtCMaM0IxmhT5hgRGNQsnXGvszrMW3J6Q9Ifp7J" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNptkj1vwyAQhv-KdbMTYUwKZujibFGXqlPtDsQQ26oNFgb1I8p_L7GdKKlyE_c-3HscuiNURirgcOjMV9UI66K3bamjEKPf11YMTfSKi9xY412r1cfMzrFLitGPg9LyVsSPxLSwynmrFy3QUv9vkhS56Dplb-pyLIoqiHfSPniNvld3YvVIlIU01xff9Ay20Wr1HAaY810ypcH6wvczxwvHC68uvJp5uvB04aEDxFDbVgJ31qsYemV7cU7heL5bgmtUr0rg4SiF_Syh1KdQMwj9bkx_KQufXTfAD6IbQ-YHKZzatiL8VH9VbZhI2dx47YDTBE8mwI_wDRyjZM0QRQlDGGWYkRh-gKcErdmGbjZphhjBLD3F8Dt1RWtCMaM0IxmhT5hgRGNQsnXGvszrMW3J6Q9Ifp7J?type=png" alt="Coroutine Diagram"></a></div></div></td></tr></tbody></table><p>Even though this workflow will execute to completion effectively once, it will still be partially executed four different times. The results of activities are cached so that only failed activities will be called again. Successful activities get skipped.</p><p>But notice that any code we write between these calls will be called multiple times. That’s why your code needs to be <strong>deterministic</strong> inside of workflow methods! If your code has four executions, each at different times, they must still all behave the same. There are no such limitations within activity methods.</p><h1>Step By Step</h1><p>The first time the workflow executes, it will reach the call to <code>SendEmailVerificationEmailActivity</code> , start that activity, and then exit. Workflows suspend execution while an activity is running. After the <code>SendEmailVerificationEmailActivity</code> finishes, it will resume execution of the workflow. This brings us to…</p><p>The second time the workflow is executed, it will reach the call to <code>SendEmailVerificationEmailActivity</code> and skip it because it will already have the result of that activity. Then it will reach the call to <code>await()</code> which allows the workflow to wait for an external signal. In this case, it will come from the user clicking on the verification link they receive in their email. Once the workflow is signaled then it will execute for…</p><p>The third time, both the calls to <code>SendEmailVerificationEmailActivity</code> and <code>await()</code> are skipped. This means that the <code>VerifyEmailActivity</code> will be started. After the final activity has executed we still have…</p><p>The final time the workflow is called, there is nothing left to do so the workflow completes.</p><p>Now let’s take a look at the activities.</p><p>The first activity just sends the user an email.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\VerifyEmail;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Mail\VerifyEmail;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\Mail;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class SendEmailVerificationEmailActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($email)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Mail::to($email)-&gt;send(new VerifyEmail($this-&gt;workflowId()));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The email contains a temporary signed URL that includes the workflow ID.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Mail;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Bus\Queueable;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Mail\Mailable;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Mail\Mailables\Content;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Mail\Mailables\Envelope;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Queue\SerializesModels;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Illuminate\Support\Facades\URL;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class VerifyEmail extends Mailable</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    use Queueable, SerializesModels;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    private $workflowId;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function __construct($workflowId)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $this-&gt;workflowId = $workflowId;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function envelope()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return new Envelope(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            subject: 'Verify Email',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function content()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return new Content(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            view: 'emails.verify-email',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            with: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                'url' =&gt; URL::temporarySignedRoute(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    'verify-email',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    now()-&gt;addMinutes(30),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    ['workflow_id' =&gt; $this-&gt;workflowId],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                ),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function attachments()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return [];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The user gets the URL in a clickable link.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;a href="{{ $url }}"&gt;verification link&lt;/a&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This link takes the user to the <code>verify-email</code> route from our API routes, which will then start the final activity.</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">namespace App\Workflows\VerifyEmail;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use App\Models\User;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use Workflow\Activity;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">class VerifyEmailActivity extends Activity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    public function execute($email, $password)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $user = new User();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $user-&gt;name = '';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $user-&gt;email = $email;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $user-&gt;email_verified_at = now();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $user-&gt;password = $password;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        $user-&gt;save();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We have created the user and verified their email address at the same time. Neat!</p><h1>Wrapping Up</h1><p>If we take a look at the output of <code>php artisan queue:work</code> we can better see how the workflow and individual activities are interleaved.</p><p><img loading="lazy" src="https://miro.medium.com/max/1400/1*q6-r41SN-uWfzp6p7Z4r8g.webp" alt="queue worker" class="img_ev3q"></p><p>We can see the four different executions of the workflow, the individual activities and the signal we sent.</p><p>The <a href="https://github.com/laravel-workflow/laravel-workflow" target="_blank" rel="noopener noreferrer">Laravel Workflow</a> library is heavily inspired by <a href="https://temporal.io/" target="_blank" rel="noopener noreferrer">Temporal</a> but powered by <a href="https://laravel.com/docs/9.x/queues" target="_blank" rel="noopener noreferrer">Laravel Queues</a>.</p><p>Thanks for reading!</p>]]></content:encoded>
            <category>emails</category>
            <category>verification</category>
            <category>signed-urls</category>
        </item>
    </channel>
</rss>